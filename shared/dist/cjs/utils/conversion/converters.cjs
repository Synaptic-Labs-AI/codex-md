"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("./errors.cjs");const r={pdf:{name:"PDF Document",extensions:[".pdf"],mimeTypes:["application/pdf"],maxSize:104857600},docx:{name:"Word Document",extensions:[".docx",".doc"],mimeTypes:["application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/msword"],maxSize:52428800},pptx:{name:"PowerPoint Presentation",extensions:[".pptx",".ppt"],mimeTypes:["application/vnd.openxmlformats-officedocument.presentationml.presentation","application/vnd.ms-powerpoint"],maxSize:52428800},xlsx:{name:"Excel Spreadsheet",extensions:[".xlsx",".xls"],mimeTypes:["application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","application/vnd.ms-excel"],maxSize:52428800},csv:{name:"CSV Spreadsheet",extensions:[".csv"],mimeTypes:["text/csv","application/csv","text/comma-separated-values","application/vnd.ms-excel"],maxSize:52428800},url:{name:"Web Page",extensions:[".url",".html",".htm"],mimeTypes:["text/html","application/x-url"],maxSize:10485760},parenturl:{name:"Website",extensions:[".url",".html",".htm"],mimeTypes:["text/html","application/x-url"],maxSize:10485760},mp3:{name:"MP3 Audio",extensions:[".mp3"],mimeTypes:["audio/mpeg"],maxSize:524288e3},wav:{name:"WAV Audio",extensions:[".wav"],mimeTypes:["audio/wav","audio/x-wav"],maxSize:524288e3},mp4:{name:"MP4 Video",extensions:[".mp4"],mimeTypes:["video/mp4"],maxSize:1073741824},webm:{name:"WebM Video",extensions:[".webm"],mimeTypes:["video/webm"],maxSize:1073741824}};function n(e){try{if(["url","parenturl"].includes(e.toLowerCase()))return{type:e.toLowerCase(),config:r[e.toLowerCase()]};const n=e.startsWith(".")?e.toLowerCase():`.${e.toLowerCase()}`,[o,t]=Object.entries(r).find((([e,r])=>r?.extensions?.includes(n)))||[];return t?{type:o,config:t}:(console.warn(`No converter found for extension: ${e}`),null)}catch(r){return console.error(`Error in getConverterByExtension for ${e}:`,r),null}}function o(e){try{const n=e.toLowerCase(),[o,t]=Object.entries(r).find((([e,r])=>r.mimeTypes.includes(n)))||[];return t?{type:o,config:t}:(console.warn(`No converter found for MIME type: ${e}`),null)}catch(r){return console.error(`Error in getConverterByMimeType for ${e}:`,r),null}}function t(){return Object.values(r).flatMap((e=>e.extensions))}function i(){return Object.values(r).flatMap((e=>e.mimeTypes))}function s(e,r){if(!r||Buffer.isBuffer(r)&&0===r.length||"string"==typeof r&&""===r.trim())return!1;switch(e.toLowerCase()){case"url":case"parenturl":return"string"==typeof r&&r.length>0;case"pdf":return!!Buffer.isBuffer(r)&&(r.length>4&&"%PDF"===r.toString("ascii",0,4));case"docx":case"xlsx":case"pptx":case"mp3":case"wav":case"mp4":case"webm":return Buffer.isBuffer(r)&&r.length>0;case"csv":return(Buffer.isBuffer(r)||"string"==typeof r)&&r.length>0;default:return!0}}const a={convert:async(r,n,o,t={})=>{throw new e.ConversionError("Convert method not implemented",e.ERROR_TYPES.CONVERSION_ERROR)},validate:e=>!1,config:{name:"Base Converter",extensions:[],mimeTypes:[],maxSize:0}},c={};async function p(r,n,o={}){const t=r.toLowerCase().replace(/^\./,"");if(!s(t,n))throw new e.ConversionError(`Invalid content for ${t} conversion`,e.ERROR_TYPES.INVALID_FILE_TYPE,{type:t});const i=c[t];if(!i)throw new e.ConversionError(`No converter registered for type: ${t}`,e.ERROR_TYPES.CONVERSION_ERROR,{type:t});try{if(["mp3","wav","ogg","flac"].includes(t)&&"function"==typeof i){const e=new i;return await e.convertToMarkdown(n,{name:o.name,apiKey:o.apiKey,onProgress:o.onProgress})}if(["mp4","webm","avi","mov"].includes(t)&&"function"==typeof i){const e=new i;return await e.convertToMarkdown(n,{name:o.name,apiKey:o.apiKey,onProgress:o.onProgress})}if("url"===t||"parenturl"===t){if(i.convertToMarkdown)return await i.convertToMarkdown(n,o);if(i.convert)return await i.convert(n,o)}if("pdf"===t&&(console.log("ðŸ”„ [convertToMarkdown] Converting PDF with options:",{useOcr:o.useOcr,hasMistralApiKey:!!o.mistralApiKey}),i.convertPdfToMarkdown)){const e={useOcr:!0===o.useOcr,mistralApiKey:o.mistralApiKey,preservePageInfo:!0};return console.log(`PDF conversion using OCR: ${e.useOcr}, API key available: ${!!e.mistralApiKey}`),await i.convertPdfToMarkdown(n,o.name,e)}if(["csv","xlsx"].includes(t)){if(console.log(`ðŸ”„ [convertToMarkdown] Converting data file (${t}) with options:`,{name:o.name,contentType:"string"==typeof n?"string":Buffer.isBuffer(n)?"buffer":typeof n}),i.convertToMarkdown)return await i.convertToMarkdown(n,o.name,o.apiKey);if(i.convert)return await i.convert(n,o.name,o.apiKey,o)}if(i.convert)return await i.convert(n,o.name,o.apiKey,o);if(i.convertToMarkdown)return await i.convertToMarkdown(n,o);const r=c.textFactory;if(r&&r.convertToMarkdown)return await r.convertToMarkdown(t,n,{name:o.name,apiKey:o.apiKey,mimeType:o.mimeType,...o});throw new e.ConversionError(`Converter for ${t} does not implement required methods`,e.ERROR_TYPES.CONVERSION_ERROR,{type:t})}catch(r){if(r instanceof e.ConversionError)throw r;throw new e.ConversionError(`Conversion failed: ${r.message}`,e.ERROR_TYPES.CONVERSION_ERROR,{originalError:r.message,type:t})}}var m={FILE_CONVERTERS:r,getConverterByExtension:n,getConverterByMimeType:o,getSupportedExtensions:t,getSupportedMimeTypes:i,validateContent:s,convertToMarkdown:p};exports.ConverterInterface=a,exports.FILE_CONVERTERS=r,exports.backendConverters=c,exports.convertToMarkdown=p,exports.default=m,exports.getConverterByExtension=n,exports.getConverterByMimeType=o,exports.getSupportedExtensions=t,exports.getSupportedMimeTypes=i,exports.registerConverter=function(e,r){if(!e||"string"!=typeof e)throw new Error("Converter type must be a string");if(!r)throw new Error("Converter cannot be null or undefined");return c[e]=r,console.log(`âœ… Registered converter for ${e}`),!0},exports.registerConverterFactory=function(e,r){if(!e||"string"!=typeof e)throw new Error("Factory name must be a string");if(!r)throw new Error("Factory cannot be null or undefined");return c[e]=r,console.log(`âœ… Registered converter factory: ${e}`),r.converters&&Object.entries(r.converters).forEach((([e,r])=>{c[e]=r,console.log(`âœ… Registered converter from factory: ${e}`)})),!0},exports.validateContent=s;
