"use strict";

/**
 * TranscriptionService.js
 *
 * Provides audio and video transcription services using Deepgram's API.
 * This service acts as a bridge between the Electron main process and
 * the transcription services. It handles file operations, API key
 * management, and transcription requests.
 *
 * Related files:
 * - src/electron/services/ai/DeepgramService.js: Deepgram transcription service
 */

const fs = require('fs');
const path = require('path');
const crypto = require('crypto');
// const { getTranscriptionConfig } = require('./utils/config'); // Not used, can be removed

// Initialize store with error handling using the store factory
const {
  createStore
} = require('../utils/storeFactory');
const store = createStore('transcription-settings');

// Import the Deepgram service
const deepgramService = require('./ai/DeepgramService'); // This is an instance

// Utility to sanitize objects for logging, especially to handle Buffers
// Copied from DeepgramService.js for consistency, or could be moved to a shared util
function sanitizeForLogging(obj, visited = new Set()) {
  if (obj === null || typeof obj !== 'object' || visited.has(obj)) {
    return obj;
  }
  visited.add(obj);
  if (Buffer.isBuffer(obj)) {
    return `[Buffer length: ${obj.length}]`;
  }
  if (Array.isArray(obj)) {
    return obj.map(item => sanitizeForLogging(item, new Set(visited)));
  }
  const sanitized = {};
  for (const [key, value] of Object.entries(obj)) {
    sanitized[key] = sanitizeForLogging(value, new Set(visited));
  }
  visited.delete(obj);
  return sanitized;
}
class TranscriptionService {
  constructor() {
    this.transcriber = deepgramService; // Using the imported instance
    console.log('[TranscriptionService:INIT] TranscriptionService initialized with DeepgramService');
  }

  /**
   * Get the selected transcription model from settings or return default
   * @private
   * @returns {string} The model ID to use
   */
  async _getSelectedModel() {
    let model = 'nova-2'; // Default model
    try {
      const storedModel = store.get('transcription.model');
      const validModels = ['nova-1', 'nova-2', 'nova-3', 'base', 'enhanced']; // Added more generic model names if Deepgram changes them
      if (storedModel && validModels.includes(storedModel)) {
        model = storedModel;
      } else if (storedModel) {
        console.warn(`[TranscriptionService:MODEL_WARN] Invalid model '${storedModel}' in store, using default '${model}'.`);
      }
    } catch (error) {
      console.warn('[TranscriptionService:MODEL_ERROR] Error accessing model from store, using default model:', sanitizeForLogging(error));
    }
    console.log(`[TranscriptionService:MODEL_SELECTED] Using transcription model: ${model}`);
    return model;
  }

  /**
   * Set the transcription model to use
   * @param {string} model The model ID to use
   * @returns {Promise<boolean>} Success status
   */
  async setModel(modelId) {
    try {
      const validModels = ['nova-1', 'nova-2', 'nova-3', 'base', 'enhanced'];
      if (!validModels.includes(modelId)) {
        console.warn(`[TranscriptionService:SET_MODEL_INVALID] Invalid model: ${modelId}`);
        return false;
      }
      store.set('transcription.model', modelId);
      console.log(`[TranscriptionService:SET_MODEL_SUCCESS] Transcription model set to: ${modelId}`);
      return true;
    } catch (error) {
      console.error('[TranscriptionService:SET_MODEL_ERROR] Error setting transcription model:', sanitizeForLogging(error));
      return false;
    }
  }

  /**
   * Transcribe audio file using Deepgram
   * @param {string} audioPath Path to audio file
   * @param {string} apiKey Deepgram API key
   * @returns {Promise<string>} Transcription text
   */
  async transcribeAudio(audioPath, apiKey, options = {}) {
    const operationId = crypto.randomBytes(4).toString('hex');
    console.log(`[TranscriptionService:TRANSCRIBE_AUDIO_START][opId:${operationId}] Starting audio transcription for: ${audioPath}`);
    console.log(`[TranscriptionService:TRANSCRIBE_AUDIO_START][opId:${operationId}] API key provided: ${!!apiKey}`);
    console.log(`[TranscriptionService:TRANSCRIBE_AUDIO_START][opId:${operationId}] Options:`, sanitizeForLogging(options));
    try {
      // Ensure Deepgram is configured, preferably with the provided API key
      if (apiKey) {
        console.log(`[TranscriptionService:CONFIGURING][opId:${operationId}] Configuring Deepgram with provided API key.`);
        await this.transcriber.handleConfigure(null, {
          apiKey
        });
      } else {
        console.log(`[TranscriptionService:CONFIGURING][opId:${operationId}] Ensuring Deepgram is configured (no API key explicitly passed to transcribeAudio).`);
        this.transcriber.ensureConfigured(); // This will use stored key or throw
      }
      const model = await this._getSelectedModel();
      const transcriptionOptions = {
        model: model,
        language: options.language || 'en',
        punctuate: options.punctuate !== undefined ? options.punctuate : true,
        smart_format: options.smart_format !== undefined ? options.smart_format : true,
        diarize: options.diarize || false,
        utterances: options.utterances || false,
        ...options.deepgramOptions // Allow further deepgram specific options
      };
      console.log(`[TranscriptionService:TRANSCRIBE_AUDIO_OPTIONS][opId:${operationId}] Effective Deepgram options:`, sanitizeForLogging(transcriptionOptions));
      const {
        jobId
      } = await this.transcriber.handleTranscribeStart(null, {
        filePath: audioPath,
        options: transcriptionOptions
      });
      console.log(`[TranscriptionService:JOB_STARTED][opId:${operationId}][jobId:${jobId}] Deepgram job started.`);
      let status;
      const maxPollTime = 600 * 1000; // 10 minutes for large files
      const pollInterval = 2000; // 2 seconds
      let elapsedTime = 0;
      do {
        await new Promise(resolve => setTimeout(resolve, pollInterval));
        elapsedTime += pollInterval;
        status = await this.transcriber.handleTranscribeStatus(null, {
          jobId
        });
        console.log(`[TranscriptionService:POLLING_STATUS][opId:${operationId}][jobId:${jobId}] Status: ${status.status}, Progress: ${status.progress || 0}%`);
        if (elapsedTime >= maxPollTime && status.status !== 'completed' && status.status !== 'failed') {
          console.error(`[TranscriptionService:TIMEOUT][opId:${operationId}][jobId:${jobId}] Transcription polling timed out after ${maxPollTime / 1000}s.`);
          throw new Error('Transcription polling timed out.');
        }
      } while (status.status !== 'completed' && status.status !== 'failed');
      if (status.status === 'failed') {
        const errorMessage = status.error || 'Unknown Deepgram transcription failure';
        console.error(`[TranscriptionService:JOB_FAILED][opId:${operationId}][jobId:${jobId}] Transcription failed:`, errorMessage, sanitizeForLogging(status.details));
        throw new Error(`Transcription failed: ${errorMessage}`);
      }
      if (!status.result || typeof status.result.text !== 'string') {
        console.error(`[TranscriptionService:NO_TEXT_RESULT][opId:${operationId}][jobId:${jobId}] Transcription completed but no text result found. Status:`, sanitizeForLogging(status));
        throw new Error('Transcription completed but returned no text.');
      }
      console.log(`[TranscriptionService:JOB_SUCCESS][opId:${operationId}][jobId:${jobId}] Transcription successful. Text length: ${status.result.text.length}`);
      return status.result.text;
    } catch (error) {
      const errorMessage = error.message || 'Unknown error during audio transcription';
      console.error(`[TranscriptionService:TRANSCRIBE_AUDIO_ERROR][opId:${operationId}] Error:`, sanitizeForLogging(error));
      // Do NOT return a placeholder. Let the error propagate.
      throw new Error(`Audio transcription failed: ${errorMessage}`);
    }
  }

  /**
   * Transcribe video file using Deepgram
   * @param {string} videoPath Path to video file
   * @param {string} apiKey Deepgram API key
   * @returns {Promise<string>} Transcription text
   */
  async transcribeVideo(videoPath, apiKey, options = {}) {
    const operationId = crypto.randomBytes(4).toString('hex');
    console.log(`[TranscriptionService:TRANSCRIBE_VIDEO_START][opId:${operationId}] Starting video transcription for: ${videoPath}`);

    // Videos are transcribed like audio by Deepgram, so we can reuse the audio transcription logic.
    // Pass along any video-specific options if needed in the future.
    try {
      return await this.transcribeAudio(videoPath, apiKey, {
        ...options,
        isVideo: true
      });
    } catch (error) {
      const errorMessage = error.message || 'Unknown error during video transcription';
      console.error(`[TranscriptionService:TRANSCRIBE_VIDEO_ERROR][opId:${operationId}] Error:`, sanitizeForLogging(error));
      // Do NOT return a placeholder. Let the error propagate.
      throw new Error(`Video transcription failed: ${errorMessage}`);
    }
  }
}

// Export a single instance (singleton pattern)
const transcriptionServiceInstance = new TranscriptionService();
module.exports = transcriptionServiceInstance;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJmcyIsInJlcXVpcmUiLCJwYXRoIiwiY3J5cHRvIiwiY3JlYXRlU3RvcmUiLCJzdG9yZSIsImRlZXBncmFtU2VydmljZSIsInNhbml0aXplRm9yTG9nZ2luZyIsIm9iaiIsInZpc2l0ZWQiLCJTZXQiLCJoYXMiLCJhZGQiLCJCdWZmZXIiLCJpc0J1ZmZlciIsImxlbmd0aCIsIkFycmF5IiwiaXNBcnJheSIsIm1hcCIsIml0ZW0iLCJzYW5pdGl6ZWQiLCJrZXkiLCJ2YWx1ZSIsIk9iamVjdCIsImVudHJpZXMiLCJkZWxldGUiLCJUcmFuc2NyaXB0aW9uU2VydmljZSIsImNvbnN0cnVjdG9yIiwidHJhbnNjcmliZXIiLCJjb25zb2xlIiwibG9nIiwiX2dldFNlbGVjdGVkTW9kZWwiLCJtb2RlbCIsInN0b3JlZE1vZGVsIiwiZ2V0IiwidmFsaWRNb2RlbHMiLCJpbmNsdWRlcyIsIndhcm4iLCJlcnJvciIsInNldE1vZGVsIiwibW9kZWxJZCIsInNldCIsInRyYW5zY3JpYmVBdWRpbyIsImF1ZGlvUGF0aCIsImFwaUtleSIsIm9wdGlvbnMiLCJvcGVyYXRpb25JZCIsInJhbmRvbUJ5dGVzIiwidG9TdHJpbmciLCJoYW5kbGVDb25maWd1cmUiLCJlbnN1cmVDb25maWd1cmVkIiwidHJhbnNjcmlwdGlvbk9wdGlvbnMiLCJsYW5ndWFnZSIsInB1bmN0dWF0ZSIsInVuZGVmaW5lZCIsInNtYXJ0X2Zvcm1hdCIsImRpYXJpemUiLCJ1dHRlcmFuY2VzIiwiZGVlcGdyYW1PcHRpb25zIiwiam9iSWQiLCJoYW5kbGVUcmFuc2NyaWJlU3RhcnQiLCJmaWxlUGF0aCIsInN0YXR1cyIsIm1heFBvbGxUaW1lIiwicG9sbEludGVydmFsIiwiZWxhcHNlZFRpbWUiLCJQcm9taXNlIiwicmVzb2x2ZSIsInNldFRpbWVvdXQiLCJoYW5kbGVUcmFuc2NyaWJlU3RhdHVzIiwicHJvZ3Jlc3MiLCJFcnJvciIsImVycm9yTWVzc2FnZSIsImRldGFpbHMiLCJyZXN1bHQiLCJ0ZXh0IiwibWVzc2FnZSIsInRyYW5zY3JpYmVWaWRlbyIsInZpZGVvUGF0aCIsImlzVmlkZW8iLCJ0cmFuc2NyaXB0aW9uU2VydmljZUluc3RhbmNlIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9lbGVjdHJvbi9zZXJ2aWNlcy9UcmFuc2NyaXB0aW9uU2VydmljZS5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcclxuICogVHJhbnNjcmlwdGlvblNlcnZpY2UuanNcclxuICpcclxuICogUHJvdmlkZXMgYXVkaW8gYW5kIHZpZGVvIHRyYW5zY3JpcHRpb24gc2VydmljZXMgdXNpbmcgRGVlcGdyYW0ncyBBUEkuXHJcbiAqIFRoaXMgc2VydmljZSBhY3RzIGFzIGEgYnJpZGdlIGJldHdlZW4gdGhlIEVsZWN0cm9uIG1haW4gcHJvY2VzcyBhbmRcclxuICogdGhlIHRyYW5zY3JpcHRpb24gc2VydmljZXMuIEl0IGhhbmRsZXMgZmlsZSBvcGVyYXRpb25zLCBBUEkga2V5XHJcbiAqIG1hbmFnZW1lbnQsIGFuZCB0cmFuc2NyaXB0aW9uIHJlcXVlc3RzLlxyXG4gKlxyXG4gKiBSZWxhdGVkIGZpbGVzOlxyXG4gKiAtIHNyYy9lbGVjdHJvbi9zZXJ2aWNlcy9haS9EZWVwZ3JhbVNlcnZpY2UuanM6IERlZXBncmFtIHRyYW5zY3JpcHRpb24gc2VydmljZVxyXG4gKi9cclxuXHJcbmNvbnN0IGZzID0gcmVxdWlyZSgnZnMnKTtcclxuY29uc3QgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKTtcclxuY29uc3QgY3J5cHRvID0gcmVxdWlyZSgnY3J5cHRvJyk7XHJcbi8vIGNvbnN0IHsgZ2V0VHJhbnNjcmlwdGlvbkNvbmZpZyB9ID0gcmVxdWlyZSgnLi91dGlscy9jb25maWcnKTsgLy8gTm90IHVzZWQsIGNhbiBiZSByZW1vdmVkXHJcblxyXG4vLyBJbml0aWFsaXplIHN0b3JlIHdpdGggZXJyb3IgaGFuZGxpbmcgdXNpbmcgdGhlIHN0b3JlIGZhY3RvcnlcclxuY29uc3QgeyBjcmVhdGVTdG9yZSB9ID0gcmVxdWlyZSgnLi4vdXRpbHMvc3RvcmVGYWN0b3J5Jyk7XHJcbmNvbnN0IHN0b3JlID0gY3JlYXRlU3RvcmUoJ3RyYW5zY3JpcHRpb24tc2V0dGluZ3MnKTtcclxuXHJcbi8vIEltcG9ydCB0aGUgRGVlcGdyYW0gc2VydmljZVxyXG5jb25zdCBkZWVwZ3JhbVNlcnZpY2UgPSByZXF1aXJlKCcuL2FpL0RlZXBncmFtU2VydmljZScpOyAvLyBUaGlzIGlzIGFuIGluc3RhbmNlXHJcblxyXG4vLyBVdGlsaXR5IHRvIHNhbml0aXplIG9iamVjdHMgZm9yIGxvZ2dpbmcsIGVzcGVjaWFsbHkgdG8gaGFuZGxlIEJ1ZmZlcnNcclxuLy8gQ29waWVkIGZyb20gRGVlcGdyYW1TZXJ2aWNlLmpzIGZvciBjb25zaXN0ZW5jeSwgb3IgY291bGQgYmUgbW92ZWQgdG8gYSBzaGFyZWQgdXRpbFxyXG5mdW5jdGlvbiBzYW5pdGl6ZUZvckxvZ2dpbmcob2JqLCB2aXNpdGVkID0gbmV3IFNldCgpKSB7XHJcbiAgaWYgKG9iaiA9PT0gbnVsbCB8fCB0eXBlb2Ygb2JqICE9PSAnb2JqZWN0JyB8fCB2aXNpdGVkLmhhcyhvYmopKSB7XHJcbiAgICByZXR1cm4gb2JqO1xyXG4gIH1cclxuXHJcbiAgdmlzaXRlZC5hZGQob2JqKTtcclxuXHJcbiAgaWYgKEJ1ZmZlci5pc0J1ZmZlcihvYmopKSB7XHJcbiAgICByZXR1cm4gYFtCdWZmZXIgbGVuZ3RoOiAke29iai5sZW5ndGh9XWA7XHJcbiAgfVxyXG5cclxuICBpZiAoQXJyYXkuaXNBcnJheShvYmopKSB7XHJcbiAgICByZXR1cm4gb2JqLm1hcChpdGVtID0+IHNhbml0aXplRm9yTG9nZ2luZyhpdGVtLCBuZXcgU2V0KHZpc2l0ZWQpKSk7XHJcbiAgfVxyXG5cclxuICBjb25zdCBzYW5pdGl6ZWQgPSB7fTtcclxuICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiBPYmplY3QuZW50cmllcyhvYmopKSB7XHJcbiAgICBzYW5pdGl6ZWRba2V5XSA9IHNhbml0aXplRm9yTG9nZ2luZyh2YWx1ZSwgbmV3IFNldCh2aXNpdGVkKSk7XHJcbiAgfVxyXG4gIFxyXG4gIHZpc2l0ZWQuZGVsZXRlKG9iaik7XHJcbiAgcmV0dXJuIHNhbml0aXplZDtcclxufVxyXG5cclxuXHJcbmNsYXNzIFRyYW5zY3JpcHRpb25TZXJ2aWNlIHtcclxuICBjb25zdHJ1Y3RvcigpIHtcclxuICAgIHRoaXMudHJhbnNjcmliZXIgPSBkZWVwZ3JhbVNlcnZpY2U7IC8vIFVzaW5nIHRoZSBpbXBvcnRlZCBpbnN0YW5jZVxyXG4gICAgY29uc29sZS5sb2coJ1tUcmFuc2NyaXB0aW9uU2VydmljZTpJTklUXSBUcmFuc2NyaXB0aW9uU2VydmljZSBpbml0aWFsaXplZCB3aXRoIERlZXBncmFtU2VydmljZScpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogR2V0IHRoZSBzZWxlY3RlZCB0cmFuc2NyaXB0aW9uIG1vZGVsIGZyb20gc2V0dGluZ3Mgb3IgcmV0dXJuIGRlZmF1bHRcclxuICAgKiBAcHJpdmF0ZVxyXG4gICAqIEByZXR1cm5zIHtzdHJpbmd9IFRoZSBtb2RlbCBJRCB0byB1c2VcclxuICAgKi9cclxuICBhc3luYyBfZ2V0U2VsZWN0ZWRNb2RlbCgpIHtcclxuICAgIGxldCBtb2RlbCA9ICdub3ZhLTInOyAvLyBEZWZhdWx0IG1vZGVsXHJcbiAgICB0cnkge1xyXG4gICAgICBjb25zdCBzdG9yZWRNb2RlbCA9IHN0b3JlLmdldCgndHJhbnNjcmlwdGlvbi5tb2RlbCcpO1xyXG4gICAgICBjb25zdCB2YWxpZE1vZGVscyA9IFsnbm92YS0xJywgJ25vdmEtMicsICdub3ZhLTMnLCAnYmFzZScsICdlbmhhbmNlZCddOyAvLyBBZGRlZCBtb3JlIGdlbmVyaWMgbW9kZWwgbmFtZXMgaWYgRGVlcGdyYW0gY2hhbmdlcyB0aGVtXHJcbiAgICAgIGlmIChzdG9yZWRNb2RlbCAmJiB2YWxpZE1vZGVscy5pbmNsdWRlcyhzdG9yZWRNb2RlbCkpIHtcclxuICAgICAgICBtb2RlbCA9IHN0b3JlZE1vZGVsO1xyXG4gICAgICB9IGVsc2UgaWYgKHN0b3JlZE1vZGVsKSB7XHJcbiAgICAgICAgY29uc29sZS53YXJuKGBbVHJhbnNjcmlwdGlvblNlcnZpY2U6TU9ERUxfV0FSTl0gSW52YWxpZCBtb2RlbCAnJHtzdG9yZWRNb2RlbH0nIGluIHN0b3JlLCB1c2luZyBkZWZhdWx0ICcke21vZGVsfScuYCk7XHJcbiAgICAgIH1cclxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgIGNvbnNvbGUud2FybignW1RyYW5zY3JpcHRpb25TZXJ2aWNlOk1PREVMX0VSUk9SXSBFcnJvciBhY2Nlc3NpbmcgbW9kZWwgZnJvbSBzdG9yZSwgdXNpbmcgZGVmYXVsdCBtb2RlbDonLCBzYW5pdGl6ZUZvckxvZ2dpbmcoZXJyb3IpKTtcclxuICAgIH1cclxuICAgIGNvbnNvbGUubG9nKGBbVHJhbnNjcmlwdGlvblNlcnZpY2U6TU9ERUxfU0VMRUNURURdIFVzaW5nIHRyYW5zY3JpcHRpb24gbW9kZWw6ICR7bW9kZWx9YCk7XHJcbiAgICByZXR1cm4gbW9kZWw7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBTZXQgdGhlIHRyYW5zY3JpcHRpb24gbW9kZWwgdG8gdXNlXHJcbiAgICogQHBhcmFtIHtzdHJpbmd9IG1vZGVsIFRoZSBtb2RlbCBJRCB0byB1c2VcclxuICAgKiBAcmV0dXJucyB7UHJvbWlzZTxib29sZWFuPn0gU3VjY2VzcyBzdGF0dXNcclxuICAgKi9cclxuICBhc3luYyBzZXRNb2RlbChtb2RlbElkKSB7XHJcbiAgICB0cnkge1xyXG4gICAgICBjb25zdCB2YWxpZE1vZGVscyA9IFsnbm92YS0xJywgJ25vdmEtMicsICdub3ZhLTMnLCAnYmFzZScsICdlbmhhbmNlZCddO1xyXG4gICAgICBpZiAoIXZhbGlkTW9kZWxzLmluY2x1ZGVzKG1vZGVsSWQpKSB7XHJcbiAgICAgICAgY29uc29sZS53YXJuKGBbVHJhbnNjcmlwdGlvblNlcnZpY2U6U0VUX01PREVMX0lOVkFMSURdIEludmFsaWQgbW9kZWw6ICR7bW9kZWxJZH1gKTtcclxuICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIHN0b3JlLnNldCgndHJhbnNjcmlwdGlvbi5tb2RlbCcsIG1vZGVsSWQpO1xyXG4gICAgICBjb25zb2xlLmxvZyhgW1RyYW5zY3JpcHRpb25TZXJ2aWNlOlNFVF9NT0RFTF9TVUNDRVNTXSBUcmFuc2NyaXB0aW9uIG1vZGVsIHNldCB0bzogJHttb2RlbElkfWApO1xyXG4gICAgICByZXR1cm4gdHJ1ZTtcclxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ1tUcmFuc2NyaXB0aW9uU2VydmljZTpTRVRfTU9ERUxfRVJST1JdIEVycm9yIHNldHRpbmcgdHJhbnNjcmlwdGlvbiBtb2RlbDonLCBzYW5pdGl6ZUZvckxvZ2dpbmcoZXJyb3IpKTtcclxuICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogVHJhbnNjcmliZSBhdWRpbyBmaWxlIHVzaW5nIERlZXBncmFtXHJcbiAgICogQHBhcmFtIHtzdHJpbmd9IGF1ZGlvUGF0aCBQYXRoIHRvIGF1ZGlvIGZpbGVcclxuICAgKiBAcGFyYW0ge3N0cmluZ30gYXBpS2V5IERlZXBncmFtIEFQSSBrZXlcclxuICAgKiBAcmV0dXJucyB7UHJvbWlzZTxzdHJpbmc+fSBUcmFuc2NyaXB0aW9uIHRleHRcclxuICAgKi9cclxuICBhc3luYyB0cmFuc2NyaWJlQXVkaW8oYXVkaW9QYXRoLCBhcGlLZXksIG9wdGlvbnMgPSB7fSkge1xyXG4gICAgY29uc3Qgb3BlcmF0aW9uSWQgPSBjcnlwdG8ucmFuZG9tQnl0ZXMoNCkudG9TdHJpbmcoJ2hleCcpO1xyXG4gICAgY29uc29sZS5sb2coYFtUcmFuc2NyaXB0aW9uU2VydmljZTpUUkFOU0NSSUJFX0FVRElPX1NUQVJUXVtvcElkOiR7b3BlcmF0aW9uSWR9XSBTdGFydGluZyBhdWRpbyB0cmFuc2NyaXB0aW9uIGZvcjogJHthdWRpb1BhdGh9YCk7XHJcbiAgICBjb25zb2xlLmxvZyhgW1RyYW5zY3JpcHRpb25TZXJ2aWNlOlRSQU5TQ1JJQkVfQVVESU9fU1RBUlRdW29wSWQ6JHtvcGVyYXRpb25JZH1dIEFQSSBrZXkgcHJvdmlkZWQ6ICR7ISFhcGlLZXl9YCk7XHJcbiAgICBjb25zb2xlLmxvZyhgW1RyYW5zY3JpcHRpb25TZXJ2aWNlOlRSQU5TQ1JJQkVfQVVESU9fU1RBUlRdW29wSWQ6JHtvcGVyYXRpb25JZH1dIE9wdGlvbnM6YCwgc2FuaXRpemVGb3JMb2dnaW5nKG9wdGlvbnMpKTtcclxuXHJcbiAgICB0cnkge1xyXG4gICAgICAvLyBFbnN1cmUgRGVlcGdyYW0gaXMgY29uZmlndXJlZCwgcHJlZmVyYWJseSB3aXRoIHRoZSBwcm92aWRlZCBBUEkga2V5XHJcbiAgICAgIGlmIChhcGlLZXkpIHtcclxuICAgICAgICBjb25zb2xlLmxvZyhgW1RyYW5zY3JpcHRpb25TZXJ2aWNlOkNPTkZJR1VSSU5HXVtvcElkOiR7b3BlcmF0aW9uSWR9XSBDb25maWd1cmluZyBEZWVwZ3JhbSB3aXRoIHByb3ZpZGVkIEFQSSBrZXkuYCk7XHJcbiAgICAgICAgYXdhaXQgdGhpcy50cmFuc2NyaWJlci5oYW5kbGVDb25maWd1cmUobnVsbCwgeyBhcGlLZXkgfSk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgY29uc29sZS5sb2coYFtUcmFuc2NyaXB0aW9uU2VydmljZTpDT05GSUdVUklOR11bb3BJZDoke29wZXJhdGlvbklkfV0gRW5zdXJpbmcgRGVlcGdyYW0gaXMgY29uZmlndXJlZCAobm8gQVBJIGtleSBleHBsaWNpdGx5IHBhc3NlZCB0byB0cmFuc2NyaWJlQXVkaW8pLmApO1xyXG4gICAgICAgIHRoaXMudHJhbnNjcmliZXIuZW5zdXJlQ29uZmlndXJlZCgpOyAvLyBUaGlzIHdpbGwgdXNlIHN0b3JlZCBrZXkgb3IgdGhyb3dcclxuICAgICAgfVxyXG5cclxuICAgICAgY29uc3QgbW9kZWwgPSBhd2FpdCB0aGlzLl9nZXRTZWxlY3RlZE1vZGVsKCk7XHJcbiAgICAgIFxyXG4gICAgICBjb25zdCB0cmFuc2NyaXB0aW9uT3B0aW9ucyA9IHtcclxuICAgICAgICBtb2RlbDogbW9kZWwsXHJcbiAgICAgICAgbGFuZ3VhZ2U6IG9wdGlvbnMubGFuZ3VhZ2UgfHwgJ2VuJyxcclxuICAgICAgICBwdW5jdHVhdGU6IG9wdGlvbnMucHVuY3R1YXRlICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLnB1bmN0dWF0ZSA6IHRydWUsXHJcbiAgICAgICAgc21hcnRfZm9ybWF0OiBvcHRpb25zLnNtYXJ0X2Zvcm1hdCAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucy5zbWFydF9mb3JtYXQgOiB0cnVlLFxyXG4gICAgICAgIGRpYXJpemU6IG9wdGlvbnMuZGlhcml6ZSB8fCBmYWxzZSxcclxuICAgICAgICB1dHRlcmFuY2VzOiBvcHRpb25zLnV0dGVyYW5jZXMgfHwgZmFsc2UsXHJcbiAgICAgICAgLi4ub3B0aW9ucy5kZWVwZ3JhbU9wdGlvbnMgLy8gQWxsb3cgZnVydGhlciBkZWVwZ3JhbSBzcGVjaWZpYyBvcHRpb25zXHJcbiAgICAgIH07XHJcbiAgICAgIGNvbnNvbGUubG9nKGBbVHJhbnNjcmlwdGlvblNlcnZpY2U6VFJBTlNDUklCRV9BVURJT19PUFRJT05TXVtvcElkOiR7b3BlcmF0aW9uSWR9XSBFZmZlY3RpdmUgRGVlcGdyYW0gb3B0aW9uczpgLCBzYW5pdGl6ZUZvckxvZ2dpbmcodHJhbnNjcmlwdGlvbk9wdGlvbnMpKTtcclxuXHJcbiAgICAgIGNvbnN0IHsgam9iSWQgfSA9IGF3YWl0IHRoaXMudHJhbnNjcmliZXIuaGFuZGxlVHJhbnNjcmliZVN0YXJ0KG51bGwsIHtcclxuICAgICAgICBmaWxlUGF0aDogYXVkaW9QYXRoLFxyXG4gICAgICAgIG9wdGlvbnM6IHRyYW5zY3JpcHRpb25PcHRpb25zXHJcbiAgICAgIH0pO1xyXG4gICAgICBjb25zb2xlLmxvZyhgW1RyYW5zY3JpcHRpb25TZXJ2aWNlOkpPQl9TVEFSVEVEXVtvcElkOiR7b3BlcmF0aW9uSWR9XVtqb2JJZDoke2pvYklkfV0gRGVlcGdyYW0gam9iIHN0YXJ0ZWQuYCk7XHJcblxyXG4gICAgICBsZXQgc3RhdHVzO1xyXG4gICAgICBjb25zdCBtYXhQb2xsVGltZSA9IDYwMCAqIDEwMDA7IC8vIDEwIG1pbnV0ZXMgZm9yIGxhcmdlIGZpbGVzXHJcbiAgICAgIGNvbnN0IHBvbGxJbnRlcnZhbCA9IDIwMDA7IC8vIDIgc2Vjb25kc1xyXG4gICAgICBsZXQgZWxhcHNlZFRpbWUgPSAwO1xyXG5cclxuICAgICAgZG8ge1xyXG4gICAgICAgIGF3YWl0IG5ldyBQcm9taXNlKHJlc29sdmUgPT4gc2V0VGltZW91dChyZXNvbHZlLCBwb2xsSW50ZXJ2YWwpKTtcclxuICAgICAgICBlbGFwc2VkVGltZSArPSBwb2xsSW50ZXJ2YWw7XHJcbiAgICAgICAgc3RhdHVzID0gYXdhaXQgdGhpcy50cmFuc2NyaWJlci5oYW5kbGVUcmFuc2NyaWJlU3RhdHVzKG51bGwsIHsgam9iSWQgfSk7XHJcbiAgICAgICAgY29uc29sZS5sb2coYFtUcmFuc2NyaXB0aW9uU2VydmljZTpQT0xMSU5HX1NUQVRVU11bb3BJZDoke29wZXJhdGlvbklkfV1bam9iSWQ6JHtqb2JJZH1dIFN0YXR1czogJHtzdGF0dXMuc3RhdHVzfSwgUHJvZ3Jlc3M6ICR7c3RhdHVzLnByb2dyZXNzIHx8IDB9JWApO1xyXG5cclxuICAgICAgICBpZiAoZWxhcHNlZFRpbWUgPj0gbWF4UG9sbFRpbWUgJiYgc3RhdHVzLnN0YXR1cyAhPT0gJ2NvbXBsZXRlZCcgJiYgc3RhdHVzLnN0YXR1cyAhPT0gJ2ZhaWxlZCcpIHtcclxuICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYFtUcmFuc2NyaXB0aW9uU2VydmljZTpUSU1FT1VUXVtvcElkOiR7b3BlcmF0aW9uSWR9XVtqb2JJZDoke2pvYklkfV0gVHJhbnNjcmlwdGlvbiBwb2xsaW5nIHRpbWVkIG91dCBhZnRlciAke21heFBvbGxUaW1lIC8gMTAwMH1zLmApO1xyXG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdUcmFuc2NyaXB0aW9uIHBvbGxpbmcgdGltZWQgb3V0LicpO1xyXG4gICAgICAgIH1cclxuICAgICAgfSB3aGlsZSAoc3RhdHVzLnN0YXR1cyAhPT0gJ2NvbXBsZXRlZCcgJiYgc3RhdHVzLnN0YXR1cyAhPT0gJ2ZhaWxlZCcpO1xyXG5cclxuICAgICAgaWYgKHN0YXR1cy5zdGF0dXMgPT09ICdmYWlsZWQnKSB7XHJcbiAgICAgICAgY29uc3QgZXJyb3JNZXNzYWdlID0gc3RhdHVzLmVycm9yIHx8ICdVbmtub3duIERlZXBncmFtIHRyYW5zY3JpcHRpb24gZmFpbHVyZSc7XHJcbiAgICAgICAgY29uc29sZS5lcnJvcihgW1RyYW5zY3JpcHRpb25TZXJ2aWNlOkpPQl9GQUlMRURdW29wSWQ6JHtvcGVyYXRpb25JZH1dW2pvYklkOiR7am9iSWR9XSBUcmFuc2NyaXB0aW9uIGZhaWxlZDpgLCBlcnJvck1lc3NhZ2UsIHNhbml0aXplRm9yTG9nZ2luZyhzdGF0dXMuZGV0YWlscykpO1xyXG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgVHJhbnNjcmlwdGlvbiBmYWlsZWQ6ICR7ZXJyb3JNZXNzYWdlfWApO1xyXG4gICAgICB9XHJcblxyXG4gICAgICBpZiAoIXN0YXR1cy5yZXN1bHQgfHwgdHlwZW9mIHN0YXR1cy5yZXN1bHQudGV4dCAhPT0gJ3N0cmluZycpIHtcclxuICAgICAgICBjb25zb2xlLmVycm9yKGBbVHJhbnNjcmlwdGlvblNlcnZpY2U6Tk9fVEVYVF9SRVNVTFRdW29wSWQ6JHtvcGVyYXRpb25JZH1dW2pvYklkOiR7am9iSWR9XSBUcmFuc2NyaXB0aW9uIGNvbXBsZXRlZCBidXQgbm8gdGV4dCByZXN1bHQgZm91bmQuIFN0YXR1czpgLCBzYW5pdGl6ZUZvckxvZ2dpbmcoc3RhdHVzKSk7XHJcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdUcmFuc2NyaXB0aW9uIGNvbXBsZXRlZCBidXQgcmV0dXJuZWQgbm8gdGV4dC4nKTtcclxuICAgICAgfVxyXG4gICAgICBcclxuICAgICAgY29uc29sZS5sb2coYFtUcmFuc2NyaXB0aW9uU2VydmljZTpKT0JfU1VDQ0VTU11bb3BJZDoke29wZXJhdGlvbklkfV1bam9iSWQ6JHtqb2JJZH1dIFRyYW5zY3JpcHRpb24gc3VjY2Vzc2Z1bC4gVGV4dCBsZW5ndGg6ICR7c3RhdHVzLnJlc3VsdC50ZXh0Lmxlbmd0aH1gKTtcclxuICAgICAgcmV0dXJuIHN0YXR1cy5yZXN1bHQudGV4dDtcclxuXHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICBjb25zdCBlcnJvck1lc3NhZ2UgPSBlcnJvci5tZXNzYWdlIHx8ICdVbmtub3duIGVycm9yIGR1cmluZyBhdWRpbyB0cmFuc2NyaXB0aW9uJztcclxuICAgICAgY29uc29sZS5lcnJvcihgW1RyYW5zY3JpcHRpb25TZXJ2aWNlOlRSQU5TQ1JJQkVfQVVESU9fRVJST1JdW29wSWQ6JHtvcGVyYXRpb25JZH1dIEVycm9yOmAsIHNhbml0aXplRm9yTG9nZ2luZyhlcnJvcikpO1xyXG4gICAgICAvLyBEbyBOT1QgcmV0dXJuIGEgcGxhY2Vob2xkZXIuIExldCB0aGUgZXJyb3IgcHJvcGFnYXRlLlxyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYEF1ZGlvIHRyYW5zY3JpcHRpb24gZmFpbGVkOiAke2Vycm9yTWVzc2FnZX1gKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFRyYW5zY3JpYmUgdmlkZW8gZmlsZSB1c2luZyBEZWVwZ3JhbVxyXG4gICAqIEBwYXJhbSB7c3RyaW5nfSB2aWRlb1BhdGggUGF0aCB0byB2aWRlbyBmaWxlXHJcbiAgICogQHBhcmFtIHtzdHJpbmd9IGFwaUtleSBEZWVwZ3JhbSBBUEkga2V5XHJcbiAgICogQHJldHVybnMge1Byb21pc2U8c3RyaW5nPn0gVHJhbnNjcmlwdGlvbiB0ZXh0XHJcbiAgICovXHJcbiAgYXN5bmMgdHJhbnNjcmliZVZpZGVvKHZpZGVvUGF0aCwgYXBpS2V5LCBvcHRpb25zID0ge30pIHtcclxuICAgIGNvbnN0IG9wZXJhdGlvbklkID0gY3J5cHRvLnJhbmRvbUJ5dGVzKDQpLnRvU3RyaW5nKCdoZXgnKTtcclxuICAgIGNvbnNvbGUubG9nKGBbVHJhbnNjcmlwdGlvblNlcnZpY2U6VFJBTlNDUklCRV9WSURFT19TVEFSVF1bb3BJZDoke29wZXJhdGlvbklkfV0gU3RhcnRpbmcgdmlkZW8gdHJhbnNjcmlwdGlvbiBmb3I6ICR7dmlkZW9QYXRofWApO1xyXG4gICAgXHJcbiAgICAvLyBWaWRlb3MgYXJlIHRyYW5zY3JpYmVkIGxpa2UgYXVkaW8gYnkgRGVlcGdyYW0sIHNvIHdlIGNhbiByZXVzZSB0aGUgYXVkaW8gdHJhbnNjcmlwdGlvbiBsb2dpYy5cclxuICAgIC8vIFBhc3MgYWxvbmcgYW55IHZpZGVvLXNwZWNpZmljIG9wdGlvbnMgaWYgbmVlZGVkIGluIHRoZSBmdXR1cmUuXHJcbiAgICB0cnkge1xyXG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy50cmFuc2NyaWJlQXVkaW8odmlkZW9QYXRoLCBhcGlLZXksIHsgLi4ub3B0aW9ucywgaXNWaWRlbzogdHJ1ZSB9KTtcclxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgIGNvbnN0IGVycm9yTWVzc2FnZSA9IGVycm9yLm1lc3NhZ2UgfHwgJ1Vua25vd24gZXJyb3IgZHVyaW5nIHZpZGVvIHRyYW5zY3JpcHRpb24nO1xyXG4gICAgICBjb25zb2xlLmVycm9yKGBbVHJhbnNjcmlwdGlvblNlcnZpY2U6VFJBTlNDUklCRV9WSURFT19FUlJPUl1bb3BJZDoke29wZXJhdGlvbklkfV0gRXJyb3I6YCwgc2FuaXRpemVGb3JMb2dnaW5nKGVycm9yKSk7XHJcbiAgICAgIC8vIERvIE5PVCByZXR1cm4gYSBwbGFjZWhvbGRlci4gTGV0IHRoZSBlcnJvciBwcm9wYWdhdGUuXHJcbiAgICAgIHRocm93IG5ldyBFcnJvcihgVmlkZW8gdHJhbnNjcmlwdGlvbiBmYWlsZWQ6ICR7ZXJyb3JNZXNzYWdlfWApO1xyXG4gICAgfVxyXG4gIH1cclxufVxyXG5cclxuLy8gRXhwb3J0IGEgc2luZ2xlIGluc3RhbmNlIChzaW5nbGV0b24gcGF0dGVybilcclxuY29uc3QgdHJhbnNjcmlwdGlvblNlcnZpY2VJbnN0YW5jZSA9IG5ldyBUcmFuc2NyaXB0aW9uU2VydmljZSgpO1xyXG5tb2R1bGUuZXhwb3J0cyA9IHRyYW5zY3JpcHRpb25TZXJ2aWNlSW5zdGFuY2U7XHJcbiJdLCJtYXBwaW5ncyI6Ijs7QUFBQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBLE1BQU1BLEVBQUUsR0FBR0MsT0FBTyxDQUFDLElBQUksQ0FBQztBQUN4QixNQUFNQyxJQUFJLEdBQUdELE9BQU8sQ0FBQyxNQUFNLENBQUM7QUFDNUIsTUFBTUUsTUFBTSxHQUFHRixPQUFPLENBQUMsUUFBUSxDQUFDO0FBQ2hDOztBQUVBO0FBQ0EsTUFBTTtFQUFFRztBQUFZLENBQUMsR0FBR0gsT0FBTyxDQUFDLHVCQUF1QixDQUFDO0FBQ3hELE1BQU1JLEtBQUssR0FBR0QsV0FBVyxDQUFDLHdCQUF3QixDQUFDOztBQUVuRDtBQUNBLE1BQU1FLGVBQWUsR0FBR0wsT0FBTyxDQUFDLHNCQUFzQixDQUFDLENBQUMsQ0FBQzs7QUFFekQ7QUFDQTtBQUNBLFNBQVNNLGtCQUFrQkEsQ0FBQ0MsR0FBRyxFQUFFQyxPQUFPLEdBQUcsSUFBSUMsR0FBRyxDQUFDLENBQUMsRUFBRTtFQUNwRCxJQUFJRixHQUFHLEtBQUssSUFBSSxJQUFJLE9BQU9BLEdBQUcsS0FBSyxRQUFRLElBQUlDLE9BQU8sQ0FBQ0UsR0FBRyxDQUFDSCxHQUFHLENBQUMsRUFBRTtJQUMvRCxPQUFPQSxHQUFHO0VBQ1o7RUFFQUMsT0FBTyxDQUFDRyxHQUFHLENBQUNKLEdBQUcsQ0FBQztFQUVoQixJQUFJSyxNQUFNLENBQUNDLFFBQVEsQ0FBQ04sR0FBRyxDQUFDLEVBQUU7SUFDeEIsT0FBTyxtQkFBbUJBLEdBQUcsQ0FBQ08sTUFBTSxHQUFHO0VBQ3pDO0VBRUEsSUFBSUMsS0FBSyxDQUFDQyxPQUFPLENBQUNULEdB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