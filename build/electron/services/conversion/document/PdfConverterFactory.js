"use strict";

/**
 * PdfConverterFactory.js
 * Factory for creating appropriate PDF converters based on file and options.
 * 
 * This factory:
 * - Analyzes PDF files to determine the best conversion approach
 * - Creates instances of appropriate PDF converters
 * - Provides a unified interface for PDF conversion
 * - Handles fallback between different conversion methods
 * 
 * Related Files:
 * - BasePdfConverter.js: Base class for PDF converters
 * - StandardPdfConverter.js: Text-based PDF converter
 * - MistralPdfConverter.js: OCR-based PDF converter
 * - ConversionService.js: Uses this factory for PDF conversion
 */

const path = require('path');
const fs = require('fs-extra');
const StandardPdfConverter = require('./StandardPdfConverter');
const MistralPdfConverter = require('./MistralPdfConverter');
class PdfConverterFactory {
  constructor(fileProcessor, fileStorage, openAIProxy) {
    this.fileProcessor = fileProcessor;
    this.fileStorage = fileStorage;
    this.openAIProxy = openAIProxy;
    this.supportedExtensions = ['.pdf'];

    // Create converter instances - pass true for skipHandlerSetup
    // This prevents duplicate IPC handler registration when used through the factory
    this.standardConverter = new StandardPdfConverter(fileProcessor, fileStorage, true);
    this.mistralConverter = new MistralPdfConverter(fileProcessor, fileStorage, openAIProxy, true);
  }

  /**
   * Get appropriate converter for PDF file
   * @param {string} filePath - Path to PDF file
   * @param {Object} options - Conversion options
   * @returns {Object} Appropriate PDF converter with convert method
   */
  async getConverter(filePath, options = {}) {
    console.log('[PdfConverterFactory] Getting converter for PDF file');

    // Create a wrapper object that exposes the convert method
    const createConverterWrapper = converter => {
      return {
        convert: async (content, name, apiKey, options) => {
          console.log(`[PdfConverterFactory] Using ${converter.name} for conversion`);
          return await converter.convertToMarkdown(content, {
            ...options,
            name,
            apiKey
          });
        }
      };
    };
    // Check if OCR is explicitly enabled in options
    console.log('[PdfConverterFactory] Checking if OCR is enabled in options:', options);
    console.log(`[PdfConverterFactory] options.useOcr = ${options.useOcr} (type: ${typeof options.useOcr})`);
    if (options.useOcr) {
      console.log('[PdfConverterFactory] Using OCR converter (enabled in settings)');

      // Check if OCR is available
      const ocrAvailable = await this.isOcrAvailable();
      console.log(`[PdfConverterFactory] OCR available: ${ocrAvailable}`);
      if (!ocrAvailable) {
        console.log('[PdfConverterFactory] OCR not available despite being enabled, using standard converter');
        return createConverterWrapper(this.standardConverter);
      }
      console.log('[PdfConverterFactory] OCR is available, using Mistral converter');
      return createConverterWrapper(this.mistralConverter);
    } else {
      console.log('[PdfConverterFactory] OCR is not enabled in options, checking other conditions');
    }

    // If force option is specified, use the requested converter
    if (options.forceOcr) {
      console.log('[PdfConverterFactory] Using OCR converter (forced)');
      return createConverterWrapper(this.mistralConverter);
    }
    if (options.forceStandard) {
      console.log('[PdfConverterFactory] Using standard converter (forced)');
      return createConverterWrapper(this.standardConverter);
    }

    // Check if OCR is available
    const ocrAvailable = await this.isOcrAvailable();
    if (!ocrAvailable) {
      console.log('[PdfConverterFactory] OCR not available, using standard converter');
      return createConverterWrapper(this.standardConverter);
    }

    // Analyze PDF to determine if OCR is needed
    const needsOcr = await this.analyzeNeedsOcr(filePath);
    if (needsOcr) {
      console.log('[PdfConverterFactory] PDF analysis suggests OCR is needed');
      return createConverterWrapper(this.mistralConverter);
    }
    console.log('[PdfConverterFactory] Using standard converter based on analysis');
    return createConverterWrapper(this.standardConverter);
  }

  /**
   * Check if OCR is available
   * @returns {Promise<boolean>} True if OCR is available
   */
  async isOcrAvailable() {
    try {
      console.log('[PdfConverterFactory] Checking OCR availability');

      // Check if mistralConverter is initialized
      if (!this.mistralConverter) {
        console.error('[PdfConverterFactory] MistralPdfConverter not initialized');
        return false;
      }

      // Check if API key is available
      if (!this.mistralConverter.apiKey) {
        console.log('[PdfConverterFactory] No Mistral API key found in converter');
        return false;
      }
      console.log('[PdfConverterFactory] Calling handleCheckApiKey');
      const result = await this.mistralConverter.handleCheckApiKey();
      console.log('[PdfConverterFactory] OCR availability check result:', result);
      return result.valid;
    } catch (error) {
      console.error('[PdfConverterFactory] Error checking OCR availability:', error);
      return false;
    }
  }

  /**
   * Analyze PDF to determine if OCR is needed
   * @param {string} filePath - Path to PDF file
   * @returns {Promise<boolean>} True if OCR is recommended
   */
  async analyzeNeedsOcr(filePath) {
    try {
      // Extract text using standard converter
      const pdfData = await fs.readFile(filePath);
      const pdfParse = require('pdf-parse');
      const data = await pdfParse(pdfData);

      // Check if text extraction yielded meaningful results
      const textLength = data.text.trim().length;
      const pageCount = data.numpages;

      // Calculate average text per page
      const avgTextPerPage = textLength / pageCount;

      // If very little text was extracted, OCR might be needed
      if (avgTextPerPage < 100) {
        console.log(`[PdfConverterFactory] Low text content detected (${avgTextPerPage.toFixed(2)} chars/page), suggesting OCR`);
        return true;
      }

      // Check for scanned document indicators
      const hasScannedIndicators = this.checkForScannedIndicators(data.text);
      if (hasScannedIndicators) {
        console.log('[PdfConverterFactory] Scanned document indicators detected, suggesting OCR');
        return true;
      }
      return false;
    } catch (error) {
      console.error('[PdfConverterFactory] Error analyzing PDF:', error);
      // If analysis fails, default to standard converter
      return false;
    }
  }

  /**
   * Check for indicators that a document is scanned
   * @param {string} text - Extracted text
   * @returns {boolean} True if scanned indicators are found
   */
  checkForScannedIndicators(text) {
    // Common indicators in scanned documents
    const indicators = ['scanned', 'scan', 'ocr', 'image', 'digitized', 'digitised'];
    const lowerText = text.toLowerCase();
    return indicators.some(indicator => lowerText.includes(indicator));
  }

  /**
   * Convert PDF file to markdown
   * @param {Electron.IpcMainInvokeEvent} event - IPC event
   * @param {Object} request - Conversion request
   * @returns {Promise<Object>} Conversion result
   */
  async convertPdf(event, {
    filePath,
    options = {}
  }) {
    try {
      console.log('[PdfConverterFactory] Converting PDF with options:', {
        useOcr: options.useOcr,
        hasMistralApiKey: !!options.mistralApiKey,
        forceOcr: options.forceOcr,
        forceStandard: options.forceStandard
      });

      // If Mistral API key is provided in options, set it on the converter
      if (options.mistralApiKey && this.mistralConverter) {
        console.log('[PdfConverterFactory] Setting Mistral API key from options');
        this.mistralConverter.apiKey = options.mistralApiKey;
      }
      const converter = await this.getConverter(filePath, options);

      // Log which converter we're using
      console.log(`[PdfConverterFactory] Using converter: ${converter.name}`);

      // Use the appropriate conversion method
      return await converter.handleConvert(event, {
        filePath,
        options
      });
    } catch (error) {
      console.error('[PdfConverterFactory] Conversion failed:', error);
      throw error;
    }
  }

  /**
   * Get PDF metadata
   * @param {Electron.IpcMainInvokeEvent} event - IPC event
   * @param {Object} request - Metadata request
   * @returns {Promise<Object>} PDF metadata
   */
  async getPdfMetadata(event, {
    filePath
  }) {
    try {
      // For metadata, we can always use the standard converter
      return await this.standardConverter.handleGetMetadata(event, {
        filePath
      });
    } catch (error) {
      console.error('[PdfConverterFactory] Failed to get metadata:', error);
      throw error;
    }
  }

  /**
   * Check if this factory supports the given file
   * @param {string} filePath - Path to file
   * @returns {boolean} True if supported
   */
  supportsFile(filePath) {
    const ext = path.extname(filePath).toLowerCase();
    return this.supportedExtensions.includes(ext);
  }

  /**
   * Get factory information
   * @returns {Object} Factory details
   */
  getInfo() {
    return {
      name: 'PDF Converter Factory',
      extensions: this.supportedExtensions,
      description: 'Factory for PDF converters with automatic selection',
      converters: [this.standardConverter.getInfo(), this.mistralConverter.getInfo()],
      options: {
        forceOcr: 'Force use of OCR converter',
        forceStandard: 'Force use of standard converter'
      }
    };
  }
}
module.exports = PdfConverterFactory;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJwYXRoIiwicmVxdWlyZSIsImZzIiwiU3RhbmRhcmRQZGZDb252ZXJ0ZXIiLCJNaXN0cmFsUGRmQ29udmVydGVyIiwiUGRmQ29udmVydGVyRmFjdG9yeSIsImNvbnN0cnVjdG9yIiwiZmlsZVByb2Nlc3NvciIsImZpbGVTdG9yYWdlIiwib3BlbkFJUHJveHkiLCJzdXBwb3J0ZWRFeHRlbnNpb25zIiwic3RhbmRhcmRDb252ZXJ0ZXIiLCJtaXN0cmFsQ29udmVydGVyIiwiZ2V0Q29udmVydGVyIiwiZmlsZVBhdGgiLCJvcHRpb25zIiwiY29uc29sZSIsImxvZyIsImNyZWF0ZUNvbnZlcnRlcldyYXBwZXIiLCJjb252ZXJ0ZXIiLCJjb252ZXJ0IiwiY29udGVudCIsIm5hbWUiLCJhcGlLZXkiLCJjb252ZXJ0VG9NYXJrZG93biIsInVzZU9jciIsIm9jckF2YWlsYWJsZSIsImlzT2NyQXZhaWxhYmxlIiwiZm9yY2VPY3IiLCJmb3JjZVN0YW5kYXJkIiwibmVlZHNPY3IiLCJhbmFseXplTmVlZHNPY3IiLCJlcnJvciIsInJlc3VsdCIsImhhbmRsZUNoZWNrQXBpS2V5IiwidmFsaWQiLCJwZGZEYXRhIiwicmVhZEZpbGUiLCJwZGZQYXJzZSIsImRhdGEiLCJ0ZXh0TGVuZ3RoIiwidGV4dCIsInRyaW0iLCJsZW5ndGgiLCJwYWdlQ291bnQiLCJudW1wYWdlcyIsImF2Z1RleHRQZXJQYWdlIiwidG9GaXhlZCIsImhhc1NjYW5uZWRJbmRpY2F0b3JzIiwiY2hlY2tGb3JTY2FubmVkSW5kaWNhdG9ycyIsImluZGljYXRvcnMiLCJsb3dlclRleHQiLCJ0b0xvd2VyQ2FzZSIsInNvbWUiLCJpbmRpY2F0b3IiLCJpbmNsdWRlcyIsImNvbnZlcnRQZGYiLCJldmVudCIsImhhc01pc3RyYWxBcGlLZXkiLCJtaXN0cmFsQXBpS2V5IiwiaGFuZGxlQ29udmVydCIsImdldFBkZk1ldGFkYXRhIiwiaGFuZGxlR2V0TWV0YWRhdGEiLCJzdXBwb3J0c0ZpbGUiLCJleHQiLCJleHRuYW1lIiwiZ2V0SW5mbyIsImV4dGVuc2lvbnMiLCJkZXNjcmlwdGlvbiIsImNvbnZlcnRlcnMiLCJtb2R1bGUiLCJleHBvcnRzIl0sInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vc3JjL2VsZWN0cm9uL3NlcnZpY2VzL2NvbnZlcnNpb24vZG9jdW1lbnQvUGRmQ29udmVydGVyRmFjdG9yeS5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcclxuICogUGRmQ29udmVydGVyRmFjdG9yeS5qc1xyXG4gKiBGYWN0b3J5IGZvciBjcmVhdGluZyBhcHByb3ByaWF0ZSBQREYgY29udmVydGVycyBiYXNlZCBvbiBmaWxlIGFuZCBvcHRpb25zLlxyXG4gKiBcclxuICogVGhpcyBmYWN0b3J5OlxyXG4gKiAtIEFuYWx5emVzIFBERiBmaWxlcyB0byBkZXRlcm1pbmUgdGhlIGJlc3QgY29udmVyc2lvbiBhcHByb2FjaFxyXG4gKiAtIENyZWF0ZXMgaW5zdGFuY2VzIG9mIGFwcHJvcHJpYXRlIFBERiBjb252ZXJ0ZXJzXHJcbiAqIC0gUHJvdmlkZXMgYSB1bmlmaWVkIGludGVyZmFjZSBmb3IgUERGIGNvbnZlcnNpb25cclxuICogLSBIYW5kbGVzIGZhbGxiYWNrIGJldHdlZW4gZGlmZmVyZW50IGNvbnZlcnNpb24gbWV0aG9kc1xyXG4gKiBcclxuICogUmVsYXRlZCBGaWxlczpcclxuICogLSBCYXNlUGRmQ29udmVydGVyLmpzOiBCYXNlIGNsYXNzIGZvciBQREYgY29udmVydGVyc1xyXG4gKiAtIFN0YW5kYXJkUGRmQ29udmVydGVyLmpzOiBUZXh0LWJhc2VkIFBERiBjb252ZXJ0ZXJcclxuICogLSBNaXN0cmFsUGRmQ29udmVydGVyLmpzOiBPQ1ItYmFzZWQgUERGIGNvbnZlcnRlclxyXG4gKiAtIENvbnZlcnNpb25TZXJ2aWNlLmpzOiBVc2VzIHRoaXMgZmFjdG9yeSBmb3IgUERGIGNvbnZlcnNpb25cclxuICovXHJcblxyXG5jb25zdCBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xyXG5jb25zdCBmcyA9IHJlcXVpcmUoJ2ZzLWV4dHJhJyk7XHJcbmNvbnN0IFN0YW5kYXJkUGRmQ29udmVydGVyID0gcmVxdWlyZSgnLi9TdGFuZGFyZFBkZkNvbnZlcnRlcicpO1xyXG5jb25zdCBNaXN0cmFsUGRmQ29udmVydGVyID0gcmVxdWlyZSgnLi9NaXN0cmFsUGRmQ29udmVydGVyJyk7XHJcblxyXG5jbGFzcyBQZGZDb252ZXJ0ZXJGYWN0b3J5IHtcclxuICAgIGNvbnN0cnVjdG9yKGZpbGVQcm9jZXNzb3IsIGZpbGVTdG9yYWdlLCBvcGVuQUlQcm94eSkge1xyXG4gICAgICAgIHRoaXMuZmlsZVByb2Nlc3NvciA9IGZpbGVQcm9jZXNzb3I7XHJcbiAgICAgICAgdGhpcy5maWxlU3RvcmFnZSA9IGZpbGVTdG9yYWdlO1xyXG4gICAgICAgIHRoaXMub3BlbkFJUHJveHkgPSBvcGVuQUlQcm94eTtcclxuICAgICAgICB0aGlzLnN1cHBvcnRlZEV4dGVuc2lvbnMgPSBbJy5wZGYnXTtcclxuICAgICAgICBcclxuICAgICAgICAvLyBDcmVhdGUgY29udmVydGVyIGluc3RhbmNlcyAtIHBhc3MgdHJ1ZSBmb3Igc2tpcEhhbmRsZXJTZXR1cFxyXG4gICAgICAgIC8vIFRoaXMgcHJldmVudHMgZHVwbGljYXRlIElQQyBoYW5kbGVyIHJlZ2lzdHJhdGlvbiB3aGVuIHVzZWQgdGhyb3VnaCB0aGUgZmFjdG9yeVxyXG4gICAgICAgIHRoaXMuc3RhbmRhcmRDb252ZXJ0ZXIgPSBuZXcgU3RhbmRhcmRQZGZDb252ZXJ0ZXIoZmlsZVByb2Nlc3NvciwgZmlsZVN0b3JhZ2UsIHRydWUpO1xyXG4gICAgICAgIHRoaXMubWlzdHJhbENvbnZlcnRlciA9IG5ldyBNaXN0cmFsUGRmQ29udmVydGVyKGZpbGVQcm9jZXNzb3IsIGZpbGVTdG9yYWdlLCBvcGVuQUlQcm94eSwgdHJ1ZSk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBHZXQgYXBwcm9wcmlhdGUgY29udmVydGVyIGZvciBQREYgZmlsZVxyXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IGZpbGVQYXRoIC0gUGF0aCB0byBQREYgZmlsZVxyXG4gICAgICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMgLSBDb252ZXJzaW9uIG9wdGlvbnNcclxuICAgICAqIEByZXR1cm5zIHtPYmplY3R9IEFwcHJvcHJpYXRlIFBERiBjb252ZXJ0ZXIgd2l0aCBjb252ZXJ0IG1ldGhvZFxyXG4gICAgICovXHJcbiAgICBhc3luYyBnZXRDb252ZXJ0ZXIoZmlsZVBhdGgsIG9wdGlvbnMgPSB7fSkge1xyXG4gICAgICAgIGNvbnNvbGUubG9nKCdbUGRmQ29udmVydGVyRmFjdG9yeV0gR2V0dGluZyBjb252ZXJ0ZXIgZm9yIFBERiBmaWxlJyk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgLy8gQ3JlYXRlIGEgd3JhcHBlciBvYmplY3QgdGhhdCBleHBvc2VzIHRoZSBjb252ZXJ0IG1ldGhvZFxyXG4gICAgICAgIGNvbnN0IGNyZWF0ZUNvbnZlcnRlcldyYXBwZXIgPSAoY29udmVydGVyKSA9PiB7XHJcbiAgICAgICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgICAgICBjb252ZXJ0OiBhc3luYyAoY29udGVudCwgbmFtZSwgYXBpS2V5LCBvcHRpb25zKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFtQZGZDb252ZXJ0ZXJGYWN0b3J5XSBVc2luZyAke2NvbnZlcnRlci5uYW1lfSBmb3IgY29udmVyc2lvbmApO1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBhd2FpdCBjb252ZXJ0ZXIuY29udmVydFRvTWFya2Rvd24oY29udGVudCwge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAuLi5vcHRpb25zLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBuYW1lLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBhcGlLZXlcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfTtcclxuICAgICAgICB9O1xyXG4gICAgICAgIC8vIENoZWNrIGlmIE9DUiBpcyBleHBsaWNpdGx5IGVuYWJsZWQgaW4gb3B0aW9uc1xyXG4gICAgICAgIGNvbnNvbGUubG9nKCdbUGRmQ29udmVydGVyRmFjdG9yeV0gQ2hlY2tpbmcgaWYgT0NSIGlzIGVuYWJsZWQgaW4gb3B0aW9uczonLCBvcHRpb25zKTtcclxuICAgICAgICBjb25zb2xlLmxvZyhgW1BkZkNvbnZlcnRlckZhY3RvcnldIG9wdGlvbnMudXNlT2NyID0gJHtvcHRpb25zLnVzZU9jcn0gKHR5cGU6ICR7dHlwZW9mIG9wdGlvbnMudXNlT2NyfSlgKTtcclxuICAgICAgICBcclxuICAgICAgICBpZiAob3B0aW9ucy51c2VPY3IpIHtcclxuICAgICAgICAgICAgY29uc29sZS5sb2coJ1tQZGZDb252ZXJ0ZXJGYWN0b3J5XSBVc2luZyBPQ1IgY29udmVydGVyIChlbmFibGVkIGluIHNldHRpbmdzKScpO1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgLy8gQ2hlY2sgaWYgT0NSIGlzIGF2YWlsYWJsZVxyXG4gICAgICAgICAgICBjb25zdCBvY3JBdmFpbGFibGUgPSBhd2FpdCB0aGlzLmlzT2NyQXZhaWxhYmxlKCk7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbUGRmQ29udmVydGVyRmFjdG9yeV0gT0NSIGF2YWlsYWJsZTogJHtvY3JBdmFpbGFibGV9YCk7XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICBpZiAoIW9jckF2YWlsYWJsZSkge1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ1tQZGZDb252ZXJ0ZXJGYWN0b3J5XSBPQ1Igbm90IGF2YWlsYWJsZSBkZXNwaXRlIGJlaW5nIGVuYWJsZWQsIHVzaW5nIHN0YW5kYXJkIGNvbnZlcnRlcicpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZUNvbnZlcnRlcldyYXBwZXIodGhpcy5zdGFuZGFyZENvbnZlcnRlcik7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdbUGRmQ29udmVydGVyRmFjdG9yeV0gT0NSIGlzIGF2YWlsYWJsZSwgdXNpbmcgTWlzdHJhbCBjb252ZXJ0ZXInKTtcclxuICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZUNvbnZlcnRlcldyYXBwZXIodGhpcy5taXN0cmFsQ29udmVydGVyKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBjb25zb2xlLmxvZygnW1BkZkNvbnZlcnRlckZhY3RvcnldIE9DUiBpcyBub3QgZW5hYmxlZCBpbiBvcHRpb25zLCBjaGVja2luZyBvdGhlciBjb25kaXRpb25zJyk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIFxyXG4gICAgICAgIC8vIElmIGZvcmNlIG9wdGlvbiBpcyBzcGVjaWZpZWQsIHVzZSB0aGUgcmVxdWVzdGVkIGNvbnZlcnRlclxyXG4gICAgICAgIGlmIChvcHRpb25zLmZvcmNlT2NyKSB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdbUGRmQ29udmVydGVyRmFjdG9yeV0gVXNpbmcgT0NSIGNvbnZlcnRlciAoZm9yY2VkKScpO1xyXG4gICAgICAgICAgICByZXR1cm4gY3JlYXRlQ29udmVydGVyV3JhcHBlcih0aGlzLm1pc3RyYWxDb252ZXJ0ZXIpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBcclxuICAgICAgICBpZiAob3B0aW9ucy5mb3JjZVN0YW5kYXJkKSB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdbUGRmQ29udmVydGVyRmFjdG9yeV0gVXNpbmcgc3RhbmRhcmQgY29udmVydGVyIChmb3JjZWQpJyk7XHJcbiAgICAgICAgICAgIHJldHVybiBjcmVhdGVDb252ZXJ0ZXJXcmFwcGVyKHRoaXMuc3RhbmRhcmRDb252ZXJ0ZXIpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBcclxuICAgICAgICAvLyBDaGVjayBpZiBPQ1IgaXMgYXZhaWxhYmxlXHJcbiAgICAgICAgY29uc3Qgb2NyQXZhaWxhYmxlID0gYXdhaXQgdGhpcy5pc09jckF2YWlsYWJsZSgpO1xyXG4gICAgICAgIGlmICghb2NyQXZhaWxhYmxlKSB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdbUGRmQ29udmVydGVyRmFjdG9yeV0gT0NSIG5vdCBhdmFpbGFibGUsIHVzaW5nIHN0YW5kYXJkIGNvbnZlcnRlcicpO1xyXG4gICAgICAgICAgICByZXR1cm4gY3JlYXRlQ29udmVydGVyV3JhcHBlcih0aGlzLnN0YW5kYXJkQ29udmVydGVyKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgXHJcbiAgICAgICAgLy8gQW5hbHl6ZSBQREYgdG8gZGV0ZXJtaW5lIGlmIE9DUiBpcyBuZWVkZWRcclxuICAgICAgICBjb25zdCBuZWVkc09jciA9IGF3YWl0IHRoaXMuYW5hbHl6ZU5lZWRzT2NyKGZpbGVQYXRoKTtcclxuICAgICAgICBpZiAobmVlZHNPY3IpIHtcclxuICAgICAgICAgICAgY29uc29sZS5sb2coJ1tQZGZDb252ZXJ0ZXJGYWN0b3J5XSBQREYgYW5hbHlzaXMgc3VnZ2VzdHMgT0NSIGlzIG5lZWRlZCcpO1xyXG4gICAgICAgICAgICByZXR1cm4gY3JlYXRlQ29udmVydGVyV3JhcHBlcih0aGlzLm1pc3RyYWxDb252ZXJ0ZXIpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBcclxuICAgICAgICBjb25zb2xlLmxvZygnW1BkZkNvbnZlcnRlckZhY3RvcnldIFVzaW5nIHN0YW5kYXJkIGNvbnZlcnRlciBiYXNlZCBvbiBhbmFseXNpcycpO1xyXG4gICAgICAgIHJldHVybiBjcmVhdGVDb252ZXJ0ZXJXcmFwcGVyKHRoaXMuc3RhbmRhcmRDb252ZXJ0ZXIpO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogQ2hlY2sgaWYgT0NSIGlzIGF2YWlsYWJsZVxyXG4gICAgICogQHJldHVybnMge1Byb21pc2U8Ym9vbGVhbj59IFRydWUgaWYgT0NSIGlzIGF2YWlsYWJsZVxyXG4gICAgICovXHJcbiAgICBhc3luYyBpc09jckF2YWlsYWJsZSgpIHtcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICBjb25zb2xlLmxvZygnW1BkZkNvbnZlcnRlckZhY3RvcnldIENoZWNraW5nIE9DUiBhdmFpbGFiaWxpdHknKTtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIC8vIENoZWNrIGlmIG1pc3RyYWxDb252ZXJ0ZXIgaXMgaW5pdGlhbGl6ZWRcclxuICAgICAgICAgICAgaWYgKCF0aGlzLm1pc3RyYWxDb252ZXJ0ZXIpIHtcclxuICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ1tQZGZDb252ZXJ0ZXJGYWN0b3J5XSBNaXN0cmFsUGRmQ29udmVydGVyIG5vdCBpbml0aWFsaXplZCcpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAvLyBDaGVjayBpZiBBUEkga2V5IGlzIGF2YWlsYWJsZVxyXG4gICAgICAgICAgICBpZiAoIXRoaXMubWlzdHJhbENvbnZlcnRlci5hcGlLZXkpIHtcclxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdbUGRmQ29udmVydGVyRmFjdG9yeV0gTm8gTWlzdHJhbCBBUEkga2V5IGZvdW5kIGluIGNvbnZlcnRlcicpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICBjb25zb2xlLmxvZygnW1BkZkNvbnZlcnRlckZhY3RvcnldIENhbGxpbmcgaGFuZGxlQ2hlY2tBcGlLZXknKTtcclxuICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgdGhpcy5taXN0cmFsQ29udmVydGVyLmhhbmRsZUNoZWNrQXBpS2V5KCk7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdbUGRmQ29udmVydGVyRmFjdG9yeV0gT0NSIGF2YWlsYWJpbGl0eSBjaGVjayByZXN1bHQ6JywgcmVzdWx0KTtcclxuICAgICAgICAgICAgcmV0dXJuIHJlc3VsdC52YWxpZDtcclxuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKCdbUGRmQ29udmVydGVyRmFjdG9yeV0gRXJyb3IgY2hlY2tpbmcgT0NSIGF2YWlsYWJpbGl0eTonLCBlcnJvcik7XHJcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBBbmFseXplIFBERiB0byBkZXRlcm1pbmUgaWYgT0NSIGlzIG5lZWRlZFxyXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IGZpbGVQYXRoIC0gUGF0aCB0byBQREYgZmlsZVxyXG4gICAgICogQHJldHVybnMge1Byb21pc2U8Ym9vbGVhbj59IFRydWUgaWYgT0NSIGlzIHJlY29tbWVuZGVkXHJcbiAgICAgKi9cclxuICAgIGFzeW5jIGFuYWx5emVOZWVkc09jcihmaWxlUGF0aCkge1xyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIC8vIEV4dHJhY3QgdGV4dCB1c2luZyBzdGFuZGFyZCBjb252ZXJ0ZXJcclxuICAgICAgICAgICAgY29uc3QgcGRmRGF0YSA9IGF3YWl0IGZzLnJlYWRGaWxlKGZpbGVQYXRoKTtcclxuICAgICAgICAgICAgY29uc3QgcGRmUGFyc2UgPSByZXF1aXJlKCdwZGYtcGFyc2UnKTtcclxuICAgICAgICAgICAgY29uc3QgZGF0YSA9IGF3YWl0IHBkZlBhcnNlKHBkZkRhdGEpO1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgLy8gQ2hlY2sgaWYgdGV4dCBleHRyYWN0aW9uIHlpZWxkZWQgbWVhbmluZ2Z1bCByZXN1bHRzXHJcbiAgICAgICAgICAgIGNvbnN0IHRleHRMZW5ndGggPSBkYXRhLnRleHQudHJpbSgpLmxlbmd0aDtcclxuICAgICAgICAgICAgY29uc3QgcGFnZUNvdW50ID0gZGF0YS5udW1wYWdlcztcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIC8vIENhbGN1bGF0ZSBhdmVyYWdlIHRleHQgcGVyIHBhZ2VcclxuICAgICAgICAgICAgY29uc3QgYXZnVGV4dFBlclBhZ2UgPSB0ZXh0TGVuZ3RoIC8gcGFnZUNvdW50O1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgLy8gSWYgdmVyeSBsaXR0bGUgdGV4dCB3YXMgZXh0cmFjdGVkLCBPQ1IgbWlnaHQgYmUgbmVlZGVkXHJcbiAgICAgICAgICAgIGlmIChhdmdUZXh0UGVyUGFnZSA8IDEwMCkge1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFtQZGZDb252ZXJ0ZXJGYWN0b3J5XSBMb3cgdGV4dCBjb250ZW50IGRldGVjdGVkICgke2F2Z1RleHRQZXJQYWdlLnRvRml4ZWQoMil9IGNoYXJzL3BhZ2UpLCBzdWdnZXN0aW5nIE9DUmApO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIC8vIENoZWNrIGZvciBzY2FubmVkIGRvY3VtZW50IGluZGljYXRvcnNcclxuICAgICAgICAgICAgY29uc3QgaGFzU2Nhbm5lZEluZGljYXRvcnMgPSB0aGlzLmNoZWNrRm9yU2Nhbm5lZEluZGljYXRvcnMoZGF0YS50ZXh0KTtcclxuICAgICAgICAgICAgaWYgKGhhc1NjYW5uZWRJbmRpY2F0b3JzKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnW1BkZkNvbnZlcnRlckZhY3RvcnldIFNjYW5uZWQgZG9jdW1lbnQgaW5kaWNhdG9ycyBkZXRlY3RlZCwgc3VnZ2VzdGluZyBPQ1InKTtcclxuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgICAgICAgY29uc29sZS5lcnJvcignW1BkZkNvbnZlcnRlckZhY3RvcnldIEVycm9yIGFuYWx5emluZyBQREY6JywgZXJyb3IpO1xyXG4gICAgICAgICAgICAvLyBJZiBhbmFseXNpcyBmYWlscywgZGVmYXVsdCB0byBzdGFuZGFyZCBjb252ZXJ0ZXJcclxuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIENoZWNrIGZvciBpbmRpY2F0b3JzIHRoYXQgYSBkb2N1bWVudCBpcyBzY2FubmVkXHJcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gdGV4dCAtIEV4dHJhY3RlZCB0ZXh0XHJcbiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gVHJ1ZSBpZiBzY2FubmVkIGluZGljYXRvcnMgYXJlIGZvdW5kXHJcbiAgICAgKi9cclxuICAgIGNoZWNrRm9yU2Nhbm5lZEluZGljYXRvcnModGV4dCkge1xyXG4gICAgICAgIC8vIENvbW1vbiBpbmRpY2F0b3JzIGluIHNjYW5uZWQgZG9jdW1lbnRzXHJcbiAgICAgICAgY29uc3QgaW5kaWNhdG9ycyA9IFtcclxuICAgICAgICAgICAgJ3NjYW5uZWQnLFxyXG4gICAgICAgICAgICAnc2NhbicsXHJcbiAgICAgICAgICAgICdvY3InLFxyXG4gICAgICAgICAgICAnaW1hZ2UnLFxyXG4gICAgICAgICAgICAnZGlnaXRpemVkJyxcclxuICAgICAgICAgICAgJ2RpZ2l0aXNlZCdcclxuICAgICAgICBdO1xyXG4gICAgICAgIFxyXG4gICAgICAgIGNvbnN0IGxvd2VyVGV4dCA9IHRleHQudG9Mb3dlckNhc2UoKTtcclxuICAgICAgICByZXR1cm4gaW5kaWNhdG9ycy5zb21lKGluZGljYXRvciA9PiBsb3dlclRleHQuaW5jbHVkZXMoaW5kaWNhdG9yKSk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBDb252ZXJ0IFBERiBmaWxlIHRvIG1hcmtkb3duXHJcbiAgICAgKiBAcGFyYW0ge0VsZWN0cm9uLklwY01haW5JbnZva2VFdmVudH0gZXZlbnQgLSBJUEMgZXZlbnRcclxuICAgICAqIEBwYXJhbSB7T2JqZWN0fSByZXF1ZXN0IC0gQ29udmVyc2lvbiByZXF1ZXN0XHJcbiAgICAgKiBAcmV0dXJucyB7UHJvbWlzZTxPYmplY3Q+fSBDb252ZXJzaW9uIHJlc3VsdFxyXG4gICAgICovXHJcbiAgICBhc3luYyBjb252ZXJ0UGRmKGV2ZW50LCB7IGZpbGVQYXRoLCBvcHRpb25zID0ge30gfSkge1xyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdbUGRmQ29udmVydGVyRmFjdG9yeV0gQ29udmVydGluZyBQREYgd2l0aCBvcHRpb25zOicsIHtcclxuICAgICAgICAgICAgICAgIHVzZU9jcjogb3B0aW9ucy51c2VPY3IsXHJcbiAgICAgICAgICAgICAgICBoYXNNaXN0cmFsQXBpS2V5OiAhIW9wdGlvbnMubWlzdHJhbEFwaUtleSxcclxuICAgICAgICAgICAgICAgIGZvcmNlT2NyOiBvcHRpb25zLmZvcmNlT2NyLFxyXG4gICAgICAgICAgICAgICAgZm9yY2VTdGFuZGFyZDogb3B0aW9ucy5mb3JjZVN0YW5kYXJkXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgLy8gSWYgTWlzdHJhbCBBUEkga2V5IGlzIHByb3ZpZGVkIGluIG9wdGlvbnMsIHNldCBpdCBvbiB0aGUgY29udmVydGVyXHJcbiAgICAgICAgICAgIGlmIChvcHRpb25zLm1pc3RyYWxBcGlLZXkgJiYgdGhpcy5taXN0cmFsQ29udmVydGVyKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnW1BkZkNvbnZlcnRlckZhY3RvcnldIFNldHRpbmcgTWlzdHJhbCBBUEkga2V5IGZyb20gb3B0aW9ucycpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5taXN0cmFsQ29udmVydGVyLmFwaUtleSA9IG9wdGlvbnMubWlzdHJhbEFwaUtleTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgY29uc3QgY29udmVydGVyID0gYXdhaXQgdGhpcy5nZXRDb252ZXJ0ZXIoZmlsZVBhdGgsIG9wdGlvbnMpO1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgLy8gTG9nIHdoaWNoIGNvbnZlcnRlciB3ZSdyZSB1c2luZ1xyXG4gICAgICAgICAgICBjb25zb2xlLmxvZyhgW1BkZkNvbnZlcnRlckZhY3RvcnldIFVzaW5nIGNvbnZlcnRlcjogJHtjb252ZXJ0ZXIubmFtZX1gKTtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIC8vIFVzZSB0aGUgYXBwcm9wcmlhdGUgY29udmVyc2lvbiBtZXRob2RcclxuICAgICAgICAgICAgcmV0dXJuIGF3YWl0IGNvbnZlcnRlci5oYW5kbGVDb252ZXJ0KGV2ZW50LCB7IGZpbGVQYXRoLCBvcHRpb25zIH0pO1xyXG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ1tQZGZDb252ZXJ0ZXJGYWN0b3J5XSBDb252ZXJzaW9uIGZhaWxlZDonLCBlcnJvcik7XHJcbiAgICAgICAgICAgIHRocm93IGVycm9yO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIEdldCBQREYgbWV0YWRhdGFcclxuICAgICAqIEBwYXJhbSB7RWxlY3Ryb24uSXBjTWFpbkludm9rZUV2ZW50fSBldmVudCAtIElQQyBldmVudFxyXG4gICAgICogQHBhcmFtIHtPYmplY3R9IHJlcXVlc3QgLSBNZXRhZGF0YSByZXF1ZXN0XHJcbiAgICAgKiBAcmV0dXJucyB7UHJvbWlzZTxPYmplY3Q+fSBQREYgbWV0YWRhdGFcclxuICAgICAqL1xyXG4gICAgYXN5bmMgZ2V0UGRmTWV0YWRhdGEoZXZlbnQsIHsgZmlsZVBhdGggfSkge1xyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIC8vIEZvciBtZXRhZGF0YSwgd2UgY2FuIGFsd2F5cyB1c2UgdGhlIHN0YW5kYXJkIGNvbnZlcnRlclxyXG4gICAgICAgICAgICByZXR1cm4gYXdhaXQgdGhpcy5zdGFuZGFyZENvbnZlcnRlci5oYW5kbGVHZXRNZXRhZGF0YShldmVudCwgeyBmaWxlUGF0aCB9KTtcclxuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKCdbUGRmQ29udmVydGVyRmFjdG9yeV0gRmFpbGVkIHRvIGdldCBtZXRhZGF0YTonLCBlcnJvcik7XHJcbiAgICAgICAgICAgIHRocm93IGVycm9yO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIENoZWNrIGlmIHRoaXMgZmFjdG9yeSBzdXBwb3J0cyB0aGUgZ2l2ZW4gZmlsZVxyXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IGZpbGVQYXRoIC0gUGF0aCB0byBmaWxlXHJcbiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gVHJ1ZSBpZiBzdXBwb3J0ZWRcclxuICAgICAqL1xyXG4gICAgc3VwcG9ydHNGaWxlKGZpbGVQYXRoKSB7XHJcbiAgICAgICAgY29uc3QgZXh0ID0gcGF0aC5leHRuYW1lKGZpbGVQYXRoKS50b0xvd2VyQ2FzZSgpO1xyXG4gICAgICAgIHJldHVybiB0aGlzLnN1cHBvcnRlZEV4dGVuc2lvbnMuaW5jbHVkZXMoZXh0KTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIEdldCBmYWN0b3J5IGluZm9ybWF0aW9uXHJcbiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBGYWN0b3J5IGRldGFpbHNcclxuICAgICAqL1xyXG4gICAgZ2V0SW5mbygpIHtcclxuICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICBuYW1lOiAnUERGIENvbnZlcnRlciBGYWN0b3J5JyxcclxuICAgICAgICAgICAgZXh0ZW5zaW9uczogdGhpcy5zdXBwb3J0ZWRFeHRlbnNpb25zLFxyXG4gICAgICAgICAgICBkZXNjcmlwdGlvbjogJ0ZhY3RvcnkgZm9yIFBERiBjb252ZXJ0ZXJzIHdpdGggYXV0b21hdGljIHNlbGVjdGlvbicsXHJcbiAgICAgICAgICAgIGNvbnZlcnRlcnM6IFtcclxuICAgICAgICAgICAgICAgIHRoaXMuc3RhbmRhcmRDb252ZXJ0ZXIuZ2V0SW5mbygpLFxyXG4gICAgICAgICAgICAgICAgdGhpcy5taXN0cmFsQ29udmVydGVyLmdldEluZm8oKVxyXG4gICAgICAgICAgICBdLFxyXG4gICAgICAgICAgICBvcHRpb25zOiB7XHJcbiAgICAgICAgICAgICAgICBmb3JjZU9jcjogJ0ZvcmNlIHVzZSBvZiBPQ1IgY29udmVydGVyJyxcclxuICAgICAgICAgICAgICAgIGZvcmNlU3RhbmRhcmQ6ICdGb3JjZSB1c2Ugb2Ygc3RhbmRhcmQgY29udmVydGVyJ1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfTtcclxuICAgIH1cclxufVxyXG5cclxubW9kdWxlLmV4cG9ydHMgPSBQZGZDb252ZXJ0ZXJGYWN0b3J5O1xyXG4iXSwibWFwcGluZ3MiOiI7O0FBQUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUEsTUFBTUEsSUFBSSxHQUFHQyxPQUFPLENBQUMsTUFBTSxDQUFDO0FBQzVCLE1BQU1DLEVBQUUsR0FBR0QsT0FBTyxDQUFDLFVBQVUsQ0FBQztBQUM5QixNQUFNRSxvQkFBb0IsR0FBR0YsT0FBTyxDQUFDLHdCQUF3QixDQUFDO0FBQzlELE1BQU1HLG1CQUFtQixHQUFHSCxPQUFPLENBQUMsdUJBQXVCLENBQUM7QUFFNUQsTUFBTUksbUJBQW1CLENBQUM7RUFDdEJDLFdBQVdBLENBQUNDLGFBQWEsRUFBRUMsV0FBVyxFQUFFQyxXQUFXLEVBQUU7SUFDakQsSUFBSSxDQUFDRixhQUFhLEdBQUdBLGFBQWE7SUFDbEMsSUFBSSxDQUFDQyxXQUFXLEdBQUdBLFdBQVc7SUFDOUIsSUFBSSxDQUFDQyxXQUFXLEdBQUdBLFdBQVc7SUFDOUIsSUFBSSxDQUFDQyxt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