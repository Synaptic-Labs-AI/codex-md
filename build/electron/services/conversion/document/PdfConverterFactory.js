"use strict";

/**
 * PdfConverterFactory.js
 * Factory for creating appropriate PDF converters based on file and options.
 * 
 * This factory:
 * - Analyzes PDF files to determine the best conversion approach
 * - Creates instances of appropriate PDF converters
 * - Provides a unified interface for PDF conversion
 * - Handles fallback between different conversion methods
 * 
 * Related Files:
 * - BasePdfConverter.js: Base class for PDF converters
 * - StandardPdfConverter.js: Text-based PDF converter
 * - MistralPdfConverter.js: OCR-based PDF converter
 * - ConversionService.js: Uses this factory for PDF conversion
 */

const path = require('path');
const fs = require('fs-extra');
const StandardPdfConverter = require('./StandardPdfConverter');
const MistralPdfConverter = require('./MistralPdfConverter');
class PdfConverterFactory {
  constructor(fileProcessor, fileStorage) {
    this.fileProcessor = fileProcessor;
    this.fileStorage = fileStorage;
    this.supportedExtensions = ['.pdf'];

    // Create converter instances - pass true for skipHandlerSetup
    // This prevents duplicate IPC handler registration when used through the factory
    this.standardConverter = new StandardPdfConverter(fileProcessor, fileStorage, true);
    this.mistralConverter = new MistralPdfConverter(fileProcessor, fileStorage, null, true);
  }

  /**
   * Get appropriate converter for PDF file
   * @param {string} filePath - Path to PDF file
   * @param {Object} options - Conversion options
   * @returns {Object} Appropriate PDF converter with convert method
   */
  async getConverter(filePath, options = {}) {
    console.log('[PdfConverterFactory] Getting converter for PDF file');

    // Create a wrapper object that exposes the convert method
    const createConverterWrapper = converter => {
      return {
        convert: async (content, name, apiKey, options) => {
          console.log(`[PdfConverterFactory] Using ${converter.name} for conversion`);
          return await converter.convertToMarkdown(content, {
            ...options,
            name,
            apiKey
          });
        }
      };
    };
    // Check if OCR is explicitly enabled in options
    console.log('[PdfConverterFactory] Checking if OCR is enabled in options:', options);
    console.log(`[PdfConverterFactory] options.useOcr = ${options.useOcr} (type: ${typeof options.useOcr})`);
    if (options.useOcr) {
      console.log('[PdfConverterFactory] Using OCR converter (enabled in settings)');

      // Check if OCR is available
      const ocrAvailable = await this.isOcrAvailable();
      console.log(`[PdfConverterFactory] OCR available: ${ocrAvailable}`);
      if (!ocrAvailable) {
        console.log('[PdfConverterFactory] OCR not available despite being enabled, using standard converter');
        return createConverterWrapper(this.standardConverter);
      }
      console.log('[PdfConverterFactory] OCR is available, using Mistral converter');
      return createConverterWrapper(this.mistralConverter);
    } else {
      console.log('[PdfConverterFactory] OCR is not enabled in options, checking other conditions');
    }

    // If force option is specified, use the requested converter
    if (options.forceOcr) {
      console.log('[PdfConverterFactory] Using OCR converter (forced)');
      return createConverterWrapper(this.mistralConverter);
    }
    if (options.forceStandard) {
      console.log('[PdfConverterFactory] Using standard converter (forced)');
      return createConverterWrapper(this.standardConverter);
    }

    // Check if OCR is available
    const ocrAvailable = await this.isOcrAvailable();
    if (!ocrAvailable) {
      console.log('[PdfConverterFactory] OCR not available, using standard converter');
      return createConverterWrapper(this.standardConverter);
    }

    // Analyze PDF to determine if OCR is needed
    const needsOcr = await this.analyzeNeedsOcr(filePath);
    if (needsOcr) {
      console.log('[PdfConverterFactory] PDF analysis suggests OCR is needed');
      return createConverterWrapper(this.mistralConverter);
    }
    console.log('[PdfConverterFactory] Using standard converter based on analysis');
    return createConverterWrapper(this.standardConverter);
  }

  /**
   * Check if OCR is available
   * @returns {Promise<boolean>} True if OCR is available
   */
  async isOcrAvailable() {
    try {
      console.log('[PdfConverterFactory] Checking OCR availability');

      // Check if mistralConverter is initialized
      if (!this.mistralConverter) {
        console.error('[PdfConverterFactory] MistralPdfConverter not initialized');
        return false;
      }

      // Check if API key is available
      if (!this.mistralConverter.apiKey) {
        console.log('[PdfConverterFactory] No Mistral API key found in converter');
        return false;
      }
      console.log('[PdfConverterFactory] Calling handleCheckApiKey');
      const result = await this.mistralConverter.handleCheckApiKey();
      console.log('[PdfConverterFactory] OCR availability check result:', result);
      return result.valid;
    } catch (error) {
      console.error('[PdfConverterFactory] Error checking OCR availability:', error);
      return false;
    }
  }

  /**
   * Analyze PDF to determine if OCR is needed
   * @param {string} filePath - Path to PDF file
   * @returns {Promise<boolean>} True if OCR is recommended
   */
  async analyzeNeedsOcr(filePath) {
    try {
      // Extract text using standard converter
      const pdfData = await fs.readFile(filePath);
      const pdfParse = require('pdf-parse');
      const data = await pdfParse(pdfData);

      // Check if text extraction yielded meaningful results
      const textLength = data.text.trim().length;
      const pageCount = data.numpages;

      // Calculate average text per page
      const avgTextPerPage = textLength / pageCount;

      // If very little text was extracted, OCR might be needed
      if (avgTextPerPage < 100) {
        console.log(`[PdfConverterFactory] Low text content detected (${avgTextPerPage.toFixed(2)} chars/page), suggesting OCR`);
        return true;
      }

      // Check for scanned document indicators
      const hasScannedIndicators = this.checkForScannedIndicators(data.text);
      if (hasScannedIndicators) {
        console.log('[PdfConverterFactory] Scanned document indicators detected, suggesting OCR');
        return true;
      }
      return false;
    } catch (error) {
      console.error('[PdfConverterFactory] Error analyzing PDF:', error);
      // If analysis fails, default to standard converter
      return false;
    }
  }

  /**
   * Check for indicators that a document is scanned
   * @param {string} text - Extracted text
   * @returns {boolean} True if scanned indicators are found
   */
  checkForScannedIndicators(text) {
    // Common indicators in scanned documents
    const indicators = ['scanned', 'scan', 'ocr', 'image', 'digitized', 'digitised'];
    const lowerText = text.toLowerCase();
    return indicators.some(indicator => lowerText.includes(indicator));
  }

  /**
   * Convert PDF file to markdown
   * @param {Electron.IpcMainInvokeEvent} event - IPC event
   * @param {Object} request - Conversion request
   * @returns {Promise<Object>} Conversion result
   */
  async convertPdf(event, {
    filePath,
    options = {}
  }) {
    try {
      console.log('[PdfConverterFactory] Converting PDF with options:', {
        useOcr: options.useOcr,
        hasMistralApiKey: !!options.mistralApiKey,
        forceOcr: options.forceOcr,
        forceStandard: options.forceStandard
      });

      // If Mistral API key is provided in options, set it on the converter
      if (options.mistralApiKey && this.mistralConverter) {
        console.log('[PdfConverterFactory] Setting Mistral API key from options');
        this.mistralConverter.setApiKey(options.mistralApiKey);
      }
      const converter = await this.getConverter(filePath, options);

      // Log which converter we're using
      console.log(`[PdfConverterFactory] Using converter: ${converter.name}`);

      // Use the appropriate conversion method
      return await converter.handleConvert(event, {
        filePath,
        options
      });
    } catch (error) {
      console.error('[PdfConverterFactory] Conversion failed:', error);
      throw error;
    }
  }

  /**
   * Get PDF metadata
   * @param {Electron.IpcMainInvokeEvent} event - IPC event
   * @param {Object} request - Metadata request
   * @returns {Promise<Object>} PDF metadata
   */
  async getPdfMetadata(event, {
    filePath
  }) {
    try {
      // For metadata, we can always use the standard converter
      return await this.standardConverter.handleGetMetadata(event, {
        filePath
      });
    } catch (error) {
      console.error('[PdfConverterFactory] Failed to get metadata:', error);
      throw error;
    }
  }

  /**
   * Check if this factory supports the given file
   * @param {string} filePath - Path to file
   * @returns {boolean} True if supported
   */
  supportsFile(filePath) {
    const ext = path.extname(filePath).toLowerCase();
    return this.supportedExtensions.includes(ext);
  }

  /**
   * Get factory information
   * @returns {Object} Factory details
   */
  getInfo() {
    return {
      name: 'PDF Converter Factory',
      extensions: this.supportedExtensions,
      description: 'Factory for PDF converters with automatic selection',
      converters: [this.standardConverter.getInfo(), this.mistralConverter.getInfo()],
      options: {
        forceOcr: 'Force use of OCR converter',
        forceStandard: 'Force use of standard converter'
      }
    };
  }
}
module.exports = PdfConverterFactory;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJwYXRoIiwicmVxdWlyZSIsImZzIiwiU3RhbmRhcmRQZGZDb252ZXJ0ZXIiLCJNaXN0cmFsUGRmQ29udmVydGVyIiwiUGRmQ29udmVydGVyRmFjdG9yeSIsImNvbnN0cnVjdG9yIiwiZmlsZVByb2Nlc3NvciIsImZpbGVTdG9yYWdlIiwic3VwcG9ydGVkRXh0ZW5zaW9ucyIsInN0YW5kYXJkQ29udmVydGVyIiwibWlzdHJhbENvbnZlcnRlciIsImdldENvbnZlcnRlciIsImZpbGVQYXRoIiwib3B0aW9ucyIsImNvbnNvbGUiLCJsb2ciLCJjcmVhdGVDb252ZXJ0ZXJXcmFwcGVyIiwiY29udmVydGVyIiwiY29udmVydCIsImNvbnRlbnQiLCJuYW1lIiwiYXBpS2V5IiwiY29udmVydFRvTWFya2Rvd24iLCJ1c2VPY3IiLCJvY3JBdmFpbGFibGUiLCJpc09jckF2YWlsYWJsZSIsImZvcmNlT2NyIiwiZm9yY2VTdGFuZGFyZCIsIm5lZWRzT2NyIiwiYW5hbHl6ZU5lZWRzT2NyIiwiZXJyb3IiLCJyZXN1bHQiLCJoYW5kbGVDaGVja0FwaUtleSIsInZhbGlkIiwicGRmRGF0YSIsInJlYWRGaWxlIiwicGRmUGFyc2UiLCJkYXRhIiwidGV4dExlbmd0aCIsInRleHQiLCJ0cmltIiwibGVuZ3RoIiwicGFnZUNvdW50IiwibnVtcGFnZXMiLCJhdmdUZXh0UGVyUGFnZSIsInRvRml4ZWQiLCJoYXNTY2FubmVkSW5kaWNhdG9ycyIsImNoZWNrRm9yU2Nhbm5lZEluZGljYXRvcnMiLCJpbmRpY2F0b3JzIiwibG93ZXJUZXh0IiwidG9Mb3dlckNhc2UiLCJzb21lIiwiaW5kaWNhdG9yIiwiaW5jbHVkZXMiLCJjb252ZXJ0UGRmIiwiZXZlbnQiLCJoYXNNaXN0cmFsQXBpS2V5IiwibWlzdHJhbEFwaUtleSIsInNldEFwaUtleSIsImhhbmRsZUNvbnZlcnQiLCJnZXRQZGZNZXRhZGF0YSIsImhhbmRsZUdldE1ldGFkYXRhIiwic3VwcG9ydHNGaWxlIiwiZXh0IiwiZXh0bmFtZSIsImdldEluZm8iLCJleHRlbnNpb25zIiwiZGVzY3JpcHRpb24iLCJjb252ZXJ0ZXJzIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3NyYy9lbGVjdHJvbi9zZXJ2aWNlcy9jb252ZXJzaW9uL2RvY3VtZW50L1BkZkNvbnZlcnRlckZhY3RvcnkuanMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXHJcbiAqIFBkZkNvbnZlcnRlckZhY3RvcnkuanNcclxuICogRmFjdG9yeSBmb3IgY3JlYXRpbmcgYXBwcm9wcmlhdGUgUERGIGNvbnZlcnRlcnMgYmFzZWQgb24gZmlsZSBhbmQgb3B0aW9ucy5cclxuICogXHJcbiAqIFRoaXMgZmFjdG9yeTpcclxuICogLSBBbmFseXplcyBQREYgZmlsZXMgdG8gZGV0ZXJtaW5lIHRoZSBiZXN0IGNvbnZlcnNpb24gYXBwcm9hY2hcclxuICogLSBDcmVhdGVzIGluc3RhbmNlcyBvZiBhcHByb3ByaWF0ZSBQREYgY29udmVydGVyc1xyXG4gKiAtIFByb3ZpZGVzIGEgdW5pZmllZCBpbnRlcmZhY2UgZm9yIFBERiBjb252ZXJzaW9uXHJcbiAqIC0gSGFuZGxlcyBmYWxsYmFjayBiZXR3ZWVuIGRpZmZlcmVudCBjb252ZXJzaW9uIG1ldGhvZHNcclxuICogXHJcbiAqIFJlbGF0ZWQgRmlsZXM6XHJcbiAqIC0gQmFzZVBkZkNvbnZlcnRlci5qczogQmFzZSBjbGFzcyBmb3IgUERGIGNvbnZlcnRlcnNcclxuICogLSBTdGFuZGFyZFBkZkNvbnZlcnRlci5qczogVGV4dC1iYXNlZCBQREYgY29udmVydGVyXHJcbiAqIC0gTWlzdHJhbFBkZkNvbnZlcnRlci5qczogT0NSLWJhc2VkIFBERiBjb252ZXJ0ZXJcclxuICogLSBDb252ZXJzaW9uU2VydmljZS5qczogVXNlcyB0aGlzIGZhY3RvcnkgZm9yIFBERiBjb252ZXJzaW9uXHJcbiAqL1xyXG5cclxuY29uc3QgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKTtcclxuY29uc3QgZnMgPSByZXF1aXJlKCdmcy1leHRyYScpO1xyXG5jb25zdCBTdGFuZGFyZFBkZkNvbnZlcnRlciA9IHJlcXVpcmUoJy4vU3RhbmRhcmRQZGZDb252ZXJ0ZXInKTtcclxuY29uc3QgTWlzdHJhbFBkZkNvbnZlcnRlciA9IHJlcXVpcmUoJy4vTWlzdHJhbFBkZkNvbnZlcnRlcicpO1xyXG5cclxuY2xhc3MgUGRmQ29udmVydGVyRmFjdG9yeSB7XHJcbiAgICBjb25zdHJ1Y3RvcihmaWxlUHJvY2Vzc29yLCBmaWxlU3RvcmFnZSkge1xyXG4gICAgICAgIHRoaXMuZmlsZVByb2Nlc3NvciA9IGZpbGVQcm9jZXNzb3I7XHJcbiAgICAgICAgdGhpcy5maWxlU3RvcmFnZSA9IGZpbGVTdG9yYWdlO1xyXG4gICAgICAgIHRoaXMuc3VwcG9ydGVkRXh0ZW5zaW9ucyA9IFsnLnBkZiddO1xyXG4gICAgICAgIFxyXG4gICAgICAgIC8vIENyZWF0ZSBjb252ZXJ0ZXIgaW5zdGFuY2VzIC0gcGFzcyB0cnVlIGZvciBza2lwSGFuZGxlclNldHVwXHJcbiAgICAgICAgLy8gVGhpcyBwcmV2ZW50cyBkdXBsaWNhdGUgSVBDIGhhbmRsZXIgcmVnaXN0cmF0aW9uIHdoZW4gdXNlZCB0aHJvdWdoIHRoZSBmYWN0b3J5XHJcbiAgICAgICAgdGhpcy5zdGFuZGFyZENvbnZlcnRlciA9IG5ldyBTdGFuZGFyZFBkZkNvbnZlcnRlcihmaWxlUHJvY2Vzc29yLCBmaWxlU3RvcmFnZSwgdHJ1ZSk7XHJcbiAgICAgICAgdGhpcy5taXN0cmFsQ29udmVydGVyID0gbmV3IE1pc3RyYWxQZGZDb252ZXJ0ZXIoZmlsZVByb2Nlc3NvciwgZmlsZVN0b3JhZ2UsIG51bGwsIHRydWUpO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogR2V0IGFwcHJvcHJpYXRlIGNvbnZlcnRlciBmb3IgUERGIGZpbGVcclxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBmaWxlUGF0aCAtIFBhdGggdG8gUERGIGZpbGVcclxuICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zIC0gQ29udmVyc2lvbiBvcHRpb25zXHJcbiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBBcHByb3ByaWF0ZSBQREYgY29udmVydGVyIHdpdGggY29udmVydCBtZXRob2RcclxuICAgICAqL1xyXG4gICAgYXN5bmMgZ2V0Q29udmVydGVyKGZpbGVQYXRoLCBvcHRpb25zID0ge30pIHtcclxuICAgICAgICBjb25zb2xlLmxvZygnW1BkZkNvbnZlcnRlckZhY3RvcnldIEdldHRpbmcgY29udmVydGVyIGZvciBQREYgZmlsZScpO1xyXG4gICAgICAgIFxyXG4gICAgICAgIC8vIENyZWF0ZSBhIHdyYXBwZXIgb2JqZWN0IHRoYXQgZXhwb3NlcyB0aGUgY29udmVydCBtZXRob2RcclxuICAgICAgICBjb25zdCBjcmVhdGVDb252ZXJ0ZXJXcmFwcGVyID0gKGNvbnZlcnRlcikgPT4ge1xyXG4gICAgICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICAgICAgY29udmVydDogYXN5bmMgKGNvbnRlbnQsIG5hbWUsIGFwaUtleSwgb3B0aW9ucykgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbUGRmQ29udmVydGVyRmFjdG9yeV0gVXNpbmcgJHtjb252ZXJ0ZXIubmFtZX0gZm9yIGNvbnZlcnNpb25gKTtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gYXdhaXQgY29udmVydGVyLmNvbnZlcnRUb01hcmtkb3duKGNvbnRlbnQsIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgLi4ub3B0aW9ucyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgbmFtZSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgYXBpS2V5XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgfTtcclxuICAgICAgICAvLyBDaGVjayBpZiBPQ1IgaXMgZXhwbGljaXRseSBlbmFibGVkIGluIG9wdGlvbnNcclxuICAgICAgICBjb25zb2xlLmxvZygnW1BkZkNvbnZlcnRlckZhY3RvcnldIENoZWNraW5nIGlmIE9DUiBpcyBlbmFibGVkIGluIG9wdGlvbnM6Jywgb3B0aW9ucyk7XHJcbiAgICAgICAgY29uc29sZS5sb2coYFtQZGZDb252ZXJ0ZXJGYWN0b3J5XSBvcHRpb25zLnVzZU9jciA9ICR7b3B0aW9ucy51c2VPY3J9ICh0eXBlOiAke3R5cGVvZiBvcHRpb25zLnVzZU9jcn0pYCk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgaWYgKG9wdGlvbnMudXNlT2NyKSB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdbUGRmQ29udmVydGVyRmFjdG9yeV0gVXNpbmcgT0NSIGNvbnZlcnRlciAoZW5hYmxlZCBpbiBzZXR0aW5ncyknKTtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIC8vIENoZWNrIGlmIE9DUiBpcyBhdmFpbGFibGVcclxuICAgICAgICAgICAgY29uc3Qgb2NyQXZhaWxhYmxlID0gYXdhaXQgdGhpcy5pc09jckF2YWlsYWJsZSgpO1xyXG4gICAgICAgICAgICBjb25zb2xlLmxvZyhgW1BkZkNvbnZlcnRlckZhY3RvcnldIE9DUiBhdmFpbGFibGU6ICR7b2NyQXZhaWxhYmxlfWApO1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgaWYgKCFvY3JBdmFpbGFibGUpIHtcclxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdbUGRmQ29udmVydGVyRmFjdG9yeV0gT0NSIG5vdCBhdmFpbGFibGUgZGVzcGl0ZSBiZWluZyBlbmFibGVkLCB1c2luZyBzdGFuZGFyZCBjb252ZXJ0ZXInKTtcclxuICAgICAgICAgICAgICAgIHJldHVybiBjcmVhdGVDb252ZXJ0ZXJXcmFwcGVyKHRoaXMuc3RhbmRhcmRDb252ZXJ0ZXIpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICBjb25zb2xlLmxvZygnW1BkZkNvbnZlcnRlckZhY3RvcnldIE9DUiBpcyBhdmFpbGFibGUsIHVzaW5nIE1pc3RyYWwgY29udmVydGVyJyk7XHJcbiAgICAgICAgICAgIHJldHVybiBjcmVhdGVDb252ZXJ0ZXJXcmFwcGVyKHRoaXMubWlzdHJhbENvbnZlcnRlcik7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgY29uc29sZS5sb2coJ1tQZGZDb252ZXJ0ZXJGYWN0b3J5XSBPQ1IgaXMgbm90IGVuYWJsZWQgaW4gb3B0aW9ucywgY2hlY2tpbmcgb3RoZXIgY29uZGl0aW9ucycpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBcclxuICAgICAgICAvLyBJZiBmb3JjZSBvcHRpb24gaXMgc3BlY2lmaWVkLCB1c2UgdGhlIHJlcXVlc3RlZCBjb252ZXJ0ZXJcclxuICAgICAgICBpZiAob3B0aW9ucy5mb3JjZU9jcikge1xyXG4gICAgICAgICAgICBjb25zb2xlLmxvZygnW1BkZkNvbnZlcnRlckZhY3RvcnldIFVzaW5nIE9DUiBjb252ZXJ0ZXIgKGZvcmNlZCknKTtcclxuICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZUNvbnZlcnRlcldyYXBwZXIodGhpcy5taXN0cmFsQ29udmVydGVyKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgXHJcbiAgICAgICAgaWYgKG9wdGlvbnMuZm9yY2VTdGFuZGFyZCkge1xyXG4gICAgICAgICAgICBjb25zb2xlLmxvZygnW1BkZkNvbnZlcnRlckZhY3RvcnldIFVzaW5nIHN0YW5kYXJkIGNvbnZlcnRlciAoZm9yY2VkKScpO1xyXG4gICAgICAgICAgICByZXR1cm4gY3JlYXRlQ29udmVydGVyV3JhcHBlcih0aGlzLnN0YW5kYXJkQ29udmVydGVyKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgXHJcbiAgICAgICAgLy8gQ2hlY2sgaWYgT0NSIGlzIGF2YWlsYWJsZVxyXG4gICAgICAgIGNvbnN0IG9jckF2YWlsYWJsZSA9IGF3YWl0IHRoaXMuaXNPY3JBdmFpbGFibGUoKTtcclxuICAgICAgICBpZiAoIW9jckF2YWlsYWJsZSkge1xyXG4gICAgICAgICAgICBjb25zb2xlLmxvZygnW1BkZkNvbnZlcnRlckZhY3RvcnldIE9DUiBub3QgYXZhaWxhYmxlLCB1c2luZyBzdGFuZGFyZCBjb252ZXJ0ZXInKTtcclxuICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZUNvbnZlcnRlcldyYXBwZXIodGhpcy5zdGFuZGFyZENvbnZlcnRlcik7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIFxyXG4gICAgICAgIC8vIEFuYWx5emUgUERGIHRvIGRldGVybWluZSBpZiBPQ1IgaXMgbmVlZGVkXHJcbiAgICAgICAgY29uc3QgbmVlZHNPY3IgPSBhd2FpdCB0aGlzLmFuYWx5emVOZWVkc09jcihmaWxlUGF0aCk7XHJcbiAgICAgICAgaWYgKG5lZWRzT2NyKSB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdbUGRmQ29udmVydGVyRmFjdG9yeV0gUERGIGFuYWx5c2lzIHN1Z2dlc3RzIE9DUiBpcyBuZWVkZWQnKTtcclxuICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZUNvbnZlcnRlcldyYXBwZXIodGhpcy5taXN0cmFsQ29udmVydGVyKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgXHJcbiAgICAgICAgY29uc29sZS5sb2coJ1tQZGZDb252ZXJ0ZXJGYWN0b3J5XSBVc2luZyBzdGFuZGFyZCBjb252ZXJ0ZXIgYmFzZWQgb24gYW5hbHlzaXMnKTtcclxuICAgICAgICByZXR1cm4gY3JlYXRlQ29udmVydGVyV3JhcHBlcih0aGlzLnN0YW5kYXJkQ29udmVydGVyKTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIENoZWNrIGlmIE9DUiBpcyBhdmFpbGFibGVcclxuICAgICAqIEByZXR1cm5zIHtQcm9taXNlPGJvb2xlYW4+fSBUcnVlIGlmIE9DUiBpcyBhdmFpbGFibGVcclxuICAgICAqL1xyXG4gICAgYXN5bmMgaXNPY3JBdmFpbGFibGUoKSB7XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgY29uc29sZS5sb2coJ1tQZGZDb252ZXJ0ZXJGYWN0b3J5XSBDaGVja2luZyBPQ1IgYXZhaWxhYmlsaXR5Jyk7XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAvLyBDaGVjayBpZiBtaXN0cmFsQ29udmVydGVyIGlzIGluaXRpYWxpemVkXHJcbiAgICAgICAgICAgIGlmICghdGhpcy5taXN0cmFsQ29udmVydGVyKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKCdbUGRmQ29udmVydGVyRmFjdG9yeV0gTWlzdHJhbFBkZkNvbnZlcnRlciBub3QgaW5pdGlhbGl6ZWQnKTtcclxuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgLy8gQ2hlY2sgaWYgQVBJIGtleSBpcyBhdmFpbGFibGVcclxuICAgICAgICAgICAgaWYgKCF0aGlzLm1pc3RyYWxDb252ZXJ0ZXIuYXBpS2V5KSB7XHJcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnW1BkZkNvbnZlcnRlckZhY3RvcnldIE5vIE1pc3RyYWwgQVBJIGtleSBmb3VuZCBpbiBjb252ZXJ0ZXInKTtcclxuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgY29uc29sZS5sb2coJ1tQZGZDb252ZXJ0ZXJGYWN0b3J5XSBDYWxsaW5nIGhhbmRsZUNoZWNrQXBpS2V5Jyk7XHJcbiAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHRoaXMubWlzdHJhbENvbnZlcnRlci5oYW5kbGVDaGVja0FwaUtleSgpO1xyXG4gICAgICAgICAgICBjb25zb2xlLmxvZygnW1BkZkNvbnZlcnRlckZhY3RvcnldIE9DUiBhdmFpbGFiaWxpdHkgY2hlY2sgcmVzdWx0OicsIHJlc3VsdCk7XHJcbiAgICAgICAgICAgIHJldHVybiByZXN1bHQudmFsaWQ7XHJcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgICAgICAgY29uc29sZS5lcnJvcignW1BkZkNvbnZlcnRlckZhY3RvcnldIEVycm9yIGNoZWNraW5nIE9DUiBhdmFpbGFiaWxpdHk6JywgZXJyb3IpO1xyXG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogQW5hbHl6ZSBQREYgdG8gZGV0ZXJtaW5lIGlmIE9DUiBpcyBuZWVkZWRcclxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBmaWxlUGF0aCAtIFBhdGggdG8gUERGIGZpbGVcclxuICAgICAqIEByZXR1cm5zIHtQcm9taXNlPGJvb2xlYW4+fSBUcnVlIGlmIE9DUiBpcyByZWNvbW1lbmRlZFxyXG4gICAgICovXHJcbiAgICBhc3luYyBhbmFseXplTmVlZHNPY3IoZmlsZVBhdGgpIHtcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICAvLyBFeHRyYWN0IHRleHQgdXNpbmcgc3RhbmRhcmQgY29udmVydGVyXHJcbiAgICAgICAgICAgIGNvbnN0IHBkZkRhdGEgPSBhd2FpdCBmcy5yZWFkRmlsZShmaWxlUGF0aCk7XHJcbiAgICAgICAgICAgIGNvbnN0IHBkZlBhcnNlID0gcmVxdWlyZSgncGRmLXBhcnNlJyk7XHJcbiAgICAgICAgICAgIGNvbnN0IGRhdGEgPSBhd2FpdCBwZGZQYXJzZShwZGZEYXRhKTtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIC8vIENoZWNrIGlmIHRleHQgZXh0cmFjdGlvbiB5aWVsZGVkIG1lYW5pbmdmdWwgcmVzdWx0c1xyXG4gICAgICAgICAgICBjb25zdCB0ZXh0TGVuZ3RoID0gZGF0YS50ZXh0LnRyaW0oKS5sZW5ndGg7XHJcbiAgICAgICAgICAgIGNvbnN0IHBhZ2VDb3VudCA9IGRhdGEubnVtcGFnZXM7XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAvLyBDYWxjdWxhdGUgYXZlcmFnZSB0ZXh0IHBlciBwYWdlXHJcbiAgICAgICAgICAgIGNvbnN0IGF2Z1RleHRQZXJQYWdlID0gdGV4dExlbmd0aCAvIHBhZ2VDb3VudDtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIC8vIElmIHZlcnkgbGl0dGxlIHRleHQgd2FzIGV4dHJhY3RlZCwgT0NSIG1pZ2h0IGJlIG5lZWRlZFxyXG4gICAgICAgICAgICBpZiAoYXZnVGV4dFBlclBhZ2UgPCAxMDApIHtcclxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbUGRmQ29udmVydGVyRmFjdG9yeV0gTG93IHRleHQgY29udGVudCBkZXRlY3RlZCAoJHthdmdUZXh0UGVyUGFnZS50b0ZpeGVkKDIpfSBjaGFycy9wYWdlKSwgc3VnZ2VzdGluZyBPQ1JgKTtcclxuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAvLyBDaGVjayBmb3Igc2Nhbm5lZCBkb2N1bWVudCBpbmRpY2F0b3JzXHJcbiAgICAgICAgICAgIGNvbnN0IGhhc1NjYW5uZWRJbmRpY2F0b3JzID0gdGhpcy5jaGVja0ZvclNjYW5uZWRJbmRpY2F0b3JzKGRhdGEudGV4dCk7XHJcbiAgICAgICAgICAgIGlmIChoYXNTY2FubmVkSW5kaWNhdG9ycykge1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ1tQZGZDb252ZXJ0ZXJGYWN0b3J5XSBTY2FubmVkIGRvY3VtZW50IGluZGljYXRvcnMgZGV0ZWN0ZWQsIHN1Z2dlc3RpbmcgT0NSJyk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ1tQZGZDb252ZXJ0ZXJGYWN0b3J5XSBFcnJvciBhbmFseXppbmcgUERGOicsIGVycm9yKTtcclxuICAgICAgICAgICAgLy8gSWYgYW5hbHlzaXMgZmFpbHMsIGRlZmF1bHQgdG8gc3RhbmRhcmQgY29udmVydGVyXHJcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBDaGVjayBmb3IgaW5kaWNhdG9ycyB0aGF0IGEgZG9jdW1lbnQgaXMgc2Nhbm5lZFxyXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IHRleHQgLSBFeHRyYWN0ZWQgdGV4dFxyXG4gICAgICogQHJldHVybnMge2Jvb2xlYW59IFRydWUgaWYgc2Nhbm5lZCBpbmRpY2F0b3JzIGFyZSBmb3VuZFxyXG4gICAgICovXHJcbiAgICBjaGVja0ZvclNjYW5uZWRJbmRpY2F0b3JzKHRleHQpIHtcclxuICAgICAgICAvLyBDb21tb24gaW5kaWNhdG9ycyBpbiBzY2FubmVkIGRvY3VtZW50c1xyXG4gICAgICAgIGNvbnN0IGluZGljYXRvcnMgPSBbXHJcbiAgICAgICAgICAgICdzY2FubmVkJyxcclxuICAgICAgICAgICAgJ3NjYW4nLFxyXG4gICAgICAgICAgICAnb2NyJyxcclxuICAgICAgICAgICAgJ2ltYWdlJyxcclxuICAgICAgICAgICAgJ2RpZ2l0aXplZCcsXHJcbiAgICAgICAgICAgICdkaWdpdGlzZWQnXHJcbiAgICAgICAgXTtcclxuICAgICAgICBcclxuICAgICAgICBjb25zdCBsb3dlclRleHQgPSB0ZXh0LnRvTG93ZXJDYXNlKCk7XHJcbiAgICAgICAgcmV0dXJuIGluZGljYXRvcnMuc29tZShpbmRpY2F0b3IgPT4gbG93ZXJUZXh0LmluY2x1ZGVzKGluZGljYXRvcikpO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogQ29udmVydCBQREYgZmlsZSB0byBtYXJrZG93blxyXG4gICAgICogQHBhcmFtIHtFbGVjdHJvbi5JcGNNYWluSW52b2tlRXZlbnR9IGV2ZW50IC0gSVBDIGV2ZW50XHJcbiAgICAgKiBAcGFyYW0ge09iamVjdH0gcmVxdWVzdCAtIENvbnZlcnNpb24gcmVxdWVzdFxyXG4gICAgICogQHJldHVybnMge1Byb21pc2U8T2JqZWN0Pn0gQ29udmVyc2lvbiByZXN1bHRcclxuICAgICAqL1xyXG4gICAgYXN5bmMgY29udmVydFBkZihldmVudCwgeyBmaWxlUGF0aCwgb3B0aW9ucyA9IHt9IH0pIHtcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICBjb25zb2xlLmxvZygnW1BkZkNvbnZlcnRlckZhY3RvcnldIENvbnZlcnRpbmcgUERGIHdpdGggb3B0aW9uczonLCB7XHJcbiAgICAgICAgICAgICAgICB1c2VPY3I6IG9wdGlvbnMudXNlT2NyLFxyXG4gICAgICAgICAgICAgICAgaGFzTWlzdHJhbEFwaUtleTogISFvcHRpb25zLm1pc3RyYWxBcGlLZXksXHJcbiAgICAgICAgICAgICAgICBmb3JjZU9jcjogb3B0aW9ucy5mb3JjZU9jcixcclxuICAgICAgICAgICAgICAgIGZvcmNlU3RhbmRhcmQ6IG9wdGlvbnMuZm9yY2VTdGFuZGFyZFxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIC8vIElmIE1pc3RyYWwgQVBJIGtleSBpcyBwcm92aWRlZCBpbiBvcHRpb25zLCBzZXQgaXQgb24gdGhlIGNvbnZlcnRlclxyXG4gICAgICAgICAgICBpZiAob3B0aW9ucy5taXN0cmFsQXBpS2V5ICYmIHRoaXMubWlzdHJhbENvbnZlcnRlcikge1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ1tQZGZDb252ZXJ0ZXJGYWN0b3J5XSBTZXR0aW5nIE1pc3RyYWwgQVBJIGtleSBmcm9tIG9wdGlvbnMnKTtcclxuICAgICAgICAgICAgICAgIHRoaXMubWlzdHJhbENvbnZlcnRlci5zZXRBcGlLZXkob3B0aW9ucy5taXN0cmFsQXBpS2V5KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgY29uc3QgY29udmVydGVyID0gYXdhaXQgdGhpcy5nZXRDb252ZXJ0ZXIoZmlsZVBhdGgsIG9wdGlvbnMpO1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgLy8gTG9nIHdoaWNoIGNvbnZlcnRlciB3ZSdyZSB1c2luZ1xyXG4gICAgICAgICAgICBjb25zb2xlLmxvZyhgW1BkZkNvbnZlcnRlckZhY3RvcnldIFVzaW5nIGNvbnZlcnRlcjogJHtjb252ZXJ0ZXIubmFtZX1gKTtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIC8vIFVzZSB0aGUgYXBwcm9wcmlhdGUgY29udmVyc2lvbiBtZXRob2RcclxuICAgICAgICAgICAgcmV0dXJuIGF3YWl0IGNvbnZlcnRlci5oYW5kbGVDb252ZXJ0KGV2ZW50LCB7IGZpbGVQYXRoLCBvcHRpb25zIH0pO1xyXG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ1tQZGZDb252ZXJ0ZXJGYWN0b3J5XSBDb252ZXJzaW9uIGZhaWxlZDonLCBlcnJvcik7XHJcbiAgICAgICAgICAgIHRocm93IGVycm9yO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIEdldCBQREYgbWV0YWRhdGFcclxuICAgICAqIEBwYXJhbSB7RWxlY3Ryb24uSXBjTWFpbkludm9rZUV2ZW50fSBldmVudCAtIElQQyBldmVudFxyXG4gICAgICogQHBhcmFtIHtPYmplY3R9IHJlcXVlc3QgLSBNZXRhZGF0YSByZXF1ZXN0XHJcbiAgICAgKiBAcmV0dXJucyB7UHJvbWlzZTxPYmplY3Q+fSBQREYgbWV0YWRhdGFcclxuICAgICAqL1xyXG4gICAgYXN5bmMgZ2V0UGRmTWV0YWRhdGEoZXZlbnQsIHsgZmlsZVBhdGggfSkge1xyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIC8vIEZvciBtZXRhZGF0YSwgd2UgY2FuIGFsd2F5cyB1c2UgdGhlIHN0YW5kYXJkIGNvbnZlcnRlclxyXG4gICAgICAgICAgICByZXR1cm4gYXdhaXQgdGhpcy5zdGFuZGFyZENvbnZlcnRlci5oYW5kbGVHZXRNZXRhZGF0YShldmVudCwgeyBmaWxlUGF0aCB9KTtcclxuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKCdbUGRmQ29udmVydGVyRmFjdG9yeV0gRmFpbGVkIHRvIGdldCBtZXRhZGF0YTonLCBlcnJvcik7XHJcbiAgICAgICAgICAgIHRocm93IGVycm9yO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIENoZWNrIGlmIHRoaXMgZmFjdG9yeSBzdXBwb3J0cyB0aGUgZ2l2ZW4gZmlsZVxyXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IGZpbGVQYXRoIC0gUGF0aCB0byBmaWxlXHJcbiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gVHJ1ZSBpZiBzdXBwb3J0ZWRcclxuICAgICAqL1xyXG4gICAgc3VwcG9ydHNGaWxlKGZpbGVQYXRoKSB7XHJcbiAgICAgICAgY29uc3QgZXh0ID0gcGF0aC5leHRuYW1lKGZpbGVQYXRoKS50b0xvd2VyQ2FzZSgpO1xyXG4gICAgICAgIHJldHVybiB0aGlzLnN1cHBvcnRlZEV4dGVuc2lvbnMuaW5jbHVkZXMoZXh0KTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIEdldCBmYWN0b3J5IGluZm9ybWF0aW9uXHJcbiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBGYWN0b3J5IGRldGFpbHNcclxuICAgICAqL1xyXG4gICAgZ2V0SW5mbygpIHtcclxuICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICBuYW1lOiAnUERGIENvbnZlcnRlciBGYWN0b3J5JyxcclxuICAgICAgICAgICAgZXh0ZW5zaW9uczogdGhpcy5zdXBwb3J0ZWRFeHRlbnNpb25zLFxyXG4gICAgICAgICAgICBkZXNjcmlwdGlvbjogJ0ZhY3RvcnkgZm9yIFBERiBjb252ZXJ0ZXJzIHdpdGggYXV0b21hdGljIHNlbGVjdGlvbicsXHJcbiAgICAgICAgICAgIGNvbnZlcnRlcnM6IFtcclxuICAgICAgICAgICAgICAgIHRoaXMuc3RhbmRhcmRDb252ZXJ0ZXIuZ2V0SW5mbygpLFxyXG4gICAgICAgICAgICAgICAgdGhpcy5taXN0cmFsQ29udmVydGVyLmdldEluZm8oKVxyXG4gICAgICAgICAgICBdLFxyXG4gICAgICAgICAgICBvcHRpb25zOiB7XHJcbiAgICAgICAgICAgICAgICBmb3JjZU9jcjogJ0ZvcmNlIHVzZSBvZiBPQ1IgY29udmVydGVyJyxcclxuICAgICAgICAgICAgICAgIGZvcmNlU3RhbmRhcmQ6ICdGb3JjZSB1c2Ugb2Ygc3RhbmRhcmQgY29udmVydGVyJ1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfTtcclxuICAgIH1cclxufVxyXG5cclxubW9kdWxlLmV4cG9ydHMgPSBQZGZDb252ZXJ0ZXJGYWN0b3J5OyJdLCJtYXBwaW5ncyI6Ijs7QUFBQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQSxNQUFNQSxJQUFJLEdBQUdDLE9BQU8sQ0FBQyxNQUFNLENBQUM7QUFDNUIsTUFBTUMsRUFBRSxHQUFHRCxPQUFPLENBQUMsVUFBVSxDQUFDO0FBQzlCLE1BQU1FLG9CQUFvQixHQUFHRixPQUFPLENBQUMsd0JBQXdCLENBQUM7QUFDOUQsTUFBTUcsbUJBQW1CLEdBQUdILE9BQU8sQ0FBQyx1QkFBdUIsQ0FBQztBQUU1RCxNQUFNSSxtQkFBbUIsQ0FBQztFQUN0QkMsV0FBV0EsQ0FBQ0MsYUFBYSxFQUFFQyxXQUFXLEVBQUU7SUFDcEMsSUFBSSxDQUFDRCxhQUFhLEdBQUdBLGFBQWE7SUFDbEMsSUFBSSxDQUFDQyxXQUFXLEdBQUdBLFdBQVc7SUFDOUIsSUFBSSxDQUFDQyxtQkFBbUIsR0FBRyxDQUFDLE1BQU0sQ0FBQzs7SUFFbkM7SUFDQTtJQUNBLElBQUksQ0FBQ0MsaUJBQWlCLEdBQUcsSUFBSVAsb0JBQW9CLENBQUNJLGFBQWEsRUFBRUMsV0FBVyxFQUFFLElBQUks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