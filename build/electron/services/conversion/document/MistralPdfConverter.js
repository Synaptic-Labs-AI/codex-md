"use strict";

/**
 * MistralPdfConverter.js
 * Handles conversion of PDF files to markdown using Mistral OCR.
 * 
 * This converter:
 * - Uses Mistral AI for OCR processing of PDF documents
 * - Handles scanned documents and images within PDFs
 * - Extracts text that standard PDF parsers might miss
 * - Creates structured markdown with high-quality text extraction
 * 
 * Related Files:
 * - BasePdfConverter.js: Parent class with common PDF functionality
 * - StandardPdfConverter.js: Alternative text-based converter
 * - FileStorageService.js: For temporary file management
 * - PdfConverterFactory.js: Factory for selecting appropriate converter
 */

const path = require('path');
const fs = require('fs-extra');
const BasePdfConverter = require('./BasePdfConverter');
const mistral = require('./mistral');
class MistralPdfConverter extends BasePdfConverter {
  constructor(fileProcessor, fileStorage, unusedParam, skipHandlerSetup = false) {
    super(fileProcessor, fileStorage);
    this.name = 'Mistral PDF Converter';
    this.description = 'Converts PDF files to markdown using Mistral OCR';
    this.skipHandlerSetup = skipHandlerSetup;

    // Initialize modular components
    this.apiClient = new mistral.MistralApiClient({
      apiEndpoint: process.env.MISTRAL_API_ENDPOINT,
      apiKey: process.env.MISTRAL_API_KEY
    });
    this.ocrProcessor = new mistral.OcrProcessor();
    this.markdownGenerator = new mistral.MarkdownGenerator();
    this.conversionManager = new mistral.ConversionManager({
      fileProcessor,
      fileStorage
    });

    // Set the API key in the conversion manager
    this.conversionManager.setApiKey(process.env.MISTRAL_API_KEY);

    // Log whether handlers will be set up
    if (skipHandlerSetup) {
      console.log('[MistralPdfConverter] Skipping handler setup (skipHandlerSetup=true)');
    } else {
      this.setupIpcHandlers();
    }
  }

  /**
   * Set up IPC handlers for PDF conversion
   */
  setupIpcHandlers() {
    console.log('[MistralPdfConverter] Setting up IPC handlers');
    this.registerHandler('convert:pdf:ocr', this.handleConvert.bind(this));
    this.registerHandler('convert:pdf:ocr:metadata', this.handleGetMetadata.bind(this));
    this.registerHandler('convert:pdf:ocr:check', this.handleCheckApiKey.bind(this));
    console.log('[MistralPdfConverter] IPC handlers registered');
  }

  /**
   * Set API key for Mistral API
   * @param {string} apiKey - API key
   */
  setApiKey(apiKey) {
    this.apiClient.setApiKey(apiKey);
    this.conversionManager.setApiKey(apiKey);
  }

  /**
   * Get the API key
   * @returns {string|null} API key or null if not set
   */
  get apiKey() {
    return this.apiClient.apiKey;
  }

  /**
   * Handle PDF conversion request
   * @param {Electron.IpcMainInvokeEvent} event - IPC event
   * @param {Object} request - Conversion request details
   */
  async handleConvert(event, {
    filePath,
    options = {}
  }) {
    try {
      console.log('[MistralPdfConverter] handleConvert called with options:', {
        hasApiKey: !!this.apiClient.apiKey,
        hasOptionsApiKey: !!options.mistralApiKey,
        fileName: options.name || path.basename(filePath)
      });

      // Use API key from options if available
      if (options.mistralApiKey) {
        console.log('[MistralPdfConverter] Using API key from options');
        this.setApiKey(options.mistralApiKey);
      }

      // Start the conversion using the ConversionManager
      return await this.conversionManager.startConversion({
        filePath,
        options,
        window: event.sender.getOwnerBrowserWindow()
      });
    } catch (error) {
      console.error('[MistralPdfConverter] Failed to start conversion:', error);
      throw error;
    }
  }

  /**
   * Handle PDF metadata request
   * @param {Electron.IpcMainInvokeEvent} event - IPC event
   * @param {Object} request - Metadata request details
   */
  async handleGetMetadata(event, {
    filePath
  }) {
    try {
      // For metadata, we can use the standard PDF parser
      const standardConverter = new (require('./StandardPdfConverter'))(this.fileProcessor, this.fileStorage);
      const metadata = await standardConverter.extractMetadata(filePath);
      return metadata;
    } catch (error) {
      console.error('[MistralPdfConverter] Failed to get metadata:', error);
      throw error;
    }
  }

  /**
   * Handle API key check request
   * @param {Electron.IpcMainInvokeEvent} event - IPC event
   * @param {Object} options - Options including API key
   */
  async handleCheckApiKey(event, options = {}) {
    try {
      // If API key provided in options, use it for the check
      const apiKey = options?.apiKey || this.apiClient.apiKey;
      return await this.conversionManager.checkApiKey(apiKey);
    } catch (error) {
      console.error('[MistralPdfConverter] API key check failed:', error);
      return {
        valid: false,
        error: error.message
      };
    }
  }

  /**
   * Convert PDF content to markdown - direct method for ConverterRegistry
   * @param {Buffer} content - PDF content as buffer
   * @param {Object} options - Conversion options
   * @returns {Promise<Object>} Conversion result
   */
  async convertToMarkdown(content, options = {}) {
    try {
      console.log(`[MistralPdfConverter] Converting PDF with OCR: ${options.name || 'unnamed'}`);

      // Use API key from options if provided
      if (options.apiKey || options.mistralApiKey) {
        const apiKey = options.apiKey || options.mistralApiKey;
        this.setApiKey(apiKey);
      }

      // Use the ConversionManager to handle the actual conversion
      return await this.conversionManager.convertToMarkdown(content, options);
    } catch (error) {
      console.error('[MistralPdfConverter] Direct conversion failed:', error);

      // Create a more detailed error message
      const errorDetails = error.response ? `API response: ${JSON.stringify(error.response.data || {})}` : error.message;
      return {
        success: false,
        error: `PDF OCR conversion failed: ${error.message}`,
        errorDetails: errorDetails,
        content: `# Conversion Error\n\nFailed to convert PDF with OCR: ${error.message}\n\n## Error Details\n\n${errorDetails}`
      };
    }
  }

  /**
   * Get converter information
   * @returns {Object} Converter details
   */
  getInfo() {
    return {
      name: this.name,
      extensions: this.supportedExtensions,
      description: this.description,
      options: {
        title: 'Optional document title',
        model: 'OCR model to use (default: mistral-ocr-latest)',
        language: 'Language hint for OCR (optional)',
        maxPages: 'Maximum pages to convert (default: all)'
      }
    };
  }
}
module.exports = MistralPdfConverter;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJwYXRoIiwicmVxdWlyZSIsImZzIiwiQmFzZVBkZkNvbnZlcnRlciIsIm1pc3RyYWwiLCJNaXN0cmFsUGRmQ29udmVydGVyIiwiY29uc3RydWN0b3IiLCJmaWxlUHJvY2Vzc29yIiwiZmlsZVN0b3JhZ2UiLCJ1bnVzZWRQYXJhbSIsInNraXBIYW5kbGVyU2V0dXAiLCJuYW1lIiwiZGVzY3JpcHRpb24iLCJhcGlDbGllbnQiLCJNaXN0cmFsQXBpQ2xpZW50IiwiYXBpRW5kcG9pbnQiLCJwcm9jZXNzIiwiZW52IiwiTUlTVFJBTF9BUElfRU5EUE9JTlQiLCJhcGlLZXkiLCJNSVNUUkFMX0FQSV9LRVkiLCJvY3JQcm9jZXNzb3IiLCJPY3JQcm9jZXNzb3IiLCJtYXJrZG93bkdlbmVyYXRvciIsIk1hcmtkb3duR2VuZXJhdG9yIiwiY29udmVyc2lvbk1hbmFnZXIiLCJDb252ZXJzaW9uTWFuYWdlciIsInNldEFwaUtleSIsImNvbnNvbGUiLCJsb2ciLCJzZXR1cElwY0hhbmRsZXJzIiwicmVnaXN0ZXJIYW5kbGVyIiwiaGFuZGxlQ29udmVydCIsImJpbmQiLCJoYW5kbGVHZXRNZXRhZGF0YSIsImhhbmRsZUNoZWNrQXBpS2V5IiwiZXZlbnQiLCJmaWxlUGF0aCIsIm9wdGlvbnMiLCJoYXNBcGlLZXkiLCJoYXNPcHRpb25zQXBpS2V5IiwibWlzdHJhbEFwaUtleSIsImZpbGVOYW1lIiwiYmFzZW5hbWUiLCJzdGFydENvbnZlcnNpb24iLCJ3aW5kb3ciLCJzZW5kZXIiLCJnZXRPd25lckJyb3dzZXJXaW5kb3ciLCJlcnJvciIsInN0YW5kYXJkQ29udmVydGVyIiwibWV0YWRhdGEiLCJleHRyYWN0TWV0YWRhdGEiLCJjaGVja0FwaUtleSIsInZhbGlkIiwibWVzc2FnZSIsImNvbnZlcnRUb01hcmtkb3duIiwiY29udGVudCIsImVycm9yRGV0YWlscyIsInJlc3BvbnNlIiwiSlNPTiIsInN0cmluZ2lmeSIsImRhdGEiLCJzdWNjZXNzIiwiZ2V0SW5mbyIsImV4dGVuc2lvbnMiLCJzdXBwb3J0ZWRFeHRlbnNpb25zIiwidGl0bGUiLCJtb2RlbCIsImxhbmd1YWdlIiwibWF4UGFnZXMiLCJtb2R1bGUiLCJleHBvcnRzIl0sInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vc3JjL2VsZWN0cm9uL3NlcnZpY2VzL2NvbnZlcnNpb24vZG9jdW1lbnQvTWlzdHJhbFBkZkNvbnZlcnRlci5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcclxuICogTWlzdHJhbFBkZkNvbnZlcnRlci5qc1xyXG4gKiBIYW5kbGVzIGNvbnZlcnNpb24gb2YgUERGIGZpbGVzIHRvIG1hcmtkb3duIHVzaW5nIE1pc3RyYWwgT0NSLlxyXG4gKiBcclxuICogVGhpcyBjb252ZXJ0ZXI6XHJcbiAqIC0gVXNlcyBNaXN0cmFsIEFJIGZvciBPQ1IgcHJvY2Vzc2luZyBvZiBQREYgZG9jdW1lbnRzXHJcbiAqIC0gSGFuZGxlcyBzY2FubmVkIGRvY3VtZW50cyBhbmQgaW1hZ2VzIHdpdGhpbiBQREZzXHJcbiAqIC0gRXh0cmFjdHMgdGV4dCB0aGF0IHN0YW5kYXJkIFBERiBwYXJzZXJzIG1pZ2h0IG1pc3NcclxuICogLSBDcmVhdGVzIHN0cnVjdHVyZWQgbWFya2Rvd24gd2l0aCBoaWdoLXF1YWxpdHkgdGV4dCBleHRyYWN0aW9uXHJcbiAqIFxyXG4gKiBSZWxhdGVkIEZpbGVzOlxyXG4gKiAtIEJhc2VQZGZDb252ZXJ0ZXIuanM6IFBhcmVudCBjbGFzcyB3aXRoIGNvbW1vbiBQREYgZnVuY3Rpb25hbGl0eVxyXG4gKiAtIFN0YW5kYXJkUGRmQ29udmVydGVyLmpzOiBBbHRlcm5hdGl2ZSB0ZXh0LWJhc2VkIGNvbnZlcnRlclxyXG4gKiAtIEZpbGVTdG9yYWdlU2VydmljZS5qczogRm9yIHRlbXBvcmFyeSBmaWxlIG1hbmFnZW1lbnRcclxuICogLSBQZGZDb252ZXJ0ZXJGYWN0b3J5LmpzOiBGYWN0b3J5IGZvciBzZWxlY3RpbmcgYXBwcm9wcmlhdGUgY29udmVydGVyXHJcbiAqL1xyXG5cclxuY29uc3QgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKTtcclxuY29uc3QgZnMgPSByZXF1aXJlKCdmcy1leHRyYScpO1xyXG5jb25zdCBCYXNlUGRmQ29udmVydGVyID0gcmVxdWlyZSgnLi9CYXNlUGRmQ29udmVydGVyJyk7XHJcbmNvbnN0IG1pc3RyYWwgPSByZXF1aXJlKCcuL21pc3RyYWwnKTtcclxuXHJcbmNsYXNzIE1pc3RyYWxQZGZDb252ZXJ0ZXIgZXh0ZW5kcyBCYXNlUGRmQ29udmVydGVyIHtcclxuICBjb25zdHJ1Y3RvcihmaWxlUHJvY2Vzc29yLCBmaWxlU3RvcmFnZSwgdW51c2VkUGFyYW0sIHNraXBIYW5kbGVyU2V0dXAgPSBmYWxzZSkge1xyXG4gICAgc3VwZXIoZmlsZVByb2Nlc3NvciwgZmlsZVN0b3JhZ2UpO1xyXG4gICAgdGhpcy5uYW1lID0gJ01pc3RyYWwgUERGIENvbnZlcnRlcic7XHJcbiAgICB0aGlzLmRlc2NyaXB0aW9uID0gJ0NvbnZlcnRzIFBERiBmaWxlcyB0byBtYXJrZG93biB1c2luZyBNaXN0cmFsIE9DUic7XHJcbiAgICB0aGlzLnNraXBIYW5kbGVyU2V0dXAgPSBza2lwSGFuZGxlclNldHVwO1xyXG4gICAgXHJcbiAgICAvLyBJbml0aWFsaXplIG1vZHVsYXIgY29tcG9uZW50c1xyXG4gICAgdGhpcy5hcGlDbGllbnQgPSBuZXcgbWlzdHJhbC5NaXN0cmFsQXBpQ2xpZW50KHtcclxuICAgICAgYXBpRW5kcG9pbnQ6IHByb2Nlc3MuZW52Lk1JU1RSQUxfQVBJX0VORFBPSU5ULFxyXG4gICAgICBhcGlLZXk6IHByb2Nlc3MuZW52Lk1JU1RSQUxfQVBJX0tFWVxyXG4gICAgfSk7XHJcbiAgICBcclxuICAgIHRoaXMub2NyUHJvY2Vzc29yID0gbmV3IG1pc3RyYWwuT2NyUHJvY2Vzc29yKCk7XHJcbiAgICB0aGlzLm1hcmtkb3duR2VuZXJhdG9yID0gbmV3IG1pc3RyYWwuTWFya2Rvd25HZW5lcmF0b3IoKTtcclxuICAgIHRoaXMuY29udmVyc2lvbk1hbmFnZXIgPSBuZXcgbWlzdHJhbC5Db252ZXJzaW9uTWFuYWdlcih7XHJcbiAgICAgIGZpbGVQcm9jZXNzb3IsXHJcbiAgICAgIGZpbGVTdG9yYWdlXHJcbiAgICB9KTtcclxuICAgIFxyXG4gICAgLy8gU2V0IHRoZSBBUEkga2V5IGluIHRoZSBjb252ZXJzaW9uIG1hbmFnZXJcclxuICAgIHRoaXMuY29udmVyc2lvbk1hbmFnZXIuc2V0QXBpS2V5KHByb2Nlc3MuZW52Lk1JU1RSQUxfQVBJX0tFWSk7XHJcbiAgICBcclxuICAgIC8vIExvZyB3aGV0aGVyIGhhbmRsZXJzIHdpbGwgYmUgc2V0IHVwXHJcbiAgICBpZiAoc2tpcEhhbmRsZXJTZXR1cCkge1xyXG4gICAgICBjb25zb2xlLmxvZygnW01pc3RyYWxQZGZDb252ZXJ0ZXJdIFNraXBwaW5nIGhhbmRsZXIgc2V0dXAgKHNraXBIYW5kbGVyU2V0dXA9dHJ1ZSknKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHRoaXMuc2V0dXBJcGNIYW5kbGVycygpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogU2V0IHVwIElQQyBoYW5kbGVycyBmb3IgUERGIGNvbnZlcnNpb25cclxuICAgKi9cclxuICBzZXR1cElwY0hhbmRsZXJzKCkge1xyXG4gICAgY29uc29sZS5sb2coJ1tNaXN0cmFsUGRmQ29udmVydGVyXSBTZXR0aW5nIHVwIElQQyBoYW5kbGVycycpO1xyXG4gICAgdGhpcy5yZWdpc3RlckhhbmRsZXIoJ2NvbnZlcnQ6cGRmOm9jcicsIHRoaXMuaGFuZGxlQ29udmVydC5iaW5kKHRoaXMpKTtcclxuICAgIHRoaXMucmVnaXN0ZXJIYW5kbGVyKCdjb252ZXJ0OnBkZjpvY3I6bWV0YWRhdGEnLCB0aGlzLmhhbmRsZUdldE1ldGFkYXRhLmJpbmQodGhpcykpO1xyXG4gICAgdGhpcy5yZWdpc3RlckhhbmRsZXIoJ2NvbnZlcnQ6cGRmOm9jcjpjaGVjaycsIHRoaXMuaGFuZGxlQ2hlY2tBcGlLZXkuYmluZCh0aGlzKSk7XHJcbiAgICBjb25zb2xlLmxvZygnW01pc3RyYWxQZGZDb252ZXJ0ZXJdIElQQyBoYW5kbGVycyByZWdpc3RlcmVkJyk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBTZXQgQVBJIGtleSBmb3IgTWlzdHJhbCBBUElcclxuICAgKiBAcGFyYW0ge3N0cmluZ30gYXBpS2V5IC0gQVBJIGtleVxyXG4gICAqL1xyXG4gIHNldEFwaUtleShhcGlLZXkpIHtcclxuICAgIHRoaXMuYXBpQ2xpZW50LnNldEFwaUtleShhcGlLZXkpO1xyXG4gICAgdGhpcy5jb252ZXJzaW9uTWFuYWdlci5zZXRBcGlLZXkoYXBpS2V5KTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEdldCB0aGUgQVBJIGtleVxyXG4gICAqIEByZXR1cm5zIHtzdHJpbmd8bnVsbH0gQVBJIGtleSBvciBudWxsIGlmIG5vdCBzZXRcclxuICAgKi9cclxuICBnZXQgYXBpS2V5KCkge1xyXG4gICAgcmV0dXJuIHRoaXMuYXBpQ2xpZW50LmFwaUtleTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEhhbmRsZSBQREYgY29udmVyc2lvbiByZXF1ZXN0XHJcbiAgICogQHBhcmFtIHtFbGVjdHJvbi5JcGNNYWluSW52b2tlRXZlbnR9IGV2ZW50IC0gSVBDIGV2ZW50XHJcbiAgICogQHBhcmFtIHtPYmplY3R9IHJlcXVlc3QgLSBDb252ZXJzaW9uIHJlcXVlc3QgZGV0YWlsc1xyXG4gICAqL1xyXG4gIGFzeW5jIGhhbmRsZUNvbnZlcnQoZXZlbnQsIHsgZmlsZVBhdGgsIG9wdGlvbnMgPSB7fSB9KSB7XHJcbiAgICB0cnkge1xyXG4gICAgICBjb25zb2xlLmxvZygnW01pc3RyYWxQZGZDb252ZXJ0ZXJdIGhhbmRsZUNvbnZlcnQgY2FsbGVkIHdpdGggb3B0aW9uczonLCB7XHJcbiAgICAgICAgaGFzQXBpS2V5OiAhIXRoaXMuYXBpQ2xpZW50LmFwaUtleSxcclxuICAgICAgICBoYXNPcHRpb25zQXBpS2V5OiAhIW9wdGlvbnMubWlzdHJhbEFwaUtleSxcclxuICAgICAgICBmaWxlTmFtZTogb3B0aW9ucy5uYW1lIHx8IHBhdGguYmFzZW5hbWUoZmlsZVBhdGgpXHJcbiAgICAgIH0pO1xyXG4gICAgICBcclxuICAgICAgLy8gVXNlIEFQSSBrZXkgZnJvbSBvcHRpb25zIGlmIGF2YWlsYWJsZVxyXG4gICAgICBpZiAob3B0aW9ucy5taXN0cmFsQXBpS2V5KSB7XHJcbiAgICAgICAgY29uc29sZS5sb2coJ1tNaXN0cmFsUGRmQ29udmVydGVyXSBVc2luZyBBUEkga2V5IGZyb20gb3B0aW9ucycpO1xyXG4gICAgICAgIHRoaXMuc2V0QXBpS2V5KG9wdGlvbnMubWlzdHJhbEFwaUtleSk7XHJcbiAgICAgIH1cclxuICAgICAgXHJcbiAgICAgIC8vIFN0YXJ0IHRoZSBjb252ZXJzaW9uIHVzaW5nIHRoZSBDb252ZXJzaW9uTWFuYWdlclxyXG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5jb252ZXJzaW9uTWFuYWdlci5zdGFydENvbnZlcnNpb24oe1xyXG4gICAgICAgIGZpbGVQYXRoLFxyXG4gICAgICAgIG9wdGlvbnMsXHJcbiAgICAgICAgd2luZG93OiBldmVudC5zZW5kZXIuZ2V0T3duZXJCcm93c2VyV2luZG93KClcclxuICAgICAgfSk7XHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICBjb25zb2xlLmVycm9yKCdbTWlzdHJhbFBkZkNvbnZlcnRlcl0gRmFpbGVkIHRvIHN0YXJ0IGNvbnZlcnNpb246JywgZXJyb3IpO1xyXG4gICAgICB0aHJvdyBlcnJvcjtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEhhbmRsZSBQREYgbWV0YWRhdGEgcmVxdWVzdFxyXG4gICAqIEBwYXJhbSB7RWxlY3Ryb24uSXBjTWFpbkludm9rZUV2ZW50fSBldmVudCAtIElQQyBldmVudFxyXG4gICAqIEBwYXJhbSB7T2JqZWN0fSByZXF1ZXN0IC0gTWV0YWRhdGEgcmVxdWVzdCBkZXRhaWxzXHJcbiAgICovXHJcbiAgYXN5bmMgaGFuZGxlR2V0TWV0YWRhdGEoZXZlbnQsIHsgZmlsZVBhdGggfSkge1xyXG4gICAgdHJ5IHtcclxuICAgICAgLy8gRm9yIG1ldGFkYXRhLCB3ZSBjYW4gdXNlIHRoZSBzdGFuZGFyZCBQREYgcGFyc2VyXHJcbiAgICAgIGNvbnN0IHN0YW5kYXJkQ29udmVydGVyID0gbmV3IChyZXF1aXJlKCcuL1N0YW5kYXJkUGRmQ29udmVydGVyJykpKFxyXG4gICAgICAgIHRoaXMuZmlsZVByb2Nlc3NvcixcclxuICAgICAgICB0aGlzLmZpbGVTdG9yYWdlXHJcbiAgICAgICk7XHJcbiAgICAgIFxyXG4gICAgICBjb25zdCBtZXRhZGF0YSA9IGF3YWl0IHN0YW5kYXJkQ29udmVydGVyLmV4dHJhY3RNZXRhZGF0YShmaWxlUGF0aCk7XHJcbiAgICAgIHJldHVybiBtZXRhZGF0YTtcclxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ1tNaXN0cmFsUGRmQ29udmVydGVyXSBGYWlsZWQgdG8gZ2V0IG1ldGFkYXRhOicsIGVycm9yKTtcclxuICAgICAgdGhyb3cgZXJyb3I7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBIYW5kbGUgQVBJIGtleSBjaGVjayByZXF1ZXN0XHJcbiAgICogQHBhcmFtIHtFbGVjdHJvbi5JcGNNYWluSW52b2tlRXZlbnR9IGV2ZW50IC0gSVBDIGV2ZW50XHJcbiAgICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMgLSBPcHRpb25zIGluY2x1ZGluZyBBUEkga2V5XHJcbiAgICovXHJcbiAgYXN5bmMgaGFuZGxlQ2hlY2tBcGlLZXkoZXZlbnQsIG9wdGlvbnMgPSB7fSkge1xyXG4gICAgdHJ5IHtcclxuICAgICAgLy8gSWYgQVBJIGtleSBwcm92aWRlZCBpbiBvcHRpb25zLCB1c2UgaXQgZm9yIHRoZSBjaGVja1xyXG4gICAgICBjb25zdCBhcGlLZXkgPSBvcHRpb25zPy5hcGlLZXkgfHwgdGhpcy5hcGlDbGllbnQuYXBpS2V5O1xyXG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5jb252ZXJzaW9uTWFuYWdlci5jaGVja0FwaUtleShhcGlLZXkpO1xyXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgY29uc29sZS5lcnJvcignW01pc3RyYWxQZGZDb252ZXJ0ZXJdIEFQSSBrZXkgY2hlY2sgZmFpbGVkOicsIGVycm9yKTtcclxuICAgICAgcmV0dXJuIHsgdmFsaWQ6IGZhbHNlLCBlcnJvcjogZXJyb3IubWVzc2FnZSB9O1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQ29udmVydCBQREYgY29udGVudCB0byBtYXJrZG93biAtIGRpcmVjdCBtZXRob2QgZm9yIENvbnZlcnRlclJlZ2lzdHJ5XHJcbiAgICogQHBhcmFtIHtCdWZmZXJ9IGNvbnRlbnQgLSBQREYgY29udGVudCBhcyBidWZmZXJcclxuICAgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucyAtIENvbnZlcnNpb24gb3B0aW9uc1xyXG4gICAqIEByZXR1cm5zIHtQcm9taXNlPE9iamVjdD59IENvbnZlcnNpb24gcmVzdWx0XHJcbiAgICovXHJcbiAgYXN5bmMgY29udmVydFRvTWFya2Rvd24oY29udGVudCwgb3B0aW9ucyA9IHt9KSB7XHJcbiAgICB0cnkge1xyXG4gICAgICBjb25zb2xlLmxvZyhgW01pc3RyYWxQZGZDb252ZXJ0ZXJdIENvbnZlcnRpbmcgUERGIHdpdGggT0NSOiAke29wdGlvbnMubmFtZSB8fCAndW5uYW1lZCd9YCk7XHJcbiAgICAgIFxyXG4gICAgICAvLyBVc2UgQVBJIGtleSBmcm9tIG9wdGlvbnMgaWYgcHJvdmlkZWRcclxuICAgICAgaWYgKG9wdGlvbnMuYXBpS2V5IHx8IG9wdGlvbnMubWlzdHJhbEFwaUtleSkge1xyXG4gICAgICAgIGNvbnN0IGFwaUtleSA9IG9wdGlvbnMuYXBpS2V5IHx8IG9wdGlvbnMubWlzdHJhbEFwaUtleTtcclxuICAgICAgICB0aGlzLnNldEFwaUtleShhcGlLZXkpO1xyXG4gICAgICB9XHJcbiAgICAgIFxyXG4gICAgICAvLyBVc2UgdGhlIENvbnZlcnNpb25NYW5hZ2VyIHRvIGhhbmRsZSB0aGUgYWN0dWFsIGNvbnZlcnNpb25cclxuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuY29udmVyc2lvbk1hbmFnZXIuY29udmVydFRvTWFya2Rvd24oY29udGVudCwgb3B0aW9ucyk7XHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICBjb25zb2xlLmVycm9yKCdbTWlzdHJhbFBkZkNvbnZlcnRlcl0gRGlyZWN0IGNvbnZlcnNpb24gZmFpbGVkOicsIGVycm9yKTtcclxuICAgICAgXHJcbiAgICAgIC8vIENyZWF0ZSBhIG1vcmUgZGV0YWlsZWQgZXJyb3IgbWVzc2FnZVxyXG4gICAgICBjb25zdCBlcnJvckRldGFpbHMgPSBlcnJvci5yZXNwb25zZSA/XHJcbiAgICAgICAgYEFQSSByZXNwb25zZTogJHtKU09OLnN0cmluZ2lmeShlcnJvci5yZXNwb25zZS5kYXRhIHx8IHt9KX1gIDpcclxuICAgICAgICBlcnJvci5tZXNzYWdlO1xyXG4gICAgICBcclxuICAgICAgcmV0dXJuIHtcclxuICAgICAgICBzdWNjZXNzOiBmYWxzZSxcclxuICAgICAgICBlcnJvcjogYFBERiBPQ1IgY29udmVyc2lvbiBmYWlsZWQ6ICR7ZXJyb3IubWVzc2FnZX1gLFxyXG4gICAgICAgIGVycm9yRGV0YWlsczogZXJyb3JEZXRhaWxzLFxyXG4gICAgICAgIGNvbnRlbnQ6IGAjIENvbnZlcnNpb24gRXJyb3JcXG5cXG5GYWlsZWQgdG8gY29udmVydCBQREYgd2l0aCBPQ1I6ICR7ZXJyb3IubWVzc2FnZX1cXG5cXG4jIyBFcnJvciBEZXRhaWxzXFxuXFxuJHtlcnJvckRldGFpbHN9YFxyXG4gICAgICB9O1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogR2V0IGNvbnZlcnRlciBpbmZvcm1hdGlvblxyXG4gICAqIEByZXR1cm5zIHtPYmplY3R9IENvbnZlcnRlciBkZXRhaWxzXHJcbiAgICovXHJcbiAgZ2V0SW5mbygpIHtcclxuICAgIHJldHVybiB7XHJcbiAgICAgIG5hbWU6IHRoaXMubmFtZSxcclxuICAgICAgZXh0ZW5zaW9uczogdGhpcy5zdXBwb3J0ZWRFeHRlbnNpb25zLFxyXG4gICAgICBkZXNjcmlwdGlvbjogdGhpcy5kZXNjcmlwdGlvbixcclxuICAgICAgb3B0aW9uczoge1xyXG4gICAgICAgIHRpdGxlOiAnT3B0aW9uYWwgZG9jdW1lbnQgdGl0bGUnLFxyXG4gICAgICAgIG1vZGVsOiAnT0NSIG1vZGVsIHRvIHVzZSAoZGVmYXVsdDogbWlzdHJhbC1vY3ItbGF0ZXN0KScsXHJcbiAgICAgICAgbGFuZ3VhZ2U6ICdMYW5ndWFnZSBoaW50IGZvciBPQ1IgKG9wdGlvbmFsKScsXHJcbiAgICAgICAgbWF4UGFnZXM6ICdNYXhpbXVtIHBhZ2VzIHRvIGNvbnZlcnQgKGRlZmF1bHQ6IGFsbCknXHJcbiAgICAgIH1cclxuICAgIH07XHJcbiAgfVxyXG59XHJcblxyXG5tb2R1bGUuZXhwb3J0cyA9IE1pc3RyYWxQZGZDb252ZXJ0ZXI7Il0sIm1hcHBpbmdzIjoiOztBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBLE1BQU1BLElBQUksR0FBR0MsT0FBTyxDQUFDLE1BQU0sQ0FBQztBQUM1QixNQUFNQyxFQUFFLEdBQUdELE9BQU8sQ0FBQyxVQUFVLENBQUM7QUFDOUIsTUFBTUUsZ0JBQWdCLEdBQUdGLE9BQU8sQ0FBQyxvQkFBb0IsQ0FBQztBQUN0RCxNQUFNRyxPQUFPLEdBQUdILE9BQU8sQ0FBQyxXQUFXLENBQUM7QUFFcEMsTUFBTUksbUJBQW1CLFNBQVNGLGdCQUFnQixDQUFDO0VBQ2pERyxXQUFXQSxDQUFDQyxhQUFhLEVBQUVDLFdBQVcsRUFBRUMsV0FBVyxFQUFFQyxnQkFBZ0IsR0FBRyxLQUFLLEVBQUU7SUFDN0UsS0FBSyxDQUFDSCxhQUFhLEVBQUVDLFdBQVcsQ0FBQztJQUNqQyxJQUFJLENBQUNHLElBQUksR0FBRyx1QkFB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