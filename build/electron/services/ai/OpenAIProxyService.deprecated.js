"use strict";

/**
 * OpenAIProxyService.js
 * Manages OpenAI API interactions in the Electron main process.
 * 
 * This service handles:
 * - API key management
 * - Rate limiting and quotas
 * - OpenAI API requests and responses
 * - Response caching for efficiency
 * 
 * Related Files:
 * - BaseService.js: Parent class providing IPC handling
 * - ApiKeyService.js: For API key management
 * - TranscriptionService.js: Uses this service for audio transcription
 */

const BaseService = require('../BaseService');
const OpenAI = require('openai');
const NodeCache = require('node-cache');
const axios = require('axios');
const fs = require('fs-extra');
const axiosRetry = require('./OpenAIProxyServiceFix');
class OpenAIProxyService extends BaseService {
  constructor() {
    super();
    this.openai = null;
    this.cache = new NodeCache({
      stdTTL: 3600
    }); // 1 hour cache
    this.setupAxiosRetry();
  }

  /**
   * Set up IPC handlers for OpenAI operations
   */
  setupIpcHandlers() {
    this.registerHandler('openai:configure', this.handleConfigure.bind(this));
    this.registerHandler('openai:transcribe', this.handleTranscribe.bind(this));
    this.registerHandler('openai:complete', this.handleComplete.bind(this));
    this.registerHandler('openai:check-key', this.handleCheckKey.bind(this));
  }

  /**
   * Configure axios retry behavior
   */
  setupAxiosRetry() {
    axiosRetry(axios, {
      retries: 3,
      retryDelay: axiosRetry.exponentialDelay,
      retryCondition: error => {
        return axiosRetry.isNetworkOrIdempotentRequestError(error) || error.response && error.response.status === 429; // Rate limit
      }
    });
  }

  /**
   * Handle API configuration request
   * @param {Electron.IpcMainInvokeEvent} event - IPC event
   * @param {Object} request - Configuration details
   */
  async handleConfigure(event, {
    apiKey
  }) {
    try {
      // Instantiate directly with v4 syntax
      const tempOpenAI = new OpenAI({
        apiKey
      });

      // Verify the API key with a v4 style request
      await tempOpenAI.models.list();

      // If successful, update the instance
      this.openai = tempOpenAI;
      return {
        success: true
      };
    } catch (error) {
      console.error('[OpenAIProxyService] Configuration failed:', error.message);
      throw new Error('Invalid API key or connection failed');
    }
  }

  /**
   * Handle transcription request
   * @param {Electron.IpcMainInvokeEvent} event - IPC event
   * @param {Object} request - Transcription details
   */
  async handleTranscribe(event, {
    audioPath,
    language = 'en',
    prompt = '',
    model = 'whisper'
  }) {
    this.ensureConfigured();
    try {
      const cacheKey = `transcribe:${audioPath}:${model}`;
      const cached = this.cache.get(cacheKey);
      if (cached) {
        return cached;
      }

      // Map our simplified model names to actual API model names
      const modelMapping = {
        'whisper': 'whisper-1',
        'gpt-4o-mini-transcribe': 'gpt-4o-mini-transcribe',
        'gpt-4o-transcribe': 'gpt-4o-transcribe'
      };
      const apiModel = modelMapping[model] || 'whisper-1';
      console.log(`[OpenAIProxyService] Using transcription model: ${apiModel} (from ${model})`);
      const response = await this.openai.audio.transcriptions.create({
        file: fs.createReadStream(audioPath),
        model: apiModel,
        prompt: prompt,
        response_format: 'text',
        language: language
      });
      const result = {
        text: response.text || response,
        // Handle both object and direct text response
        language: language,
        model: model
      };
      this.cache.set(cacheKey, result);
      return result;
    } catch (error) {
      console.error('[OpenAIProxyService] Transcription failed:', error);
      throw this.formatError(error);
    }
  }

  /**
   * Handle completion request
   * @param {Electron.IpcMainInvokeEvent} event - IPC event
   * @param {Object} request - Completion details
   */
  async handleComplete(event, {
    prompt,
    model = 'gpt-3.5-turbo',
    options = {}
  }) {
    this.ensureConfigured();
    try {
      const cacheKey = `complete:${model}:${prompt}`;
      const cached = this.cache.get(cacheKey);
      if (cached) {
        return cached;
      }
      const response = await this.openai.chat.completions.create({
        model,
        messages: [{
          role: 'user',
          content: prompt
        }],
        ...options
      });
      const result = {
        text: response.choices[0].message.content,
        usage: response.usage
      };
      this.cache.set(cacheKey, result);
      return result;
    } catch (error) {
      console.error('[OpenAIProxyService] Completion failed:', error);
      throw this.formatError(error);
    }
  }

  /**
   * Handle API key check request
   * @param {Electron.IpcMainInvokeEvent} event - IPC event
   */
  async handleCheckKey(event) {
    try {
      if (!this.openai) {
        return {
          valid: false,
          error: 'API not configured'
        };
      }
      await this.openai.models.list();
      return {
        valid: true
      };
    } catch (error) {
      console.error('[OpenAIProxyService] API key check failed:', error);
      return {
        valid: false,
        error: this.formatError(error).message
      };
    }
  }

  /**
   * Ensure the API is configured
   * @throws {Error} If API is not configured
   */
  ensureConfigured() {
    if (!this.openai) {
      throw new Error('OpenAI API not configured. Please set an API key.');
    }
  }

  /**
   * Format error for client consumption
   * @param {Error} error - Original error
   * @returns {Error} Formatted error
   */
  formatError(error) {
    if (error.response) {
      const status = error.response.status;
      const message = error.response.data.error?.message || error.message;
      if (status === 429) {
        return new Error('Rate limit exceeded. Please try again later.');
      }
      return new Error(`OpenAI API Error (${status}): ${message}`);
    }
    return error;
  }

  /**
   * Clear the response cache
   */
  clearCache() {
    this.cache.flushAll();
  }
}

// Create a single instance of the service
const instance = new OpenAIProxyService();

// Export an object containing the instance
module.exports = {
  instance
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJCYXNlU2VydmljZSIsInJlcXVpcmUiLCJPcGVuQUkiLCJOb2RlQ2FjaGUiLCJheGlvcyIsImZzIiwiYXhpb3NSZXRyeSIsIk9wZW5BSVByb3h5U2VydmljZSIsImNvbnN0cnVjdG9yIiwib3BlbmFpIiwiY2FjaGUiLCJzdGRUVEwiLCJzZXR1cEF4aW9zUmV0cnkiLCJzZXR1cElwY0hhbmRsZXJzIiwicmVnaXN0ZXJIYW5kbGVyIiwiaGFuZGxlQ29uZmlndXJlIiwiYmluZCIsImhhbmRsZVRyYW5zY3JpYmUiLCJoYW5kbGVDb21wbGV0ZSIsImhhbmRsZUNoZWNrS2V5IiwicmV0cmllcyIsInJldHJ5RGVsYXkiLCJleHBvbmVudGlhbERlbGF5IiwicmV0cnlDb25kaXRpb24iLCJlcnJvciIsImlzTmV0d29ya09ySWRlbXBvdGVudFJlcXVlc3RFcnJvciIsInJlc3BvbnNlIiwic3RhdHVzIiwiZXZlbnQiLCJhcGlLZXkiLCJ0ZW1wT3BlbkFJIiwibW9kZWxzIiwibGlzdCIsInN1Y2Nlc3MiLCJjb25zb2xlIiwibWVzc2FnZSIsIkVycm9yIiwiYXVkaW9QYXRoIiwibGFuZ3VhZ2UiLCJwcm9tcHQiLCJtb2RlbCIsImVuc3VyZUNvbmZpZ3VyZWQiLCJjYWNoZUtleSIsImNhY2hlZCIsImdldCIsIm1vZGVsTWFwcGluZyIsImFwaU1vZGVsIiwibG9nIiwiYXVkaW8iLCJ0cmFuc2NyaXB0aW9ucyIsImNyZWF0ZSIsImZpbGUiLCJjcmVhdGVSZWFkU3RyZWFtIiwicmVzcG9uc2VfZm9ybWF0IiwicmVzdWx0IiwidGV4dCIsInNldCIsImZvcm1hdEVycm9yIiwib3B0aW9ucyIsImNoYXQiLCJjb21wbGV0aW9ucyIsIm1lc3NhZ2VzIiwicm9sZSIsImNvbnRlbnQiLCJjaG9pY2VzIiwidXNhZ2UiLCJ2YWxpZCIsImRhdGEiLCJjbGVhckNhY2hlIiwiZmx1c2hBbGwiLCJpbnN0YW5jZSIsIm1vZHVsZSIsImV4cG9ydHMiXSwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvZWxlY3Ryb24vc2VydmljZXMvYWkvT3BlbkFJUHJveHlTZXJ2aWNlLmRlcHJlY2F0ZWQuanMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXHJcbiAqIE9wZW5BSVByb3h5U2VydmljZS5qc1xyXG4gKiBNYW5hZ2VzIE9wZW5BSSBBUEkgaW50ZXJhY3Rpb25zIGluIHRoZSBFbGVjdHJvbiBtYWluIHByb2Nlc3MuXHJcbiAqIFxyXG4gKiBUaGlzIHNlcnZpY2UgaGFuZGxlczpcclxuICogLSBBUEkga2V5IG1hbmFnZW1lbnRcclxuICogLSBSYXRlIGxpbWl0aW5nIGFuZCBxdW90YXNcclxuICogLSBPcGVuQUkgQVBJIHJlcXVlc3RzIGFuZCByZXNwb25zZXNcclxuICogLSBSZXNwb25zZSBjYWNoaW5nIGZvciBlZmZpY2llbmN5XHJcbiAqIFxyXG4gKiBSZWxhdGVkIEZpbGVzOlxyXG4gKiAtIEJhc2VTZXJ2aWNlLmpzOiBQYXJlbnQgY2xhc3MgcHJvdmlkaW5nIElQQyBoYW5kbGluZ1xyXG4gKiAtIEFwaUtleVNlcnZpY2UuanM6IEZvciBBUEkga2V5IG1hbmFnZW1lbnRcclxuICogLSBUcmFuc2NyaXB0aW9uU2VydmljZS5qczogVXNlcyB0aGlzIHNlcnZpY2UgZm9yIGF1ZGlvIHRyYW5zY3JpcHRpb25cclxuICovXHJcblxyXG5jb25zdCBCYXNlU2VydmljZSA9IHJlcXVpcmUoJy4uL0Jhc2VTZXJ2aWNlJyk7XHJcbmNvbnN0IE9wZW5BSSA9IHJlcXVpcmUoJ29wZW5haScpO1xyXG5jb25zdCBOb2RlQ2FjaGUgPSByZXF1aXJlKCdub2RlLWNhY2hlJyk7XHJcbmNvbnN0IGF4aW9zID0gcmVxdWlyZSgnYXhpb3MnKTtcclxuY29uc3QgZnMgPSByZXF1aXJlKCdmcy1leHRyYScpO1xyXG5jb25zdCBheGlvc1JldHJ5ID0gcmVxdWlyZSgnLi9PcGVuQUlQcm94eVNlcnZpY2VGaXgnKTtcclxuXHJcbmNsYXNzIE9wZW5BSVByb3h5U2VydmljZSBleHRlbmRzIEJhc2VTZXJ2aWNlIHtcclxuICAgIGNvbnN0cnVjdG9yKCkge1xyXG4gICAgICAgIHN1cGVyKCk7XHJcbiAgICAgICAgdGhpcy5vcGVuYWkgPSBudWxsO1xyXG4gICAgICAgIHRoaXMuY2FjaGUgPSBuZXcgTm9kZUNhY2hlKHsgc3RkVFRMOiAzNjAwIH0pOyAvLyAxIGhvdXIgY2FjaGVcclxuICAgICAgICB0aGlzLnNldHVwQXhpb3NSZXRyeSgpO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogU2V0IHVwIElQQyBoYW5kbGVycyBmb3IgT3BlbkFJIG9wZXJhdGlvbnNcclxuICAgICAqL1xyXG4gICAgc2V0dXBJcGNIYW5kbGVycygpIHtcclxuICAgICAgICB0aGlzLnJlZ2lzdGVySGFuZGxlcignb3BlbmFpOmNvbmZpZ3VyZScsIHRoaXMuaGFuZGxlQ29uZmlndXJlLmJpbmQodGhpcykpO1xyXG4gICAgICAgIHRoaXMucmVnaXN0ZXJIYW5kbGVyKCdvcGVuYWk6dHJhbnNjcmliZScsIHRoaXMuaGFuZGxlVHJhbnNjcmliZS5iaW5kKHRoaXMpKTtcclxuICAgICAgICB0aGlzLnJlZ2lzdGVySGFuZGxlcignb3BlbmFpOmNvbXBsZXRlJywgdGhpcy5oYW5kbGVDb21wbGV0ZS5iaW5kKHRoaXMpKTtcclxuICAgICAgICB0aGlzLnJlZ2lzdGVySGFuZGxlcignb3BlbmFpOmNoZWNrLWtleScsIHRoaXMuaGFuZGxlQ2hlY2tLZXkuYmluZCh0aGlzKSk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBDb25maWd1cmUgYXhpb3MgcmV0cnkgYmVoYXZpb3JcclxuICAgICAqL1xyXG4gICAgc2V0dXBBeGlvc1JldHJ5KCkge1xyXG4gICAgICAgIGF4aW9zUmV0cnkoYXhpb3MsIHtcclxuICAgICAgICAgICAgcmV0cmllczogMyxcclxuICAgICAgICAgICAgcmV0cnlEZWxheTogYXhpb3NSZXRyeS5leHBvbmVudGlhbERlbGF5LFxyXG4gICAgICAgICAgICByZXRyeUNvbmRpdGlvbjogKGVycm9yKSA9PiB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gYXhpb3NSZXRyeS5pc05ldHdvcmtPcklkZW1wb3RlbnRSZXF1ZXN0RXJyb3IoZXJyb3IpIHx8XHJcbiAgICAgICAgICAgICAgICAgICAgKGVycm9yLnJlc3BvbnNlICYmIGVycm9yLnJlc3BvbnNlLnN0YXR1cyA9PT0gNDI5KTsgLy8gUmF0ZSBsaW1pdFxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBIYW5kbGUgQVBJIGNvbmZpZ3VyYXRpb24gcmVxdWVzdFxyXG4gICAgICogQHBhcmFtIHtFbGVjdHJvbi5JcGNNYWluSW52b2tlRXZlbnR9IGV2ZW50IC0gSVBDIGV2ZW50XHJcbiAgICAgKiBAcGFyYW0ge09iamVjdH0gcmVxdWVzdCAtIENvbmZpZ3VyYXRpb24gZGV0YWlsc1xyXG4gICAgICovXHJcbiAgICBhc3luYyBoYW5kbGVDb25maWd1cmUoZXZlbnQsIHsgYXBpS2V5IH0pIHtcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICAvLyBJbnN0YW50aWF0ZSBkaXJlY3RseSB3aXRoIHY0IHN5bnRheFxyXG4gICAgICAgICAgICBjb25zdCB0ZW1wT3BlbkFJID0gbmV3IE9wZW5BSSh7IGFwaUtleSB9KTtcclxuXHJcbiAgICAgICAgICAgIC8vIFZlcmlmeSB0aGUgQVBJIGtleSB3aXRoIGEgdjQgc3R5bGUgcmVxdWVzdFxyXG4gICAgICAgICAgICBhd2FpdCB0ZW1wT3BlbkFJLm1vZGVscy5saXN0KCk7XHJcblxyXG4gICAgICAgICAgICAvLyBJZiBzdWNjZXNzZnVsLCB1cGRhdGUgdGhlIGluc3RhbmNlXHJcbiAgICAgICAgICAgIHRoaXMub3BlbmFpID0gdGVtcE9wZW5BSTtcclxuICAgICAgICAgICAgcmV0dXJuIHsgc3VjY2VzczogdHJ1ZSB9O1xyXG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ1tPcGVuQUlQcm94eVNlcnZpY2VdIENvbmZpZ3VyYXRpb24gZmFpbGVkOicsIGVycm9yLm1lc3NhZ2UpO1xyXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWQgQVBJIGtleSBvciBjb25uZWN0aW9uIGZhaWxlZCcpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIEhhbmRsZSB0cmFuc2NyaXB0aW9uIHJlcXVlc3RcclxuICAgICAqIEBwYXJhbSB7RWxlY3Ryb24uSXBjTWFpbkludm9rZUV2ZW50fSBldmVudCAtIElQQyBldmVudFxyXG4gICAgICogQHBhcmFtIHtPYmplY3R9IHJlcXVlc3QgLSBUcmFuc2NyaXB0aW9uIGRldGFpbHNcclxuICAgICAqL1xyXG4gICAgYXN5bmMgaGFuZGxlVHJhbnNjcmliZShldmVudCwgeyBhdWRpb1BhdGgsIGxhbmd1YWdlID0gJ2VuJywgcHJvbXB0ID0gJycsIG1vZGVsID0gJ3doaXNwZXInIH0pIHtcclxuICAgICAgICB0aGlzLmVuc3VyZUNvbmZpZ3VyZWQoKTtcclxuXHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgY29uc3QgY2FjaGVLZXkgPSBgdHJhbnNjcmliZToke2F1ZGlvUGF0aH06JHttb2RlbH1gO1xyXG4gICAgICAgICAgICBjb25zdCBjYWNoZWQgPSB0aGlzLmNhY2hlLmdldChjYWNoZUtleSk7XHJcbiAgICAgICAgICAgIGlmIChjYWNoZWQpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBjYWNoZWQ7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIC8vIE1hcCBvdXIgc2ltcGxpZmllZCBtb2RlbCBuYW1lcyB0byBhY3R1YWwgQVBJIG1vZGVsIG5hbWVzXHJcbiAgICAgICAgICAgIGNvbnN0IG1vZGVsTWFwcGluZyA9IHtcclxuICAgICAgICAgICAgICAgICd3aGlzcGVyJzogJ3doaXNwZXItMScsXHJcbiAgICAgICAgICAgICAgICAnZ3B0LTRvLW1pbmktdHJhbnNjcmliZSc6ICdncHQtNG8tbWluaS10cmFuc2NyaWJlJywgXHJcbiAgICAgICAgICAgICAgICAnZ3B0LTRvLXRyYW5zY3JpYmUnOiAnZ3B0LTRvLXRyYW5zY3JpYmUnXHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICBjb25zdCBhcGlNb2RlbCA9IG1vZGVsTWFwcGluZ1ttb2RlbF0gfHwgJ3doaXNwZXItMSc7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbT3BlbkFJUHJveHlTZXJ2aWNlXSBVc2luZyB0cmFuc2NyaXB0aW9uIG1vZGVsOiAke2FwaU1vZGVsfSAoZnJvbSAke21vZGVsfSlgKTtcclxuXHJcbiAgICAgICAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgdGhpcy5vcGVuYWkuYXVkaW8udHJhbnNjcmlwdGlvbnMuY3JlYXRlKHtcclxuICAgICAgICAgICAgICAgIGZpbGU6IGZzLmNyZWF0ZVJlYWRTdHJlYW0oYXVkaW9QYXRoKSxcclxuICAgICAgICAgICAgICAgIG1vZGVsOiBhcGlNb2RlbCxcclxuICAgICAgICAgICAgICAgIHByb21wdDogcHJvbXB0LFxyXG4gICAgICAgICAgICAgICAgcmVzcG9uc2VfZm9ybWF0OiAndGV4dCcsXHJcbiAgICAgICAgICAgICAgICBsYW5ndWFnZTogbGFuZ3VhZ2VcclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICBjb25zdCByZXN1bHQgPSB7XHJcbiAgICAgICAgICAgICAgICB0ZXh0OiByZXNwb25zZS50ZXh0IHx8IHJlc3BvbnNlLCAvLyBIYW5kbGUgYm90aCBvYmplY3QgYW5kIGRpcmVjdCB0ZXh0IHJlc3BvbnNlXHJcbiAgICAgICAgICAgICAgICBsYW5ndWFnZTogbGFuZ3VhZ2UsXHJcbiAgICAgICAgICAgICAgICBtb2RlbDogbW9kZWxcclxuICAgICAgICAgICAgfTtcclxuXHJcbiAgICAgICAgICAgIHRoaXMuY2FjaGUuc2V0KGNhY2hlS2V5LCByZXN1bHQpO1xyXG4gICAgICAgICAgICByZXR1cm4gcmVzdWx0O1xyXG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ1tPcGVuQUlQcm94eVNlcnZpY2VdIFRyYW5zY3JpcHRpb24gZmFpbGVkOicsIGVycm9yKTtcclxuICAgICAgICAgICAgdGhyb3cgdGhpcy5mb3JtYXRFcnJvcihlcnJvcik7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogSGFuZGxlIGNvbXBsZXRpb24gcmVxdWVzdFxyXG4gICAgICogQHBhcmFtIHtFbGVjdHJvbi5JcGNNYWluSW52b2tlRXZlbnR9IGV2ZW50IC0gSVBDIGV2ZW50XHJcbiAgICAgKiBAcGFyYW0ge09iamVjdH0gcmVxdWVzdCAtIENvbXBsZXRpb24gZGV0YWlsc1xyXG4gICAgICovXHJcbiAgICBhc3luYyBoYW5kbGVDb21wbGV0ZShldmVudCwgeyBwcm9tcHQsIG1vZGVsID0gJ2dwdC0zLjUtdHVyYm8nLCBvcHRpb25zID0ge30gfSkge1xyXG4gICAgICAgIHRoaXMuZW5zdXJlQ29uZmlndXJlZCgpO1xyXG5cclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICBjb25zdCBjYWNoZUtleSA9IGBjb21wbGV0ZToke21vZGVsfToke3Byb21wdH1gO1xyXG4gICAgICAgICAgICBjb25zdCBjYWNoZWQgPSB0aGlzLmNhY2hlLmdldChjYWNoZUtleSk7XHJcbiAgICAgICAgICAgIGlmIChjYWNoZWQpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBjYWNoZWQ7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgdGhpcy5vcGVuYWkuY2hhdC5jb21wbGV0aW9ucy5jcmVhdGUoe1xyXG4gICAgICAgICAgICAgICAgbW9kZWwsXHJcbiAgICAgICAgICAgICAgICBtZXNzYWdlczogW3sgcm9sZTogJ3VzZXInLCBjb250ZW50OiBwcm9tcHQgfV0sXHJcbiAgICAgICAgICAgICAgICAuLi5vcHRpb25zXHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0ge1xyXG4gICAgICAgICAgICAgICAgdGV4dDogcmVzcG9uc2UuY2hvaWNlc1swXS5tZXNzYWdlLmNvbnRlbnQsXHJcbiAgICAgICAgICAgICAgICB1c2FnZTogcmVzcG9uc2UudXNhZ2VcclxuICAgICAgICAgICAgfTtcclxuXHJcbiAgICAgICAgICAgIHRoaXMuY2FjaGUuc2V0KGNhY2hlS2V5LCByZXN1bHQpO1xyXG4gICAgICAgICAgICByZXR1cm4gcmVzdWx0O1xyXG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ1tPcGVuQUlQcm94eVNlcnZpY2VdIENvbXBsZXRpb24gZmFpbGVkOicsIGVycm9yKTtcclxuICAgICAgICAgICAgdGhyb3cgdGhpcy5mb3JtYXRFcnJvcihlcnJvcik7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogSGFuZGxlIEFQSSBrZXkgY2hlY2sgcmVxdWVzdFxyXG4gICAgICogQHBhcmFtIHtFbGVjdHJvbi5JcGNNYWluSW52b2tlRXZlbnR9IGV2ZW50IC0gSVBDIGV2ZW50XHJcbiAgICAgKi9cclxuICAgIGFzeW5jIGhhbmRsZUNoZWNrS2V5KGV2ZW50KSB7XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgaWYgKCF0aGlzLm9wZW5haSkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHsgdmFsaWQ6IGZhbHNlLCBlcnJvcjogJ0FQSSBub3QgY29uZmlndXJlZCcgfTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgYXdhaXQgdGhpcy5vcGVuYWkubW9kZWxzLmxpc3QoKTtcclxuICAgICAgICAgICAgcmV0dXJuIHsgdmFsaWQ6IHRydWUgfTtcclxuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKCdbT3BlbkFJUHJveHlTZXJ2aWNlXSBBUEkga2V5IGNoZWNrIGZhaWxlZDonLCBlcnJvcik7XHJcbiAgICAgICAgICAgIHJldHVybiB7IHZhbGlkOiBmYWxzZSwgZXJyb3I6IHRoaXMuZm9ybWF0RXJyb3IoZXJyb3IpLm1lc3NhZ2UgfTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBFbnN1cmUgdGhlIEFQSSBpcyBjb25maWd1cmVkXHJcbiAgICAgKiBAdGhyb3dzIHtFcnJvcn0gSWYgQVBJIGlzIG5vdCBjb25maWd1cmVkXHJcbiAgICAgKi9cclxuICAgIGVuc3VyZUNvbmZpZ3VyZWQoKSB7XHJcbiAgICAgICAgaWYgKCF0aGlzLm9wZW5haSkge1xyXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ09wZW5BSSBBUEkgbm90IGNvbmZpZ3VyZWQuIFBsZWFzZSBzZXQgYW4gQVBJIGtleS4nKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBGb3JtYXQgZXJyb3IgZm9yIGNsaWVudCBjb25zdW1wdGlvblxyXG4gICAgICogQHBhcmFtIHtFcnJvcn0gZXJyb3IgLSBPcmlnaW5hbCBlcnJvclxyXG4gICAgICogQHJldHVybnMge0Vycm9yfSBGb3JtYXR0ZWQgZXJyb3JcclxuICAgICAqL1xyXG4gICAgZm9ybWF0RXJyb3IoZXJyb3IpIHtcclxuICAgICAgICBpZiAoZXJyb3IucmVzcG9uc2UpIHtcclxuICAgICAgICAgICAgY29uc3Qgc3RhdHVzID0gZXJyb3IucmVzcG9uc2Uuc3RhdHVzO1xyXG4gICAgICAgICAgICBjb25zdCBtZXNzYWdlID0gZXJyb3IucmVzcG9uc2UuZGF0YS5lcnJvcj8ubWVzc2FnZSB8fCBlcnJvci5tZXNzYWdlO1xyXG5cclxuICAgICAgICAgICAgaWYgKHN0YXR1cyA9PT0gNDI5KSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IEVycm9yKCdSYXRlIGxpbWl0IGV4Y2VlZGVkLiBQbGVhc2UgdHJ5IGFnYWluIGxhdGVyLicpO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICByZXR1cm4gbmV3IEVycm9yKGBPcGVuQUkgQVBJIEVycm9yICgke3N0YXR1c30pOiAke21lc3NhZ2V9YCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gZXJyb3I7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBDbGVhciB0aGUgcmVzcG9uc2UgY2FjaGVcclxuICAgICAqL1xyXG4gICAgY2xlYXJDYWNoZSgpIHtcclxuICAgICAgICB0aGlzLmNhY2hlLmZsdXNoQWxsKCk7XHJcbiAgICB9XHJcbn1cclxuXHJcbi8vIENyZWF0ZSBhIHNpbmdsZSBpbnN0YW5jZSBvZiB0aGUgc2VydmljZVxyXG5jb25zdCBpbnN0YW5jZSA9IG5ldyBPcGVuQUlQcm94eVNlcnZpY2UoKTtcclxuXHJcbi8vIEV4cG9ydCBhbiBvYmplY3QgY29udGFpbmluZyB0aGUgaW5zdGFuY2VcclxubW9kdWxlLmV4cG9ydHMgPSB7IGluc3RhbmNlIH07XHJcbiJdLCJtYXBwaW5ncyI6Ijs7QUFBQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUEsTUFBTUEsV0FBVyxHQUFHQyxPQUFPLENBQUMsZ0JBQWdCLENBQUM7QUFDN0MsTUFBTUMsTUFBTSxHQUFHRCxPQUFPLENBQUMsUUFBUSxDQUFDO0FBQ2hDLE1BQU1FLFNBQVMsR0FBR0YsT0FBTyxDQUFDLFlBQVksQ0FBQztBQUN2QyxNQUFNRyxLQUFLLEdBQUdILE9BQU8sQ0FBQyxPQUFPLENBQUM7QUFDOUIsTUFBTUksRUFBRSxHQUFHSixPQUFPLENBQUMsVUFBVSxDQUFDO0FBQzlCLE1BQU1LLFVBQVUsR0FBR0wsT0FBTyxDQUFDLHlCQUF5QixDQUFDO0FBRXJELE1BQU1NLGtCQUFrQixTQUFTUCxXQUFXLENBQUM7RUFDekNRLFdBQVdB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