"use strict";

/**
 * OpenAIProxyService.js
 * Manages OpenAI API interactions in the Electron main process.
 * 
 * This service handles:
 * - API key management
 * - Rate limiting and quotas
 * - OpenAI API requests and responses
 * - Response caching for efficiency
 * 
 * Related Files:
 * - BaseService.js: Parent class providing IPC handling
 * - ApiKeyService.js: For API key management
 * - TranscriptionService.js: Uses this service for audio transcription
 */

const BaseService = require('../BaseService');
const OpenAI = require('openai');
const NodeCache = require('node-cache');
const axios = require('axios');
const fs = require('fs-extra');
const axiosRetry = require('./OpenAIProxyServiceFix');
class OpenAIProxyService extends BaseService {
  constructor() {
    super();
    this.openai = null;
    this.cache = new NodeCache({
      stdTTL: 3600
    }); // 1 hour cache
    this.setupAxiosRetry();
  }

  /**
   * Set up IPC handlers for OpenAI operations
   */
  setupIpcHandlers() {
    this.registerHandler('openai:configure', this.handleConfigure.bind(this));
    this.registerHandler('openai:transcribe', this.handleTranscribe.bind(this));
    this.registerHandler('openai:complete', this.handleComplete.bind(this));
    this.registerHandler('openai:check-key', this.handleCheckKey.bind(this));
  }

  /**
   * Configure axios retry behavior
   */
  setupAxiosRetry() {
    axiosRetry(axios, {
      retries: 3,
      retryDelay: axiosRetry.exponentialDelay,
      retryCondition: error => {
        return axiosRetry.isNetworkOrIdempotentRequestError(error) || error.response && error.response.status === 429; // Rate limit
      }
    });
  }

  /**
   * Handle API configuration request
   * @param {Electron.IpcMainInvokeEvent} event - IPC event
   * @param {Object} request - Configuration details
   */
  async handleConfigure(event, {
    apiKey
  }) {
    try {
      // Instantiate directly with v4 syntax
      const tempOpenAI = new OpenAI({
        apiKey
      });

      // Verify the API key with a v4 style request
      await tempOpenAI.models.list();

      // If successful, update the instance
      this.openai = tempOpenAI;
      return {
        success: true
      };
    } catch (error) {
      console.error('[OpenAIProxyService] Configuration failed:', error.message);
      throw new Error('Invalid API key or connection failed');
    }
  }

  /**
   * Handle transcription request
   * @param {Electron.IpcMainInvokeEvent} event - IPC event
   * @param {Object} request - Transcription details
   */
  async handleTranscribe(event, {
    audioPath,
    language = 'en',
    prompt = '',
    model = 'whisper'
  }) {
    this.ensureConfigured();
    try {
      const cacheKey = `transcribe:${audioPath}:${model}`;
      const cached = this.cache.get(cacheKey);
      if (cached) {
        return cached;
      }

      // Map our simplified model names to actual API model names
      const modelMapping = {
        'whisper': 'whisper-1',
        'gpt-4o-mini-transcribe': 'gpt-4o-mini-transcribe',
        'gpt-4o-transcribe': 'gpt-4o-transcribe'
      };
      const apiModel = modelMapping[model] || 'whisper-1';
      console.log(`[OpenAIProxyService] Using transcription model: ${apiModel} (from ${model})`);
      const response = await this.openai.audio.transcriptions.create({
        file: fs.createReadStream(audioPath),
        model: apiModel,
        prompt: prompt,
        response_format: 'text',
        language: language
      });
      const result = {
        text: response.text || response,
        // Handle both object and direct text response
        language: language,
        model: model
      };
      this.cache.set(cacheKey, result);
      return result;
    } catch (error) {
      console.error('[OpenAIProxyService] Transcription failed:', error);
      throw this.formatError(error);
    }
  }

  /**
   * Handle completion request
   * @param {Electron.IpcMainInvokeEvent} event - IPC event
   * @param {Object} request - Completion details
   */
  async handleComplete(event, {
    prompt,
    model = 'gpt-3.5-turbo',
    options = {}
  }) {
    this.ensureConfigured();
    try {
      const cacheKey = `complete:${model}:${prompt}`;
      const cached = this.cache.get(cacheKey);
      if (cached) {
        return cached;
      }
      const response = await this.openai.chat.completions.create({
        model,
        messages: [{
          role: 'user',
          content: prompt
        }],
        ...options
      });
      const result = {
        text: response.choices[0].message.content,
        usage: response.usage
      };
      this.cache.set(cacheKey, result);
      return result;
    } catch (error) {
      console.error('[OpenAIProxyService] Completion failed:', error);
      throw this.formatError(error);
    }
  }

  /**
   * Handle API key check request
   * @param {Electron.IpcMainInvokeEvent} event - IPC event
   */
  async handleCheckKey(event) {
    try {
      if (!this.openai) {
        return {
          valid: false,
          error: 'API not configured'
        };
      }
      await this.openai.models.list();
      return {
        valid: true
      };
    } catch (error) {
      console.error('[OpenAIProxyService] API key check failed:', error);
      return {
        valid: false,
        error: this.formatError(error).message
      };
    }
  }

  /**
   * Ensure the API is configured
   * @throws {Error} If API is not configured
   */
  ensureConfigured() {
    if (!this.openai) {
      throw new Error('OpenAI API not configured. Please set an API key.');
    }
  }

  /**
   * Format error for client consumption
   * @param {Error} error - Original error
   * @returns {Error} Formatted error
   */
  formatError(error) {
    if (error.response) {
      const status = error.response.status;
      const message = error.response.data.error?.message || error.message;
      if (status === 429) {
        return new Error('Rate limit exceeded. Please try again later.');
      }
      return new Error(`OpenAI API Error (${status}): ${message}`);
    }
    return error;
  }

  /**
   * Clear the response cache
   */
  clearCache() {
    this.cache.flushAll();
  }
}

// Create a single instance of the service
const instance = new OpenAIProxyService();

// Export an object containing the instance
module.exports = {
  instance
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJCYXNlU2VydmljZSIsInJlcXVpcmUiLCJPcGVuQUkiLCJOb2RlQ2FjaGUiLCJheGlvcyIsImZzIiwiYXhpb3NSZXRyeSIsIk9wZW5BSVByb3h5U2VydmljZSIsImNvbnN0cnVjdG9yIiwib3BlbmFpIiwiY2FjaGUiLCJzdGRUVEwiLCJzZXR1cEF4aW9zUmV0cnkiLCJzZXR1cElwY0hhbmRsZXJzIiwicmVnaXN0ZXJIYW5kbGVyIiwiaGFuZGxlQ29uZmlndXJlIiwiYmluZCIsImhhbmRsZVRyYW5zY3JpYmUiLCJoYW5kbGVDb21wbGV0ZSIsImhhbmRsZUNoZWNrS2V5IiwicmV0cmllcyIsInJldHJ5RGVsYXkiLCJleHBvbmVudGlhbERlbGF5IiwicmV0cnlDb25kaXRpb24iLCJlcnJvciIsImlzTmV0d29ya09ySWRlbXBvdGVudFJlcXVlc3RFcnJvciIsInJlc3BvbnNlIiwic3RhdHVzIiwiZXZlbnQiLCJhcGlLZXkiLCJ0ZW1wT3BlbkFJIiwibW9kZWxzIiwibGlzdCIsInN1Y2Nlc3MiLCJjb25zb2xlIiwibWVzc2FnZSIsIkVycm9yIiwiYXVkaW9QYXRoIiwibGFuZ3VhZ2UiLCJwcm9tcHQiLCJtb2RlbCIsImVuc3VyZUNvbmZpZ3VyZWQiLCJjYWNoZUtleSIsImNhY2hlZCIsImdldCIsIm1vZGVsTWFwcGluZyIsImFwaU1vZGVsIiwibG9nIiwiYXVkaW8iLCJ0cmFuc2NyaXB0aW9ucyIsImNyZWF0ZSIsImZpbGUiLCJjcmVhdGVSZWFkU3RyZWFtIiwicmVzcG9uc2VfZm9ybWF0IiwicmVzdWx0IiwidGV4dCIsInNldCIsImZvcm1hdEVycm9yIiwib3B0aW9ucyIsImNoYXQiLCJjb21wbGV0aW9ucyIsIm1lc3NhZ2VzIiwicm9sZSIsImNvbnRlbnQiLCJjaG9pY2VzIiwidXNhZ2UiLCJ2YWxpZCIsImRhdGEiLCJjbGVhckNhY2hlIiwiZmx1c2hBbGwiLCJpbnN0YW5jZSIsIm1vZHVsZSIsImV4cG9ydHMiXSwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvZWxlY3Ryb24vc2VydmljZXMvYWkvT3BlbkFJUHJveHlTZXJ2aWNlLmpzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxyXG4gKiBPcGVuQUlQcm94eVNlcnZpY2UuanNcclxuICogTWFuYWdlcyBPcGVuQUkgQVBJIGludGVyYWN0aW9ucyBpbiB0aGUgRWxlY3Ryb24gbWFpbiBwcm9jZXNzLlxyXG4gKiBcclxuICogVGhpcyBzZXJ2aWNlIGhhbmRsZXM6XHJcbiAqIC0gQVBJIGtleSBtYW5hZ2VtZW50XHJcbiAqIC0gUmF0ZSBsaW1pdGluZyBhbmQgcXVvdGFzXHJcbiAqIC0gT3BlbkFJIEFQSSByZXF1ZXN0cyBhbmQgcmVzcG9uc2VzXHJcbiAqIC0gUmVzcG9uc2UgY2FjaGluZyBmb3IgZWZmaWNpZW5jeVxyXG4gKiBcclxuICogUmVsYXRlZCBGaWxlczpcclxuICogLSBCYXNlU2VydmljZS5qczogUGFyZW50IGNsYXNzIHByb3ZpZGluZyBJUEMgaGFuZGxpbmdcclxuICogLSBBcGlLZXlTZXJ2aWNlLmpzOiBGb3IgQVBJIGtleSBtYW5hZ2VtZW50XHJcbiAqIC0gVHJhbnNjcmlwdGlvblNlcnZpY2UuanM6IFVzZXMgdGhpcyBzZXJ2aWNlIGZvciBhdWRpbyB0cmFuc2NyaXB0aW9uXHJcbiAqL1xyXG5cclxuY29uc3QgQmFzZVNlcnZpY2UgPSByZXF1aXJlKCcuLi9CYXNlU2VydmljZScpO1xyXG5jb25zdCBPcGVuQUkgPSByZXF1aXJlKCdvcGVuYWknKTtcclxuY29uc3QgTm9kZUNhY2hlID0gcmVxdWlyZSgnbm9kZS1jYWNoZScpO1xyXG5jb25zdCBheGlvcyA9IHJlcXVpcmUoJ2F4aW9zJyk7XHJcbmNvbnN0IGZzID0gcmVxdWlyZSgnZnMtZXh0cmEnKTtcclxuY29uc3QgYXhpb3NSZXRyeSA9IHJlcXVpcmUoJy4vT3BlbkFJUHJveHlTZXJ2aWNlRml4Jyk7XHJcblxyXG5jbGFzcyBPcGVuQUlQcm94eVNlcnZpY2UgZXh0ZW5kcyBCYXNlU2VydmljZSB7XHJcbiAgICBjb25zdHJ1Y3RvcigpIHtcclxuICAgICAgICBzdXBlcigpO1xyXG4gICAgICAgIHRoaXMub3BlbmFpID0gbnVsbDtcclxuICAgICAgICB0aGlzLmNhY2hlID0gbmV3IE5vZGVDYWNoZSh7IHN0ZFRUTDogMzYwMCB9KTsgLy8gMSBob3VyIGNhY2hlXHJcbiAgICAgICAgdGhpcy5zZXR1cEF4aW9zUmV0cnkoKTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIFNldCB1cCBJUEMgaGFuZGxlcnMgZm9yIE9wZW5BSSBvcGVyYXRpb25zXHJcbiAgICAgKi9cclxuICAgIHNldHVwSXBjSGFuZGxlcnMoKSB7XHJcbiAgICAgICAgdGhpcy5yZWdpc3RlckhhbmRsZXIoJ29wZW5haTpjb25maWd1cmUnLCB0aGlzLmhhbmRsZUNvbmZpZ3VyZS5iaW5kKHRoaXMpKTtcclxuICAgICAgICB0aGlzLnJlZ2lzdGVySGFuZGxlcignb3BlbmFpOnRyYW5zY3JpYmUnLCB0aGlzLmhhbmRsZVRyYW5zY3JpYmUuYmluZCh0aGlzKSk7XHJcbiAgICAgICAgdGhpcy5yZWdpc3RlckhhbmRsZXIoJ29wZW5haTpjb21wbGV0ZScsIHRoaXMuaGFuZGxlQ29tcGxldGUuYmluZCh0aGlzKSk7XHJcbiAgICAgICAgdGhpcy5yZWdpc3RlckhhbmRsZXIoJ29wZW5haTpjaGVjay1rZXknLCB0aGlzLmhhbmRsZUNoZWNrS2V5LmJpbmQodGhpcykpO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogQ29uZmlndXJlIGF4aW9zIHJldHJ5IGJlaGF2aW9yXHJcbiAgICAgKi9cclxuICAgIHNldHVwQXhpb3NSZXRyeSgpIHtcclxuICAgICAgICBheGlvc1JldHJ5KGF4aW9zLCB7XHJcbiAgICAgICAgICAgIHJldHJpZXM6IDMsXHJcbiAgICAgICAgICAgIHJldHJ5RGVsYXk6IGF4aW9zUmV0cnkuZXhwb25lbnRpYWxEZWxheSxcclxuICAgICAgICAgICAgcmV0cnlDb25kaXRpb246IChlcnJvcikgPT4ge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGF4aW9zUmV0cnkuaXNOZXR3b3JrT3JJZGVtcG90ZW50UmVxdWVzdEVycm9yKGVycm9yKSB8fFxyXG4gICAgICAgICAgICAgICAgICAgIChlcnJvci5yZXNwb25zZSAmJiBlcnJvci5yZXNwb25zZS5zdGF0dXMgPT09IDQyOSk7IC8vIFJhdGUgbGltaXRcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogSGFuZGxlIEFQSSBjb25maWd1cmF0aW9uIHJlcXVlc3RcclxuICAgICAqIEBwYXJhbSB7RWxlY3Ryb24uSXBjTWFpbkludm9rZUV2ZW50fSBldmVudCAtIElQQyBldmVudFxyXG4gICAgICogQHBhcmFtIHtPYmplY3R9IHJlcXVlc3QgLSBDb25maWd1cmF0aW9uIGRldGFpbHNcclxuICAgICAqL1xyXG4gICAgYXN5bmMgaGFuZGxlQ29uZmlndXJlKGV2ZW50LCB7IGFwaUtleSB9KSB7XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgLy8gSW5zdGFudGlhdGUgZGlyZWN0bHkgd2l0aCB2NCBzeW50YXhcclxuICAgICAgICAgICAgY29uc3QgdGVtcE9wZW5BSSA9IG5ldyBPcGVuQUkoeyBhcGlLZXkgfSk7XHJcblxyXG4gICAgICAgICAgICAvLyBWZXJpZnkgdGhlIEFQSSBrZXkgd2l0aCBhIHY0IHN0eWxlIHJlcXVlc3RcclxuICAgICAgICAgICAgYXdhaXQgdGVtcE9wZW5BSS5tb2RlbHMubGlzdCgpO1xyXG5cclxuICAgICAgICAgICAgLy8gSWYgc3VjY2Vzc2Z1bCwgdXBkYXRlIHRoZSBpbnN0YW5jZVxyXG4gICAgICAgICAgICB0aGlzLm9wZW5haSA9IHRlbXBPcGVuQUk7XHJcbiAgICAgICAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IHRydWUgfTtcclxuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKCdbT3BlbkFJUHJveHlTZXJ2aWNlXSBDb25maWd1cmF0aW9uIGZhaWxlZDonLCBlcnJvci5tZXNzYWdlKTtcclxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIEFQSSBrZXkgb3IgY29ubmVjdGlvbiBmYWlsZWQnKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBIYW5kbGUgdHJhbnNjcmlwdGlvbiByZXF1ZXN0XHJcbiAgICAgKiBAcGFyYW0ge0VsZWN0cm9uLklwY01haW5JbnZva2VFdmVudH0gZXZlbnQgLSBJUEMgZXZlbnRcclxuICAgICAqIEBwYXJhbSB7T2JqZWN0fSByZXF1ZXN0IC0gVHJhbnNjcmlwdGlvbiBkZXRhaWxzXHJcbiAgICAgKi9cclxuICAgIGFzeW5jIGhhbmRsZVRyYW5zY3JpYmUoZXZlbnQsIHsgYXVkaW9QYXRoLCBsYW5ndWFnZSA9ICdlbicsIHByb21wdCA9ICcnLCBtb2RlbCA9ICd3aGlzcGVyJyB9KSB7XHJcbiAgICAgICAgdGhpcy5lbnN1cmVDb25maWd1cmVkKCk7XHJcblxyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGNhY2hlS2V5ID0gYHRyYW5zY3JpYmU6JHthdWRpb1BhdGh9OiR7bW9kZWx9YDtcclxuICAgICAgICAgICAgY29uc3QgY2FjaGVkID0gdGhpcy5jYWNoZS5nZXQoY2FjaGVLZXkpO1xyXG4gICAgICAgICAgICBpZiAoY2FjaGVkKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gY2FjaGVkO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAvLyBNYXAgb3VyIHNpbXBsaWZpZWQgbW9kZWwgbmFtZXMgdG8gYWN0dWFsIEFQSSBtb2RlbCBuYW1lc1xyXG4gICAgICAgICAgICBjb25zdCBtb2RlbE1hcHBpbmcgPSB7XHJcbiAgICAgICAgICAgICAgICAnd2hpc3Blcic6ICd3aGlzcGVyLTEnLFxyXG4gICAgICAgICAgICAgICAgJ2dwdC00by1taW5pLXRyYW5zY3JpYmUnOiAnZ3B0LTRvLW1pbmktdHJhbnNjcmliZScsIFxyXG4gICAgICAgICAgICAgICAgJ2dwdC00by10cmFuc2NyaWJlJzogJ2dwdC00by10cmFuc2NyaWJlJ1xyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgY29uc3QgYXBpTW9kZWwgPSBtb2RlbE1hcHBpbmdbbW9kZWxdIHx8ICd3aGlzcGVyLTEnO1xyXG4gICAgICAgICAgICBjb25zb2xlLmxvZyhgW09wZW5BSVByb3h5U2VydmljZV0gVXNpbmcgdHJhbnNjcmlwdGlvbiBtb2RlbDogJHthcGlNb2RlbH0gKGZyb20gJHttb2RlbH0pYCk7XHJcblxyXG4gICAgICAgICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHRoaXMub3BlbmFpLmF1ZGlvLnRyYW5zY3JpcHRpb25zLmNyZWF0ZSh7XHJcbiAgICAgICAgICAgICAgICBmaWxlOiBmcy5jcmVhdGVSZWFkU3RyZWFtKGF1ZGlvUGF0aCksXHJcbiAgICAgICAgICAgICAgICBtb2RlbDogYXBpTW9kZWwsXHJcbiAgICAgICAgICAgICAgICBwcm9tcHQ6IHByb21wdCxcclxuICAgICAgICAgICAgICAgIHJlc3BvbnNlX2Zvcm1hdDogJ3RleHQnLFxyXG4gICAgICAgICAgICAgICAgbGFuZ3VhZ2U6IGxhbmd1YWdlXHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0ge1xyXG4gICAgICAgICAgICAgICAgdGV4dDogcmVzcG9uc2UudGV4dCB8fCByZXNwb25zZSwgLy8gSGFuZGxlIGJvdGggb2JqZWN0IGFuZCBkaXJlY3QgdGV4dCByZXNwb25zZVxyXG4gICAgICAgICAgICAgICAgbGFuZ3VhZ2U6IGxhbmd1YWdlLFxyXG4gICAgICAgICAgICAgICAgbW9kZWw6IG1vZGVsXHJcbiAgICAgICAgICAgIH07XHJcblxyXG4gICAgICAgICAgICB0aGlzLmNhY2hlLnNldChjYWNoZUtleSwgcmVzdWx0KTtcclxuICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDtcclxuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKCdbT3BlbkFJUHJveHlTZXJ2aWNlXSBUcmFuc2NyaXB0aW9uIGZhaWxlZDonLCBlcnJvcik7XHJcbiAgICAgICAgICAgIHRocm93IHRoaXMuZm9ybWF0RXJyb3IoZXJyb3IpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIEhhbmRsZSBjb21wbGV0aW9uIHJlcXVlc3RcclxuICAgICAqIEBwYXJhbSB7RWxlY3Ryb24uSXBjTWFpbkludm9rZUV2ZW50fSBldmVudCAtIElQQyBldmVudFxyXG4gICAgICogQHBhcmFtIHtPYmplY3R9IHJlcXVlc3QgLSBDb21wbGV0aW9uIGRldGFpbHNcclxuICAgICAqL1xyXG4gICAgYXN5bmMgaGFuZGxlQ29tcGxldGUoZXZlbnQsIHsgcHJvbXB0LCBtb2RlbCA9ICdncHQtMy41LXR1cmJvJywgb3B0aW9ucyA9IHt9IH0pIHtcclxuICAgICAgICB0aGlzLmVuc3VyZUNvbmZpZ3VyZWQoKTtcclxuXHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgY29uc3QgY2FjaGVLZXkgPSBgY29tcGxldGU6JHttb2RlbH06JHtwcm9tcHR9YDtcclxuICAgICAgICAgICAgY29uc3QgY2FjaGVkID0gdGhpcy5jYWNoZS5nZXQoY2FjaGVLZXkpO1xyXG4gICAgICAgICAgICBpZiAoY2FjaGVkKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gY2FjaGVkO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHRoaXMub3BlbmFpLmNoYXQuY29tcGxldGlvbnMuY3JlYXRlKHtcclxuICAgICAgICAgICAgICAgIG1vZGVsLFxyXG4gICAgICAgICAgICAgICAgbWVzc2FnZXM6IFt7IHJvbGU6ICd1c2VyJywgY29udGVudDogcHJvbXB0IH1dLFxyXG4gICAgICAgICAgICAgICAgLi4ub3B0aW9uc1xyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IHtcclxuICAgICAgICAgICAgICAgIHRleHQ6IHJlc3BvbnNlLmNob2ljZXNbMF0ubWVzc2FnZS5jb250ZW50LFxyXG4gICAgICAgICAgICAgICAgdXNhZ2U6IHJlc3BvbnNlLnVzYWdlXHJcbiAgICAgICAgICAgIH07XHJcblxyXG4gICAgICAgICAgICB0aGlzLmNhY2hlLnNldChjYWNoZUtleSwgcmVzdWx0KTtcclxuICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDtcclxuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKCdbT3BlbkFJUHJveHlTZXJ2aWNlXSBDb21wbGV0aW9uIGZhaWxlZDonLCBlcnJvcik7XHJcbiAgICAgICAgICAgIHRocm93IHRoaXMuZm9ybWF0RXJyb3IoZXJyb3IpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIEhhbmRsZSBBUEkga2V5IGNoZWNrIHJlcXVlc3RcclxuICAgICAqIEBwYXJhbSB7RWxlY3Ryb24uSXBjTWFpbkludm9rZUV2ZW50fSBldmVudCAtIElQQyBldmVudFxyXG4gICAgICovXHJcbiAgICBhc3luYyBoYW5kbGVDaGVja0tleShldmVudCkge1xyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIGlmICghdGhpcy5vcGVuYWkpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiB7IHZhbGlkOiBmYWxzZSwgZXJyb3I6ICdBUEkgbm90IGNvbmZpZ3VyZWQnIH07XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGF3YWl0IHRoaXMub3BlbmFpLm1vZGVscy5saXN0KCk7XHJcbiAgICAgICAgICAgIHJldHVybiB7IHZhbGlkOiB0cnVlIH07XHJcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgICAgICAgY29uc29sZS5lcnJvcignW09wZW5BSVByb3h5U2VydmljZV0gQVBJIGtleSBjaGVjayBmYWlsZWQ6JywgZXJyb3IpO1xyXG4gICAgICAgICAgICByZXR1cm4geyB2YWxpZDogZmFsc2UsIGVycm9yOiB0aGlzLmZvcm1hdEVycm9yKGVycm9yKS5tZXNzYWdlIH07XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogRW5zdXJlIHRoZSBBUEkgaXMgY29uZmlndXJlZFxyXG4gICAgICogQHRocm93cyB7RXJyb3J9IElmIEFQSSBpcyBub3QgY29uZmlndXJlZFxyXG4gICAgICovXHJcbiAgICBlbnN1cmVDb25maWd1cmVkKCkge1xyXG4gICAgICAgIGlmICghdGhpcy5vcGVuYWkpIHtcclxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdPcGVuQUkgQVBJIG5vdCBjb25maWd1cmVkLiBQbGVhc2Ugc2V0IGFuIEFQSSBrZXkuJyk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogRm9ybWF0IGVycm9yIGZvciBjbGllbnQgY29uc3VtcHRpb25cclxuICAgICAqIEBwYXJhbSB7RXJyb3J9IGVycm9yIC0gT3JpZ2luYWwgZXJyb3JcclxuICAgICAqIEByZXR1cm5zIHtFcnJvcn0gRm9ybWF0dGVkIGVycm9yXHJcbiAgICAgKi9cclxuICAgIGZvcm1hdEVycm9yKGVycm9yKSB7XHJcbiAgICAgICAgaWYgKGVycm9yLnJlc3BvbnNlKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHN0YXR1cyA9IGVycm9yLnJlc3BvbnNlLnN0YXR1cztcclxuICAgICAgICAgICAgY29uc3QgbWVzc2FnZSA9IGVycm9yLnJlc3BvbnNlLmRhdGEuZXJyb3I/Lm1lc3NhZ2UgfHwgZXJyb3IubWVzc2FnZTtcclxuXHJcbiAgICAgICAgICAgIGlmIChzdGF0dXMgPT09IDQyOSkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBFcnJvcignUmF0ZSBsaW1pdCBleGNlZWRlZC4gUGxlYXNlIHRyeSBhZ2FpbiBsYXRlci4nKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgcmV0dXJuIG5ldyBFcnJvcihgT3BlbkFJIEFQSSBFcnJvciAoJHtzdGF0dXN9KTogJHttZXNzYWdlfWApO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIGVycm9yO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogQ2xlYXIgdGhlIHJlc3BvbnNlIGNhY2hlXHJcbiAgICAgKi9cclxuICAgIGNsZWFyQ2FjaGUoKSB7XHJcbiAgICAgICAgdGhpcy5jYWNoZS5mbHVzaEFsbCgpO1xyXG4gICAgfVxyXG59XHJcblxyXG4vLyBDcmVhdGUgYSBzaW5nbGUgaW5zdGFuY2Ugb2YgdGhlIHNlcnZpY2VcclxuY29uc3QgaW5zdGFuY2UgPSBuZXcgT3BlbkFJUHJveHlTZXJ2aWNlKCk7XHJcblxyXG4vLyBFeHBvcnQgYW4gb2JqZWN0IGNvbnRhaW5pbmcgdGhlIGluc3RhbmNlXHJcbm1vZHVsZS5leHBvcnRzID0geyBpbnN0YW5jZSB9O1xyXG4iXSwibWFwcGluZ3MiOiI7O0FBQUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBLE1BQU1BLFdBQVcsR0FBR0MsT0FBTyxDQUFDLGdCQUFnQixDQUFDO0FBQzdDLE1BQU1DLE1BQU0sR0FBR0QsT0FBTyxDQUFDLFFBQVEsQ0FBQztBQUNoQyxNQUFNRSxTQUFTLEdBQUdGLE9BQU8sQ0FBQyxZQUFZLENBQUM7QUFDdkMsTUFBTUcsS0FBSyxHQUFHSCxPQUFPLENBQUMsT0FBTyxDQUFDO0FBQzlCLE1BQU1JLEVBQUUsR0FBR0osT0FBTyxDQUFDLFVBQVUsQ0FBQztBQUM5QixNQUFNSyxVQUFVLEdBQUdMLE9BQU8sQ0FBQyx5QkFBeUIsQ0FBQztBQUVyRCxNQUFNTSxrQkFBa0IsU0FBU1AsV0FBVyxDQUFDO0VBQ3pDUSxXQUFXQSxDQUFBLEVBQUc7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