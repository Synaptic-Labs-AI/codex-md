"use strict";

/**
 * Conversion IPC Handlers
 * Handles conversion-related IPC events between renderer and main process
 */

const {
  ipcMain,
  app
} = require('electron');
const ElectronConversionService = require('../../../services/ElectronConversionService');
const {
  dialog
} = require('electron');
const path = require('path');
const fs = require('fs');

/**
 * Register conversion IPC handlers
 */
function registerConversionHandlers() {
  // Handle file conversion requests
  ipcMain.handle('codex:convert:file', async (event, input, options) => {
    try {
      // Get OCR setting from settings store if not already provided
      if (options && options.fileType === 'pdf' && options.useOcr === undefined) {
        const {
          getSettingValue
        } = require('../settings');
        console.log(`[Conversion Handler] Getting OCR setting from settings store`);

        // Check both ways of accessing the setting
        const ocrEnabled = await getSettingValue('ocr.enabled', false);
        console.log(`[Conversion Handler] OCR setting from settings store: ${ocrEnabled} (type: ${typeof ocrEnabled})`);

        // Also check the direct setting
        const directOcr = await getSettingValue('ocr', {
          enabled: false
        });
        console.log(`[Conversion Handler] Direct OCR object from settings store:`, directOcr);
        console.log(`[Conversion Handler] Direct OCR enabled value: ${directOcr.enabled} (type: ${typeof directOcr.enabled})`);
        options.useOcr = ocrEnabled;
        console.log(`[Conversion Handler] PDF conversion with OCR ${ocrEnabled ? 'enabled' : 'disabled'}`);
        console.log(`[Conversion Handler] Final options:`, options);
      }

      // Handle URL conversions
      if (options && (options.type === 'url' || options.type === 'parenturl')) {
        const isParentUrl = options.type === 'parenturl';
        console.log(`IPC: Processing ${isParentUrl ? 'parent URL' : 'URL'} conversion: ${input}`);

        // Preserve all options, especially for parent URL
        return await ElectronConversionService.convert(input, {
          ...options,
          type: options.type // Preserve original type (url/parenturl)
        });
      }

      // Handle buffer input for binary files (audio/video/pdf/xlsx)
      if (options && options.buffer) {
        console.log(`IPC: Processing binary file of type ${options.type || 'unknown'}: ${options.originalFileName || 'unnamed'}`);

        // Log buffer details to help diagnose issues
        console.log('IPC: Buffer details:', {
          bufferLength: options.buffer.byteLength,
          isArrayBuffer: options.buffer instanceof ArrayBuffer,
          type: options.type,
          originalFileName: options.originalFileName,
          isTemporary: options.isTemporary
        });

        // Convert ArrayBuffer to Buffer
        const buffer = Buffer.from(options.buffer);

        // Verify buffer was created correctly
        console.log(`IPC: Created Buffer of length ${buffer.length}`);
        return await ElectronConversionService.convert(buffer, {
          ...options,
          name: options.originalFileName,
          isTemporary: true
        });
      }

      // Handle CSV content directly (when isContent flag is set)
      if (options && options.isContent && options.type === 'csv') {
        console.log(`IPC: Processing CSV content directly: ${options.originalFileName || 'unnamed'}`);

        // Create a temporary file with the CSV content
        const tempDir = path.join(app.getPath('temp'), 'codex-md-temp');
        if (!fs.existsSync(tempDir)) {
          fs.mkdirSync(tempDir, {
            recursive: true
          });
        }
        const tempFilePath = path.join(tempDir, `temp_${Date.now()}.csv`);
        fs.writeFileSync(tempFilePath, input);
        console.log(`IPC: Created temporary CSV file: ${tempFilePath}`);

        // Convert the temporary file
        const result = await ElectronConversionService.convert(tempFilePath, {
          ...options,
          originalFileName: options.originalFileName || options.name,
          name: options.originalFileName || options.name || path.basename(tempFilePath)
        });

        // Clean up the temporary file
        try {
          fs.unlinkSync(tempFilePath);
          console.log(`IPC: Removed temporary CSV file: ${tempFilePath}`);
        } catch (cleanupError) {
          console.warn(`IPC: Failed to remove temporary CSV file: ${cleanupError.message}`);
        }
        return result;
      }

      // Handle text content
      if (options && options.content) {
        return await ElectronConversionService.convert(options.content, {
          ...options,
          name: options.originalFileName
        });
      }

      // Handle file paths
      // For PDF files, ensure OCR setting is included
      if (options && options.fileType === 'pdf') {
        console.log(`IPC: Processing PDF file with OCR ${options.useOcr ? 'enabled' : 'disabled'}`);
      }
      return await ElectronConversionService.convert(input, options);
    } catch (error) {
      console.error('Conversion error:', error);

      // Check if this is a transcription error
      if (error.isTranscriptionError) {
        console.error('Transcription error detected:', error.message);
        return {
          success: false,
          error: error.message,
          isTranscriptionError: true // Add a flag to indicate this is a transcription error
        };
      }
      return {
        success: false,
        error: error.message
      };
    }
  });

  // Directory selection is now handled by filesystem/index.js

  // Handle cancel conversion requests
  ipcMain.handle('codex:convert:cancel', async () => {
    try {
      await ElectronConversionService.cancelRequests();
      return {
        success: true
      };
    } catch (error) {
      console.error('Cancel requests error:', error);
      return {
        success: false,
        error: error.message
      };
    }
  });
}
module.exports = {
  registerConversionHandlers
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJpcGNNYWluIiwiYXBwIiwicmVxdWlyZSIsIkVsZWN0cm9uQ29udmVyc2lvblNlcnZpY2UiLCJkaWFsb2ciLCJwYXRoIiwiZnMiLCJyZWdpc3RlckNvbnZlcnNpb25IYW5kbGVycyIsImhhbmRsZSIsImV2ZW50IiwiaW5wdXQiLCJvcHRpb25zIiwiZmlsZVR5cGUiLCJ1c2VPY3IiLCJ1bmRlZmluZWQiLCJnZXRTZXR0aW5nVmFsdWUiLCJjb25zb2xlIiwibG9nIiwib2NyRW5hYmxlZCIsImRpcmVjdE9jciIsImVuYWJsZWQiLCJ0eXBlIiwiaXNQYXJlbnRVcmwiLCJjb252ZXJ0IiwiYnVmZmVyIiwib3JpZ2luYWxGaWxlTmFtZSIsImJ1ZmZlckxlbmd0aCIsImJ5dGVMZW5ndGgiLCJpc0FycmF5QnVmZmVyIiwiQXJyYXlCdWZmZXIiLCJpc1RlbXBvcmFyeSIsIkJ1ZmZlciIsImZyb20iLCJsZW5ndGgiLCJuYW1lIiwiaXNDb250ZW50IiwidGVtcERpciIsImpvaW4iLCJnZXRQYXRoIiwiZXhpc3RzU3luYyIsIm1rZGlyU3luYyIsInJlY3Vyc2l2ZSIsInRlbXBGaWxlUGF0aCIsIkRhdGUiLCJub3ciLCJ3cml0ZUZpbGVTeW5jIiwicmVzdWx0IiwiYmFzZW5hbWUiLCJ1bmxpbmtTeW5jIiwiY2xlYW51cEVycm9yIiwid2FybiIsIm1lc3NhZ2UiLCJjb250ZW50IiwiZXJyb3IiLCJpc1RyYW5zY3JpcHRpb25FcnJvciIsInN1Y2Nlc3MiLCJjYW5jZWxSZXF1ZXN0cyIsIm1vZHVsZSIsImV4cG9ydHMiXSwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9zcmMvZWxlY3Ryb24vaXBjL2hhbmRsZXJzL2NvbnZlcnNpb24vaW5kZXguanMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXHJcbiAqIENvbnZlcnNpb24gSVBDIEhhbmRsZXJzXHJcbiAqIEhhbmRsZXMgY29udmVyc2lvbi1yZWxhdGVkIElQQyBldmVudHMgYmV0d2VlbiByZW5kZXJlciBhbmQgbWFpbiBwcm9jZXNzXHJcbiAqL1xyXG5cclxuY29uc3QgeyBpcGNNYWluLCBhcHAgfSA9IHJlcXVpcmUoJ2VsZWN0cm9uJyk7XHJcbmNvbnN0IEVsZWN0cm9uQ29udmVyc2lvblNlcnZpY2UgPSByZXF1aXJlKCcuLi8uLi8uLi9zZXJ2aWNlcy9FbGVjdHJvbkNvbnZlcnNpb25TZXJ2aWNlJyk7XHJcbmNvbnN0IHsgZGlhbG9nIH0gPSByZXF1aXJlKCdlbGVjdHJvbicpO1xyXG5jb25zdCBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xyXG5jb25zdCBmcyA9IHJlcXVpcmUoJ2ZzJyk7XHJcblxyXG4vKipcclxuICogUmVnaXN0ZXIgY29udmVyc2lvbiBJUEMgaGFuZGxlcnNcclxuICovXHJcbmZ1bmN0aW9uIHJlZ2lzdGVyQ29udmVyc2lvbkhhbmRsZXJzKCkge1xyXG4gICAgLy8gSGFuZGxlIGZpbGUgY29udmVyc2lvbiByZXF1ZXN0c1xyXG4gICAgaXBjTWFpbi5oYW5kbGUoJ2NvZGV4OmNvbnZlcnQ6ZmlsZScsIGFzeW5jIChldmVudCwgaW5wdXQsIG9wdGlvbnMpID0+IHtcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICAvLyBHZXQgT0NSIHNldHRpbmcgZnJvbSBzZXR0aW5ncyBzdG9yZSBpZiBub3QgYWxyZWFkeSBwcm92aWRlZFxyXG4gICAgICAgICAgICBpZiAob3B0aW9ucyAmJiBvcHRpb25zLmZpbGVUeXBlID09PSAncGRmJyAmJiBvcHRpb25zLnVzZU9jciA9PT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCB7IGdldFNldHRpbmdWYWx1ZSB9ID0gcmVxdWlyZSgnLi4vc2V0dGluZ3MnKTtcclxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbQ29udmVyc2lvbiBIYW5kbGVyXSBHZXR0aW5nIE9DUiBzZXR0aW5nIGZyb20gc2V0dGluZ3Mgc3RvcmVgKTtcclxuICAgICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAgICAgLy8gQ2hlY2sgYm90aCB3YXlzIG9mIGFjY2Vzc2luZyB0aGUgc2V0dGluZ1xyXG4gICAgICAgICAgICAgICAgY29uc3Qgb2NyRW5hYmxlZCA9IGF3YWl0IGdldFNldHRpbmdWYWx1ZSgnb2NyLmVuYWJsZWQnLCBmYWxzZSk7XHJcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgW0NvbnZlcnNpb24gSGFuZGxlcl0gT0NSIHNldHRpbmcgZnJvbSBzZXR0aW5ncyBzdG9yZTogJHtvY3JFbmFibGVkfSAodHlwZTogJHt0eXBlb2Ygb2NyRW5hYmxlZH0pYCk7XHJcbiAgICAgICAgICAgICAgICBcclxuICAgICAgICAgICAgICAgIC8vIEFsc28gY2hlY2sgdGhlIGRpcmVjdCBzZXR0aW5nXHJcbiAgICAgICAgICAgICAgICBjb25zdCBkaXJlY3RPY3IgPSBhd2FpdCBnZXRTZXR0aW5nVmFsdWUoJ29jcicsIHsgZW5hYmxlZDogZmFsc2UgfSk7XHJcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgW0NvbnZlcnNpb24gSGFuZGxlcl0gRGlyZWN0IE9DUiBvYmplY3QgZnJvbSBzZXR0aW5ncyBzdG9yZTpgLCBkaXJlY3RPY3IpO1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFtDb252ZXJzaW9uIEhhbmRsZXJdIERpcmVjdCBPQ1IgZW5hYmxlZCB2YWx1ZTogJHtkaXJlY3RPY3IuZW5hYmxlZH0gKHR5cGU6ICR7dHlwZW9mIGRpcmVjdE9jci5lbmFibGVkfSlgKTtcclxuICAgICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAgICAgb3B0aW9ucy51c2VPY3IgPSBvY3JFbmFibGVkO1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFtDb252ZXJzaW9uIEhhbmRsZXJdIFBERiBjb252ZXJzaW9uIHdpdGggT0NSICR7b2NyRW5hYmxlZCA/ICdlbmFibGVkJyA6ICdkaXNhYmxlZCd9YCk7XHJcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgW0NvbnZlcnNpb24gSGFuZGxlcl0gRmluYWwgb3B0aW9uczpgLCBvcHRpb25zKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgLy8gSGFuZGxlIFVSTCBjb252ZXJzaW9uc1xyXG4gICAgICAgICAgICBpZiAob3B0aW9ucyAmJiAob3B0aW9ucy50eXBlID09PSAndXJsJyB8fCBvcHRpb25zLnR5cGUgPT09ICdwYXJlbnR1cmwnKSkge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgaXNQYXJlbnRVcmwgPSBvcHRpb25zLnR5cGUgPT09ICdwYXJlbnR1cmwnO1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coYElQQzogUHJvY2Vzc2luZyAke2lzUGFyZW50VXJsID8gJ3BhcmVudCBVUkwnIDogJ1VSTCd9IGNvbnZlcnNpb246ICR7aW5wdXR9YCk7XHJcbiAgICAgICAgICAgICAgICBcclxuICAgICAgICAgICAgICAgIC8vIFByZXNlcnZlIGFsbCBvcHRpb25zLCBlc3BlY2lhbGx5IGZvciBwYXJlbnQgVVJMXHJcbiAgICAgICAgICAgICAgICByZXR1cm4gYXdhaXQgRWxlY3Ryb25Db252ZXJzaW9uU2VydmljZS5jb252ZXJ0KGlucHV0LCB7XHJcbiAgICAgICAgICAgICAgICAgICAgLi4ub3B0aW9ucyxcclxuICAgICAgICAgICAgICAgICAgICB0eXBlOiBvcHRpb25zLnR5cGUgLy8gUHJlc2VydmUgb3JpZ2luYWwgdHlwZSAodXJsL3BhcmVudHVybClcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAvLyBIYW5kbGUgYnVmZmVyIGlucHV0IGZvciBiaW5hcnkgZmlsZXMgKGF1ZGlvL3ZpZGVvL3BkZi94bHN4KVxyXG4gICAgICAgICAgICBpZiAob3B0aW9ucyAmJiBvcHRpb25zLmJ1ZmZlcikge1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coYElQQzogUHJvY2Vzc2luZyBiaW5hcnkgZmlsZSBvZiB0eXBlICR7b3B0aW9ucy50eXBlIHx8ICd1bmtub3duJ306ICR7b3B0aW9ucy5vcmlnaW5hbEZpbGVOYW1lIHx8ICd1bm5hbWVkJ31gKTtcclxuICAgICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAgICAgLy8gTG9nIGJ1ZmZlciBkZXRhaWxzIHRvIGhlbHAgZGlhZ25vc2UgaXNzdWVzXHJcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnSVBDOiBCdWZmZXIgZGV0YWlsczonLCB7XHJcbiAgICAgICAgICAgICAgICAgICAgYnVmZmVyTGVuZ3RoOiBvcHRpb25zLmJ1ZmZlci5ieXRlTGVuZ3RoLFxyXG4gICAgICAgICAgICAgICAgICAgIGlzQXJyYXlCdWZmZXI6IG9wdGlvbnMuYnVmZmVyIGluc3RhbmNlb2YgQXJyYXlCdWZmZXIsXHJcbiAgICAgICAgICAgICAgICAgICAgdHlwZTogb3B0aW9ucy50eXBlLFxyXG4gICAgICAgICAgICAgICAgICAgIG9yaWdpbmFsRmlsZU5hbWU6IG9wdGlvbnMub3JpZ2luYWxGaWxlTmFtZSxcclxuICAgICAgICAgICAgICAgICAgICBpc1RlbXBvcmFyeTogb3B0aW9ucy5pc1RlbXBvcmFyeVxyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICBcclxuICAgICAgICAgICAgICAgIC8vIENvbnZlcnQgQXJyYXlCdWZmZXIgdG8gQnVmZmVyXHJcbiAgICAgICAgICAgICAgICBjb25zdCBidWZmZXIgPSBCdWZmZXIuZnJvbShvcHRpb25zLmJ1ZmZlcik7XHJcbiAgICAgICAgICAgICAgICBcclxuICAgICAgICAgICAgICAgIC8vIFZlcmlmeSBidWZmZXIgd2FzIGNyZWF0ZWQgY29ycmVjdGx5XHJcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgSVBDOiBDcmVhdGVkIEJ1ZmZlciBvZiBsZW5ndGggJHtidWZmZXIubGVuZ3RofWApO1xyXG4gICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICByZXR1cm4gYXdhaXQgRWxlY3Ryb25Db252ZXJzaW9uU2VydmljZS5jb252ZXJ0KGJ1ZmZlciwge1xyXG4gICAgICAgICAgICAgICAgICAgIC4uLm9wdGlvbnMsXHJcbiAgICAgICAgICAgICAgICAgICAgbmFtZTogb3B0aW9ucy5vcmlnaW5hbEZpbGVOYW1lLFxyXG4gICAgICAgICAgICAgICAgICAgIGlzVGVtcG9yYXJ5OiB0cnVlXHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgLy8gSGFuZGxlIENTViBjb250ZW50IGRpcmVjdGx5ICh3aGVuIGlzQ29udGVudCBmbGFnIGlzIHNldClcclxuICAgICAgICAgICAgaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy5pc0NvbnRlbnQgJiYgb3B0aW9ucy50eXBlID09PSAnY3N2Jykge1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coYElQQzogUHJvY2Vzc2luZyBDU1YgY29udGVudCBkaXJlY3RseTogJHtvcHRpb25zLm9yaWdpbmFsRmlsZU5hbWUgfHwgJ3VubmFtZWQnfWApO1xyXG4gICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICAvLyBDcmVhdGUgYSB0ZW1wb3JhcnkgZmlsZSB3aXRoIHRoZSBDU1YgY29udGVudFxyXG4gICAgICAgICAgICAgICAgY29uc3QgdGVtcERpciA9IHBhdGguam9pbihhcHAuZ2V0UGF0aCgndGVtcCcpLCAnY29kZXgtbWQtdGVtcCcpO1xyXG4gICAgICAgICAgICAgICAgaWYgKCFmcy5leGlzdHNTeW5jKHRlbXBEaXIpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZnMubWtkaXJTeW5jKHRlbXBEaXIsIHsgcmVjdXJzaXZlOiB0cnVlIH0pO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICBjb25zdCB0ZW1wRmlsZVBhdGggPSBwYXRoLmpvaW4odGVtcERpciwgYHRlbXBfJHtEYXRlLm5vdygpfS5jc3ZgKTtcclxuICAgICAgICAgICAgICAgIGZzLndyaXRlRmlsZVN5bmModGVtcEZpbGVQYXRoLCBpbnB1dCk7XHJcbiAgICAgICAgICAgICAgICBcclxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBJUEM6IENyZWF0ZWQgdGVtcG9yYXJ5IENTViBmaWxlOiAke3RlbXBGaWxlUGF0aH1gKTtcclxuICAgICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAgICAgLy8gQ29udmVydCB0aGUgdGVtcG9yYXJ5IGZpbGVcclxuICAgICAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IEVsZWN0cm9uQ29udmVyc2lvblNlcnZpY2UuY29udmVydCh0ZW1wRmlsZVBhdGgsIHtcclxuICAgICAgICAgICAgICAgICAgICAuLi5vcHRpb25zLFxyXG4gICAgICAgICAgICAgICAgICAgIG9yaWdpbmFsRmlsZU5hbWU6IG9wdGlvbnMub3JpZ2luYWxGaWxlTmFtZSB8fCBvcHRpb25zLm5hbWUsXHJcbiAgICAgICAgICAgICAgICAgICAgbmFtZTogb3B0aW9ucy5vcmlnaW5hbEZpbGVOYW1lIHx8IG9wdGlvbnMubmFtZSB8fCBwYXRoLmJhc2VuYW1lKHRlbXBGaWxlUGF0aClcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICAvLyBDbGVhbiB1cCB0aGUgdGVtcG9yYXJ5IGZpbGVcclxuICAgICAgICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZnMudW5saW5rU3luYyh0ZW1wRmlsZVBhdGgpO1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBJUEM6IFJlbW92ZWQgdGVtcG9yYXJ5IENTViBmaWxlOiAke3RlbXBGaWxlUGF0aH1gKTtcclxuICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGNsZWFudXBFcnJvcikge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybihgSVBDOiBGYWlsZWQgdG8gcmVtb3ZlIHRlbXBvcmFyeSBDU1YgZmlsZTogJHtjbGVhbnVwRXJyb3IubWVzc2FnZX1gKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgLy8gSGFuZGxlIHRleHQgY29udGVudFxyXG4gICAgICAgICAgICBpZiAob3B0aW9ucyAmJiBvcHRpb25zLmNvbnRlbnQpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBhd2FpdCBFbGVjdHJvbkNvbnZlcnNpb25TZXJ2aWNlLmNvbnZlcnQob3B0aW9ucy5jb250ZW50LCB7XHJcbiAgICAgICAgICAgICAgICAgICAgLi4ub3B0aW9ucyxcclxuICAgICAgICAgICAgICAgICAgICBuYW1lOiBvcHRpb25zLm9yaWdpbmFsRmlsZU5hbWVcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAvLyBIYW5kbGUgZmlsZSBwYXRoc1xyXG4gICAgICAgICAgICAvLyBGb3IgUERGIGZpbGVzLCBlbnN1cmUgT0NSIHNldHRpbmcgaXMgaW5jbHVkZWRcclxuICAgICAgICAgICAgaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy5maWxlVHlwZSA9PT0gJ3BkZicpIHtcclxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBJUEM6IFByb2Nlc3NpbmcgUERGIGZpbGUgd2l0aCBPQ1IgJHtvcHRpb25zLnVzZU9jciA/ICdlbmFibGVkJyA6ICdkaXNhYmxlZCd9YCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIGF3YWl0IEVsZWN0cm9uQ29udmVyc2lvblNlcnZpY2UuY29udmVydChpbnB1dCwgb3B0aW9ucyk7XHJcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgICAgICAgY29uc29sZS5lcnJvcignQ29udmVyc2lvbiBlcnJvcjonLCBlcnJvcik7XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAvLyBDaGVjayBpZiB0aGlzIGlzIGEgdHJhbnNjcmlwdGlvbiBlcnJvclxyXG4gICAgICAgICAgICBpZiAoZXJyb3IuaXNUcmFuc2NyaXB0aW9uRXJyb3IpIHtcclxuICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ1RyYW5zY3JpcHRpb24gZXJyb3IgZGV0ZWN0ZWQ6JywgZXJyb3IubWVzc2FnZSk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxyXG4gICAgICAgICAgICAgICAgICAgIGVycm9yOiBlcnJvci5tZXNzYWdlLFxyXG4gICAgICAgICAgICAgICAgICAgIGlzVHJhbnNjcmlwdGlvbkVycm9yOiB0cnVlIC8vIEFkZCBhIGZsYWcgdG8gaW5kaWNhdGUgdGhpcyBpcyBhIHRyYW5zY3JpcHRpb24gZXJyb3JcclxuICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgICAgICBzdWNjZXNzOiBmYWxzZSxcclxuICAgICAgICAgICAgICAgIGVycm9yOiBlcnJvci5tZXNzYWdlXHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgfVxyXG4gICAgfSk7XHJcblxyXG4gICAgLy8gRGlyZWN0b3J5IHNlbGVjdGlvbiBpcyBub3cgaGFuZGxlZCBieSBmaWxlc3lzdGVtL2luZGV4LmpzXHJcbiAgICBcclxuICAgIC8vIEhhbmRsZSBjYW5jZWwgY29udmVyc2lvbiByZXF1ZXN0c1xyXG4gICAgaXBjTWFpbi5oYW5kbGUoJ2NvZGV4OmNvbnZlcnQ6Y2FuY2VsJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIGF3YWl0IEVsZWN0cm9uQ29udmVyc2lvblNlcnZpY2UuY2FuY2VsUmVxdWVzdHMoKTtcclxuICAgICAgICAgICAgcmV0dXJuIHsgc3VjY2VzczogdHJ1ZSB9O1xyXG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ0NhbmNlbCByZXF1ZXN0cyBlcnJvcjonLCBlcnJvcik7XHJcbiAgICAgICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgICAgICBzdWNjZXNzOiBmYWxzZSxcclxuICAgICAgICAgICAgICAgIGVycm9yOiBlcnJvci5tZXNzYWdlXHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgfVxyXG4gICAgfSk7XHJcbn1cclxuXHJcbm1vZHVsZS5leHBvcnRzID0ge1xyXG4gICAgcmVnaXN0ZXJDb252ZXJzaW9uSGFuZGxlcnNcclxufTtcclxuIl0sIm1hcHBpbmdzIjoiOztBQUFBO0FBQ0E7QUFDQTtBQUNBOztBQUVBLE1BQU07RUFBRUEsT0FBTztFQUFFQztBQUFJLENBQUMsR0FBR0MsT0FBTyxDQUFDLFVBQVUsQ0FBQztBQUM1QyxNQUFNQyx5QkFBeUIsR0FBR0QsT0FBTyxDQUFDLDZDQUE2QyxDQUFDO0FBQ3hGLE1BQU07RUFBRUU7QUFBTyxDQUFDLEdBQUdGLE9BQU8sQ0FBQyxVQUFVLENBQUM7QUFDdEMsTUFBTUcsSUFBSSxHQUFHSCxPQUFPLENBQUMsTUFBTSxDQUFDO0FBQzVCLE1BQU1JLEVBQUUsR0FBR0osT0FBTyxDQUFDLElBQUksQ0FBQzs7QUFFeEI7QUFDQTtBQUNBO0FBQ0EsU0FBU0ssMEJBQTBCQSxDQUFBLEVBQUc7RUFDbEM7RUFDQVAsT0FBTyxDQUFDUSxNQUFNLENBQUMsb0JBQW9CLEVBQUUsT0FBT0MsS0FBSyxFQUFFQyxLQUFLLEVBQUVDLE9BQU8sS0FBSztJQUNsRSxJQUFJO01BQ0E7TUFDQSxJQUFJQSxPQUFPLElBQUlBLE9BQU8sQ0FBQ0MsUUFBUSxLQUFLLEtBQUssSUFBSUQsT0FBTyxDQUFDRSxNQUFNLEtBQUtDLFNBQVMsRUFBRTtRQUN2RSxNQUFNO1VBQUVDO1FBQWdCLENBQUMsR0FBR2IsT0FBTyxDQUFDLGFBQWEsQ0FBQztRQUNsRGMsT0FBTyxDQUFD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LElBQUluQyxPQUFPLElBQUlBLE9BQU8sQ0FBQ3lDLE9BQU8sRUFBRTtRQUM1QixPQUFPLE1BQU1qRCx5QkFBeUIsQ0FBQ29CLE9BQU8sQ0FBQ1osT0FBTyxDQUFDeUMsT0FBTyxFQUFFO1VBQzVELEdBQUd6QyxPQUFPO1VBQ1Z1QixJQUFJLEVBQUV2QixPQUFPLENBQUNjO1FBQ2xCLENBQUMsQ0FBQztNQUNOOztNQUVBO01BQ0E7TUFDQSxJQUFJZCxPQUFPLElBQUlBLE9BQU8sQ0FBQ0MsUUFBUSxLQUFLLEtBQUssRUFBRTtRQUN2Q0ksT0FBTyxDQUFDQyxHQUFHLENBQUMscUNBQXFDTixPQUFPLENBQUNFLE1BQU0sR0FBRyxTQUFTLEdBQUcsVUFBVSxFQUFFLENBQUM7TUFDL0Y7TUFDQSxPQUFPLE1BQU1WLHlCQUF5QixDQUFDb0IsT0FBTyxDQUFDYixLQUFLLEVBQUVDLE9BQU8sQ0FBQztJQUNsRSxDQUFDLENBQUMsT0FBTzBDLEtBQUssRUFBRTtNQUNackMsT0FBTyxDQUFDcUMsS0FBSyxDQUFDLG1CQUFtQixFQUFFQSxLQUFLLENBQUM7O01BRXpDO01BQ0EsSUFBSUEsS0FBSyxDQUFDQyxvQkFBb0IsRUFBRTtRQUM1QnRDLE9BQU8sQ0FBQ3FDLEtBQUssQ0FBQywrQkFBK0IsRUFBRUEsS0FBSyxDQUFDRixPQUFPLENBQUM7UUFDN0QsT0FBTztVQUNISSxPQUFPLEVBQUUsS0FBSztVQUNkRixLQUFLLEVBQUVBLEtBQUssQ0FBQ0YsT0FBTztVQUNwQkcsb0JBQW9CLEVBQUUsSUFBSSxDQUFDO1FBQy9CLENBQUM7TUFDTDtNQUVBLE9BQU87UUFDSEMsT0FBTyxFQUFFLEtBQUs7UUFDZEYsS0FBSyxFQUFFQSxLQUFLLENBQUNGO01BQ2pCLENBQUM7SUFDTDtFQUNKLENBQUMsQ0FBQzs7RUFFRjs7RUFFQTtFQUNBbkQsT0FBTyxDQUFDUSxNQUFNLENBQUMsc0JBQXNCLEVBQUUsWUFBWTtJQUMvQyxJQUFJO01BQ0EsTUFBTUwseUJBQXlCLENBQUNxRCxjQUFjLENBQUMsQ0FBQztNQUNoRCxPQUFPO1FBQUVELE9BQU8sRUFBRTtNQUFLLENBQUM7SUFDNUIsQ0FBQyxDQUFDLE9BQU9GLEtBQUssRUFBRTtNQUNackMsT0FBTyxDQUFDcUMsS0FBSyxDQUFDLHdCQUF3QixFQUFFQSxLQUFLLENBQUM7TUFDOUMsT0FBTztRQUNIRSxPQUFPLEVBQUUsS0FBSztRQUNkRixLQUFLLEVBQUVBLEtBQUssQ0FBQ0Y7TUFDakIsQ0FBQztJQUNMO0VBQ0osQ0FBQyxDQUFDO0FBQ047QUFFQU0sTUFBTSxDQUFDQyxPQUFPLEdBQUc7RUFDYm5EO0FBQ0osQ0FBQyIsImlnbm9yZUxpc3QiOltdfQ==