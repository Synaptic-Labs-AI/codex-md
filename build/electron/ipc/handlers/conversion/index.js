"use strict";

/**
 * Conversion IPC Handlers
 * Handles conversion-related IPC events between renderer and main process
 */

const {
  ipcMain,
  app
} = require('electron');
const ElectronConversionService = require('../../../services/ElectronConversionService');
const {
  dialog
} = require('electron');
const path = require('path');
const fs = require('fs');

/**
 * Register conversion IPC handlers
 */
function registerConversionHandlers() {
  // Handle file conversion requests
  ipcMain.handle('codex:convert:file', async (event, input, options) => {
    try {
      // Get OCR setting from settings store if not already provided
      if (options && options.fileType === 'pdf' && options.useOcr === undefined) {
        const {
          getSettingValue
        } = require('../settings');
        console.log(`[Conversion Handler] Getting OCR setting from settings store`);

        // Check both ways of accessing the setting
        const ocrEnabled = await getSettingValue('ocr.enabled', false);
        console.log(`[Conversion Handler] OCR setting from settings store: ${ocrEnabled} (type: ${typeof ocrEnabled})`);

        // Also check the direct setting
        const directOcr = await getSettingValue('ocr', {
          enabled: false
        });
        console.log(`[Conversion Handler] Direct OCR object from settings store:`, directOcr);
        console.log(`[Conversion Handler] Direct OCR enabled value: ${directOcr.enabled} (type: ${typeof directOcr.enabled})`);
        options.useOcr = ocrEnabled;
        console.log(`[Conversion Handler] PDF conversion with OCR ${ocrEnabled ? 'enabled' : 'disabled'}`);
        console.log(`[Conversion Handler] Final options:`, options);
      }

      // Handle URL conversions
      if (options && (options.type === 'url' || options.type === 'parenturl')) {
        const isParentUrl = options.type === 'parenturl';
        console.log(`IPC: Processing ${isParentUrl ? 'parent URL' : 'URL'} conversion: ${input}`);

        // Preserve all options, especially for parent URL
        return await ElectronConversionService.convert(input, {
          ...options,
          type: options.type // Preserve original type (url/parenturl)
        });
      }

      // Handle buffer input for binary files (audio/video/pdf/xlsx)
      if (options && options.buffer) {
        console.log(`IPC: Processing binary file of type ${options.type || 'unknown'}: ${options.originalFileName || 'unnamed'}`);

        // Log buffer details to help diagnose issues
        console.log('IPC: Buffer details:', {
          bufferLength: options.buffer.byteLength,
          isArrayBuffer: options.buffer instanceof ArrayBuffer,
          type: options.type,
          originalFileName: options.originalFileName,
          isTemporary: options.isTemporary
        });

        // Convert ArrayBuffer to Buffer
        const buffer = Buffer.from(options.buffer);

        // Verify buffer was created correctly
        console.log(`IPC: Created Buffer of length ${buffer.length}`);
        return await ElectronConversionService.convert(buffer, {
          ...options,
          name: options.originalFileName,
          isTemporary: true
        });
      }

      // Handle CSV content directly (when isContent flag is set)
      if (options && options.isContent && options.type === 'csv') {
        console.log(`IPC: Processing CSV content directly: ${options.originalFileName || 'unnamed'}`);

        // Create a temporary file with the CSV content
        const tempDir = path.join(app.getPath('temp'), 'codex-md-temp');
        if (!fs.existsSync(tempDir)) {
          fs.mkdirSync(tempDir, {
            recursive: true
          });
        }
        const tempFilePath = path.join(tempDir, `temp_${Date.now()}.csv`);
        fs.writeFileSync(tempFilePath, input);
        console.log(`IPC: Created temporary CSV file: ${tempFilePath}`);

        // Convert the temporary file
        const result = await ElectronConversionService.convert(tempFilePath, {
          ...options,
          originalFileName: options.originalFileName || options.name,
          name: options.originalFileName || options.name || path.basename(tempFilePath)
        });

        // Clean up the temporary file
        try {
          fs.unlinkSync(tempFilePath);
          console.log(`IPC: Removed temporary CSV file: ${tempFilePath}`);
        } catch (cleanupError) {
          console.warn(`IPC: Failed to remove temporary CSV file: ${cleanupError.message}`);
        }
        return result;
      }

      // Handle text content
      if (options && options.content) {
        return await ElectronConversionService.convert(options.content, {
          ...options,
          name: options.originalFileName
        });
      }

      // Handle file paths
      // For PDF files, ensure OCR setting is included
      if (options && options.fileType === 'pdf') {
        console.log(`IPC: Processing PDF file with OCR ${options.useOcr ? 'enabled' : 'disabled'}`);
      }
      return await ElectronConversionService.convert(input, options);
    } catch (error) {
      console.error('Conversion error:', error);
      return {
        success: false,
        error: error.message
      };
    }
  });

  // Directory selection is now handled by filesystem/index.js

  // Handle cancel conversion requests
  ipcMain.handle('codex:convert:cancel', async () => {
    try {
      await ElectronConversionService.cancelRequests();
      return {
        success: true
      };
    } catch (error) {
      console.error('Cancel requests error:', error);
      return {
        success: false,
        error: error.message
      };
    }
  });
}
module.exports = {
  registerConversionHandlers
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJpcGNNYWluIiwiYXBwIiwicmVxdWlyZSIsIkVsZWN0cm9uQ29udmVyc2lvblNlcnZpY2UiLCJkaWFsb2ciLCJwYXRoIiwiZnMiLCJyZWdpc3RlckNvbnZlcnNpb25IYW5kbGVycyIsImhhbmRsZSIsImV2ZW50IiwiaW5wdXQiLCJvcHRpb25zIiwiZmlsZVR5cGUiLCJ1c2VPY3IiLCJ1bmRlZmluZWQiLCJnZXRTZXR0aW5nVmFsdWUiLCJjb25zb2xlIiwibG9nIiwib2NyRW5hYmxlZCIsImRpcmVjdE9jciIsImVuYWJsZWQiLCJ0eXBlIiwiaXNQYXJlbnRVcmwiLCJjb252ZXJ0IiwiYnVmZmVyIiwib3JpZ2luYWxGaWxlTmFtZSIsImJ1ZmZlckxlbmd0aCIsImJ5dGVMZW5ndGgiLCJpc0FycmF5QnVmZmVyIiwiQXJyYXlCdWZmZXIiLCJpc1RlbXBvcmFyeSIsIkJ1ZmZlciIsImZyb20iLCJsZW5ndGgiLCJuYW1lIiwiaXNDb250ZW50IiwidGVtcERpciIsImpvaW4iLCJnZXRQYXRoIiwiZXhpc3RzU3luYyIsIm1rZGlyU3luYyIsInJlY3Vyc2l2ZSIsInRlbXBGaWxlUGF0aCIsIkRhdGUiLCJub3ciLCJ3cml0ZUZpbGVTeW5jIiwicmVzdWx0IiwiYmFzZW5hbWUiLCJ1bmxpbmtTeW5jIiwiY2xlYW51cEVycm9yIiwid2FybiIsIm1lc3NhZ2UiLCJjb250ZW50IiwiZXJyb3IiLCJzdWNjZXNzIiwiY2FuY2VsUmVxdWVzdHMiLCJtb2R1bGUiLCJleHBvcnRzIl0sInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vc3JjL2VsZWN0cm9uL2lwYy9oYW5kbGVycy9jb252ZXJzaW9uL2luZGV4LmpzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxyXG4gKiBDb252ZXJzaW9uIElQQyBIYW5kbGVyc1xyXG4gKiBIYW5kbGVzIGNvbnZlcnNpb24tcmVsYXRlZCBJUEMgZXZlbnRzIGJldHdlZW4gcmVuZGVyZXIgYW5kIG1haW4gcHJvY2Vzc1xyXG4gKi9cclxuXHJcbmNvbnN0IHsgaXBjTWFpbiwgYXBwIH0gPSByZXF1aXJlKCdlbGVjdHJvbicpO1xyXG5jb25zdCBFbGVjdHJvbkNvbnZlcnNpb25TZXJ2aWNlID0gcmVxdWlyZSgnLi4vLi4vLi4vc2VydmljZXMvRWxlY3Ryb25Db252ZXJzaW9uU2VydmljZScpO1xyXG5jb25zdCB7IGRpYWxvZyB9ID0gcmVxdWlyZSgnZWxlY3Ryb24nKTtcclxuY29uc3QgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKTtcclxuY29uc3QgZnMgPSByZXF1aXJlKCdmcycpO1xyXG5cclxuLyoqXHJcbiAqIFJlZ2lzdGVyIGNvbnZlcnNpb24gSVBDIGhhbmRsZXJzXHJcbiAqL1xyXG5mdW5jdGlvbiByZWdpc3RlckNvbnZlcnNpb25IYW5kbGVycygpIHtcclxuICAgIC8vIEhhbmRsZSBmaWxlIGNvbnZlcnNpb24gcmVxdWVzdHNcclxuICAgIGlwY01haW4uaGFuZGxlKCdjb2RleDpjb252ZXJ0OmZpbGUnLCBhc3luYyAoZXZlbnQsIGlucHV0LCBvcHRpb25zKSA9PiB7XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgLy8gR2V0IE9DUiBzZXR0aW5nIGZyb20gc2V0dGluZ3Mgc3RvcmUgaWYgbm90IGFscmVhZHkgcHJvdmlkZWRcclxuICAgICAgICAgICAgaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy5maWxlVHlwZSA9PT0gJ3BkZicgJiYgb3B0aW9ucy51c2VPY3IgPT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgeyBnZXRTZXR0aW5nVmFsdWUgfSA9IHJlcXVpcmUoJy4uL3NldHRpbmdzJyk7XHJcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgW0NvbnZlcnNpb24gSGFuZGxlcl0gR2V0dGluZyBPQ1Igc2V0dGluZyBmcm9tIHNldHRpbmdzIHN0b3JlYCk7XHJcbiAgICAgICAgICAgICAgICBcclxuICAgICAgICAgICAgICAgIC8vIENoZWNrIGJvdGggd2F5cyBvZiBhY2Nlc3NpbmcgdGhlIHNldHRpbmdcclxuICAgICAgICAgICAgICAgIGNvbnN0IG9jckVuYWJsZWQgPSBhd2FpdCBnZXRTZXR0aW5nVmFsdWUoJ29jci5lbmFibGVkJywgZmFsc2UpO1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFtDb252ZXJzaW9uIEhhbmRsZXJdIE9DUiBzZXR0aW5nIGZyb20gc2V0dGluZ3Mgc3RvcmU6ICR7b2NyRW5hYmxlZH0gKHR5cGU6ICR7dHlwZW9mIG9jckVuYWJsZWR9KWApO1xyXG4gICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICAvLyBBbHNvIGNoZWNrIHRoZSBkaXJlY3Qgc2V0dGluZ1xyXG4gICAgICAgICAgICAgICAgY29uc3QgZGlyZWN0T2NyID0gYXdhaXQgZ2V0U2V0dGluZ1ZhbHVlKCdvY3InLCB7IGVuYWJsZWQ6IGZhbHNlIH0pO1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFtDb252ZXJzaW9uIEhhbmRsZXJdIERpcmVjdCBPQ1Igb2JqZWN0IGZyb20gc2V0dGluZ3Mgc3RvcmU6YCwgZGlyZWN0T2NyKTtcclxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbQ29udmVyc2lvbiBIYW5kbGVyXSBEaXJlY3QgT0NSIGVuYWJsZWQgdmFsdWU6ICR7ZGlyZWN0T2NyLmVuYWJsZWR9ICh0eXBlOiAke3R5cGVvZiBkaXJlY3RPY3IuZW5hYmxlZH0pYCk7XHJcbiAgICAgICAgICAgICAgICBcclxuICAgICAgICAgICAgICAgIG9wdGlvbnMudXNlT2NyID0gb2NyRW5hYmxlZDtcclxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbQ29udmVyc2lvbiBIYW5kbGVyXSBQREYgY29udmVyc2lvbiB3aXRoIE9DUiAke29jckVuYWJsZWQgPyAnZW5hYmxlZCcgOiAnZGlzYWJsZWQnfWApO1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFtDb252ZXJzaW9uIEhhbmRsZXJdIEZpbmFsIG9wdGlvbnM6YCwgb3B0aW9ucyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIC8vIEhhbmRsZSBVUkwgY29udmVyc2lvbnNcclxuICAgICAgICAgICAgaWYgKG9wdGlvbnMgJiYgKG9wdGlvbnMudHlwZSA9PT0gJ3VybCcgfHwgb3B0aW9ucy50eXBlID09PSAncGFyZW50dXJsJykpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGlzUGFyZW50VXJsID0gb3B0aW9ucy50eXBlID09PSAncGFyZW50dXJsJztcclxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBJUEM6IFByb2Nlc3NpbmcgJHtpc1BhcmVudFVybCA/ICdwYXJlbnQgVVJMJyA6ICdVUkwnfSBjb252ZXJzaW9uOiAke2lucHV0fWApO1xyXG4gICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICAvLyBQcmVzZXJ2ZSBhbGwgb3B0aW9ucywgZXNwZWNpYWxseSBmb3IgcGFyZW50IFVSTFxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGF3YWl0IEVsZWN0cm9uQ29udmVyc2lvblNlcnZpY2UuY29udmVydChpbnB1dCwge1xyXG4gICAgICAgICAgICAgICAgICAgIC4uLm9wdGlvbnMsXHJcbiAgICAgICAgICAgICAgICAgICAgdHlwZTogb3B0aW9ucy50eXBlIC8vIFByZXNlcnZlIG9yaWdpbmFsIHR5cGUgKHVybC9wYXJlbnR1cmwpXHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgLy8gSGFuZGxlIGJ1ZmZlciBpbnB1dCBmb3IgYmluYXJ5IGZpbGVzIChhdWRpby92aWRlby9wZGYveGxzeClcclxuICAgICAgICAgICAgaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy5idWZmZXIpIHtcclxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBJUEM6IFByb2Nlc3NpbmcgYmluYXJ5IGZpbGUgb2YgdHlwZSAke29wdGlvbnMudHlwZSB8fCAndW5rbm93bid9OiAke29wdGlvbnMub3JpZ2luYWxGaWxlTmFtZSB8fCAndW5uYW1lZCd9YCk7XHJcbiAgICAgICAgICAgICAgICBcclxuICAgICAgICAgICAgICAgIC8vIExvZyBidWZmZXIgZGV0YWlscyB0byBoZWxwIGRpYWdub3NlIGlzc3Vlc1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ0lQQzogQnVmZmVyIGRldGFpbHM6Jywge1xyXG4gICAgICAgICAgICAgICAgICAgIGJ1ZmZlckxlbmd0aDogb3B0aW9ucy5idWZmZXIuYnl0ZUxlbmd0aCxcclxuICAgICAgICAgICAgICAgICAgICBpc0FycmF5QnVmZmVyOiBvcHRpb25zLmJ1ZmZlciBpbnN0YW5jZW9mIEFycmF5QnVmZmVyLFxyXG4gICAgICAgICAgICAgICAgICAgIHR5cGU6IG9wdGlvbnMudHlwZSxcclxuICAgICAgICAgICAgICAgICAgICBvcmlnaW5hbEZpbGVOYW1lOiBvcHRpb25zLm9yaWdpbmFsRmlsZU5hbWUsXHJcbiAgICAgICAgICAgICAgICAgICAgaXNUZW1wb3Jhcnk6IG9wdGlvbnMuaXNUZW1wb3JhcnlcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICAvLyBDb252ZXJ0IEFycmF5QnVmZmVyIHRvIEJ1ZmZlclxyXG4gICAgICAgICAgICAgICAgY29uc3QgYnVmZmVyID0gQnVmZmVyLmZyb20ob3B0aW9ucy5idWZmZXIpO1xyXG4gICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICAvLyBWZXJpZnkgYnVmZmVyIHdhcyBjcmVhdGVkIGNvcnJlY3RseVxyXG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coYElQQzogQ3JlYXRlZCBCdWZmZXIgb2YgbGVuZ3RoICR7YnVmZmVyLmxlbmd0aH1gKTtcclxuICAgICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGF3YWl0IEVsZWN0cm9uQ29udmVyc2lvblNlcnZpY2UuY29udmVydChidWZmZXIsIHtcclxuICAgICAgICAgICAgICAgICAgICAuLi5vcHRpb25zLFxyXG4gICAgICAgICAgICAgICAgICAgIG5hbWU6IG9wdGlvbnMub3JpZ2luYWxGaWxlTmFtZSxcclxuICAgICAgICAgICAgICAgICAgICBpc1RlbXBvcmFyeTogdHJ1ZVxyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIC8vIEhhbmRsZSBDU1YgY29udGVudCBkaXJlY3RseSAod2hlbiBpc0NvbnRlbnQgZmxhZyBpcyBzZXQpXHJcbiAgICAgICAgICAgIGlmIChvcHRpb25zICYmIG9wdGlvbnMuaXNDb250ZW50ICYmIG9wdGlvbnMudHlwZSA9PT0gJ2NzdicpIHtcclxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBJUEM6IFByb2Nlc3NpbmcgQ1NWIGNvbnRlbnQgZGlyZWN0bHk6ICR7b3B0aW9ucy5vcmlnaW5hbEZpbGVOYW1lIHx8ICd1bm5hbWVkJ31gKTtcclxuICAgICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAgICAgLy8gQ3JlYXRlIGEgdGVtcG9yYXJ5IGZpbGUgd2l0aCB0aGUgQ1NWIGNvbnRlbnRcclxuICAgICAgICAgICAgICAgIGNvbnN0IHRlbXBEaXIgPSBwYXRoLmpvaW4oYXBwLmdldFBhdGgoJ3RlbXAnKSwgJ2NvZGV4LW1kLXRlbXAnKTtcclxuICAgICAgICAgICAgICAgIGlmICghZnMuZXhpc3RzU3luYyh0ZW1wRGlyKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGZzLm1rZGlyU3luYyh0ZW1wRGlyLCB7IHJlY3Vyc2l2ZTogdHJ1ZSB9KTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAgICAgY29uc3QgdGVtcEZpbGVQYXRoID0gcGF0aC5qb2luKHRlbXBEaXIsIGB0ZW1wXyR7RGF0ZS5ub3coKX0uY3N2YCk7XHJcbiAgICAgICAgICAgICAgICBmcy53cml0ZUZpbGVTeW5jKHRlbXBGaWxlUGF0aCwgaW5wdXQpO1xyXG4gICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgSVBDOiBDcmVhdGVkIHRlbXBvcmFyeSBDU1YgZmlsZTogJHt0ZW1wRmlsZVBhdGh9YCk7XHJcbiAgICAgICAgICAgICAgICBcclxuICAgICAgICAgICAgICAgIC8vIENvbnZlcnQgdGhlIHRlbXBvcmFyeSBmaWxlXHJcbiAgICAgICAgICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBFbGVjdHJvbkNvbnZlcnNpb25TZXJ2aWNlLmNvbnZlcnQodGVtcEZpbGVQYXRoLCB7XHJcbiAgICAgICAgICAgICAgICAgICAgLi4ub3B0aW9ucyxcclxuICAgICAgICAgICAgICAgICAgICBvcmlnaW5hbEZpbGVOYW1lOiBvcHRpb25zLm9yaWdpbmFsRmlsZU5hbWUgfHwgb3B0aW9ucy5uYW1lLFxyXG4gICAgICAgICAgICAgICAgICAgIG5hbWU6IG9wdGlvbnMub3JpZ2luYWxGaWxlTmFtZSB8fCBvcHRpb25zLm5hbWUgfHwgcGF0aC5iYXNlbmFtZSh0ZW1wRmlsZVBhdGgpXHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAgICAgLy8gQ2xlYW4gdXAgdGhlIHRlbXBvcmFyeSBmaWxlXHJcbiAgICAgICAgICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICAgICAgICAgIGZzLnVubGlua1N5bmModGVtcEZpbGVQYXRoKTtcclxuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgSVBDOiBSZW1vdmVkIHRlbXBvcmFyeSBDU1YgZmlsZTogJHt0ZW1wRmlsZVBhdGh9YCk7XHJcbiAgICAgICAgICAgICAgICB9IGNhdGNoIChjbGVhbnVwRXJyb3IpIHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oYElQQzogRmFpbGVkIHRvIHJlbW92ZSB0ZW1wb3JhcnkgQ1NWIGZpbGU6ICR7Y2xlYW51cEVycm9yLm1lc3NhZ2V9YCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBcclxuICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHQ7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIC8vIEhhbmRsZSB0ZXh0IGNvbnRlbnRcclxuICAgICAgICAgICAgaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy5jb250ZW50KSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gYXdhaXQgRWxlY3Ryb25Db252ZXJzaW9uU2VydmljZS5jb252ZXJ0KG9wdGlvbnMuY29udGVudCwge1xyXG4gICAgICAgICAgICAgICAgICAgIC4uLm9wdGlvbnMsXHJcbiAgICAgICAgICAgICAgICAgICAgbmFtZTogb3B0aW9ucy5vcmlnaW5hbEZpbGVOYW1lXHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgLy8gSGFuZGxlIGZpbGUgcGF0aHNcclxuICAgICAgICAgICAgLy8gRm9yIFBERiBmaWxlcywgZW5zdXJlIE9DUiBzZXR0aW5nIGlzIGluY2x1ZGVkXHJcbiAgICAgICAgICAgIGlmIChvcHRpb25zICYmIG9wdGlvbnMuZmlsZVR5cGUgPT09ICdwZGYnKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgSVBDOiBQcm9jZXNzaW5nIFBERiBmaWxlIHdpdGggT0NSICR7b3B0aW9ucy51c2VPY3IgPyAnZW5hYmxlZCcgOiAnZGlzYWJsZWQnfWApO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiBhd2FpdCBFbGVjdHJvbkNvbnZlcnNpb25TZXJ2aWNlLmNvbnZlcnQoaW5wdXQsIG9wdGlvbnMpO1xyXG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ0NvbnZlcnNpb24gZXJyb3I6JywgZXJyb3IpO1xyXG4gICAgICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICAgICAgc3VjY2VzczogZmFsc2UsXHJcbiAgICAgICAgICAgICAgICBlcnJvcjogZXJyb3IubWVzc2FnZVxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgIH1cclxuICAgIH0pO1xyXG5cclxuICAgIC8vIERpcmVjdG9yeSBzZWxlY3Rpb24gaXMgbm93IGhhbmRsZWQgYnkgZmlsZXN5c3RlbS9pbmRleC5qc1xyXG4gICAgXHJcbiAgICAvLyBIYW5kbGUgY2FuY2VsIGNvbnZlcnNpb24gcmVxdWVzdHNcclxuICAgIGlwY01haW4uaGFuZGxlKCdjb2RleDpjb252ZXJ0OmNhbmNlbCcsIGFzeW5jICgpID0+IHtcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICBhd2FpdCBFbGVjdHJvbkNvbnZlcnNpb25TZXJ2aWNlLmNhbmNlbFJlcXVlc3RzKCk7XHJcbiAgICAgICAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IHRydWUgfTtcclxuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKCdDYW5jZWwgcmVxdWVzdHMgZXJyb3I6JywgZXJyb3IpO1xyXG4gICAgICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICAgICAgc3VjY2VzczogZmFsc2UsXHJcbiAgICAgICAgICAgICAgICBlcnJvcjogZXJyb3IubWVzc2FnZVxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgIH1cclxuICAgIH0pO1xyXG59XHJcblxyXG5tb2R1bGUuZXhwb3J0cyA9IHtcclxuICAgIHJlZ2lzdGVyQ29udmVyc2lvbkhhbmRsZXJzXHJcbn07XHJcbiJdLCJtYXBwaW5ncyI6Ijs7QUFBQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQSxNQUFNO0VBQUVBLE9BQU87RUFBRUM7QUFBSSxDQUFDLEdBQUdDLE9BQU8sQ0FBQyxVQUFVLENBQUM7QUFDNUMsTUFBTUMseUJBQXlCLEdBQUdELE9BQU8sQ0FBQyw2Q0FBNkMsQ0FBQztBQUN4RixNQUFNO0VBQUVFO0FBQU8sQ0FBQyxHQUFHRixPQUFPLENB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