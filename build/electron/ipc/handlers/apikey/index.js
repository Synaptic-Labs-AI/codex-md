"use strict";

/**
 * API Key IPC Handlers
 * Implements handlers for API key management operations.
 *
 * Related files:
 * - services/ApiKeyService.js: API key storage and validation
 * - ipc/handlers.js: Handler registration
 * - preload.js: API exposure to renderer
 */

const {
  ipcMain
} = require('electron');
const apiKeyService = require('../../../services/ApiKeyService');
const {
  IPCChannels
} = require('../../types');

/**
 * Update environment variables with latest API keys
 * This ensures converters have access to the latest API keys
 */
function updateApiKeyEnvironment(provider, key) {
  try {
    // Map provider to environment variable name
    const envMap = {
      'mistral': 'MISTRAL_API_KEY',
      'deepgram': 'DEEPGRAM_API_KEY',
      'openai': 'OPENAI_API_KEY'
    };
    const envVar = envMap[provider];
    if (!envVar) return;

    // Update environment variable
    if (key) {
      process.env[envVar] = key;
      console.log(`✅ Updated ${envVar} environment variable`);
    } else {
      delete process.env[envVar];
      console.log(`❌ Removed ${envVar} environment variable`);
    }
  } catch (error) {
    console.error(`Error updating API key environment for ${provider}:`, error);
  }
}

/**
 * Register all API key related IPC handlers
 */
function registerApiKeyHandlers() {
  // Save API key
  ipcMain.handle('codex:apikey:save', async (event, {
    key,
    provider = 'openai'
  }) => {
    const result = await apiKeyService.saveApiKey(key, provider);

    // Update environment variable with the new key
    if (result.success) {
      updateApiKeyEnvironment(provider, key);
    }
    return result;
  });

  // Check if API key exists
  ipcMain.handle('codex:apikey:exists', async (event, {
    provider = 'openai'
  }) => {
    return {
      exists: apiKeyService.hasApiKey(provider)
    };
  });

  // Delete API key
  ipcMain.handle('codex:apikey:delete', async (event, {
    provider = 'openai'
  }) => {
    const result = apiKeyService.deleteApiKey(provider);

    // Remove environment variable when key is deleted
    if (result.success) {
      updateApiKeyEnvironment(provider, null);
    }
    return result;
  });

  // Validate API key
  ipcMain.handle('codex:apikey:validate', async (event, {
    key,
    provider = 'openai'
  }) => {
    return await apiKeyService.validateApiKey(key, provider);
  });

  // Get API key for internal use (only available to main process)
  ipcMain.handle('codex:apikey:get-for-service', async (event, {
    provider = 'openai'
  }) => {
    // Security check: only allow main process to access this
    const webContents = event.sender;
    if (webContents.getType() !== 'browserWindow') {
      return {
        success: false,
        error: 'Unauthorized access'
      };
    }
    const key = apiKeyService.getApiKey(provider);
    return {
      success: !!key,
      key
    };
  });
  console.log('API Key IPC handlers registered');
}

/**
 * Clean up any resources when the app is shutting down
 */
async function cleanupApiKeyHandlers() {
  // No cleanup needed for API key handlers
}
module.exports = {
  registerApiKeyHandlers,
  cleanupApiKeyHandlers
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJpcGNNYWluIiwicmVxdWlyZSIsImFwaUtleVNlcnZpY2UiLCJJUENDaGFubmVscyIsInVwZGF0ZUFwaUtleUVudmlyb25tZW50IiwicHJvdmlkZXIiLCJrZXkiLCJlbnZNYXAiLCJlbnZWYXIiLCJwcm9jZXNzIiwiZW52IiwiY29uc29sZSIsImxvZyIsImVycm9yIiwicmVnaXN0ZXJBcGlLZXlIYW5kbGVycyIsImhhbmRsZSIsImV2ZW50IiwicmVzdWx0Iiwic2F2ZUFwaUtleSIsInN1Y2Nlc3MiLCJleGlzdHMiLCJoYXNBcGlLZXkiLCJkZWxldGVBcGlLZXkiLCJ2YWxpZGF0ZUFwaUtleSIsIndlYkNvbnRlbnRzIiwic2VuZGVyIiwiZ2V0VHlwZSIsImdldEFwaUtleSIsImNsZWFudXBBcGlLZXlIYW5kbGVycyIsIm1vZHVsZSIsImV4cG9ydHMiXSwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9zcmMvZWxlY3Ryb24vaXBjL2hhbmRsZXJzL2FwaWtleS9pbmRleC5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcclxuICogQVBJIEtleSBJUEMgSGFuZGxlcnNcclxuICogSW1wbGVtZW50cyBoYW5kbGVycyBmb3IgQVBJIGtleSBtYW5hZ2VtZW50IG9wZXJhdGlvbnMuXHJcbiAqXHJcbiAqIFJlbGF0ZWQgZmlsZXM6XHJcbiAqIC0gc2VydmljZXMvQXBpS2V5U2VydmljZS5qczogQVBJIGtleSBzdG9yYWdlIGFuZCB2YWxpZGF0aW9uXHJcbiAqIC0gaXBjL2hhbmRsZXJzLmpzOiBIYW5kbGVyIHJlZ2lzdHJhdGlvblxyXG4gKiAtIHByZWxvYWQuanM6IEFQSSBleHBvc3VyZSB0byByZW5kZXJlclxyXG4gKi9cclxuXHJcbmNvbnN0IHsgaXBjTWFpbiB9ID0gcmVxdWlyZSgnZWxlY3Ryb24nKTtcclxuY29uc3QgYXBpS2V5U2VydmljZSA9IHJlcXVpcmUoJy4uLy4uLy4uL3NlcnZpY2VzL0FwaUtleVNlcnZpY2UnKTtcclxuY29uc3QgeyBJUENDaGFubmVscyB9ID0gcmVxdWlyZSgnLi4vLi4vdHlwZXMnKTtcclxuXHJcbi8qKlxyXG4gKiBVcGRhdGUgZW52aXJvbm1lbnQgdmFyaWFibGVzIHdpdGggbGF0ZXN0IEFQSSBrZXlzXHJcbiAqIFRoaXMgZW5zdXJlcyBjb252ZXJ0ZXJzIGhhdmUgYWNjZXNzIHRvIHRoZSBsYXRlc3QgQVBJIGtleXNcclxuICovXHJcbmZ1bmN0aW9uIHVwZGF0ZUFwaUtleUVudmlyb25tZW50KHByb3ZpZGVyLCBrZXkpIHtcclxuICB0cnkge1xyXG4gICAgLy8gTWFwIHByb3ZpZGVyIHRvIGVudmlyb25tZW50IHZhcmlhYmxlIG5hbWVcclxuICAgIGNvbnN0IGVudk1hcCA9IHtcclxuICAgICAgJ21pc3RyYWwnOiAnTUlTVFJBTF9BUElfS0VZJyxcclxuICAgICAgJ2RlZXBncmFtJzogJ0RFRVBHUkFNX0FQSV9LRVknLFxyXG4gICAgICAnb3BlbmFpJzogJ09QRU5BSV9BUElfS0VZJ1xyXG4gICAgfTtcclxuXHJcbiAgICBjb25zdCBlbnZWYXIgPSBlbnZNYXBbcHJvdmlkZXJdO1xyXG4gICAgaWYgKCFlbnZWYXIpIHJldHVybjtcclxuXHJcbiAgICAvLyBVcGRhdGUgZW52aXJvbm1lbnQgdmFyaWFibGVcclxuICAgIGlmIChrZXkpIHtcclxuICAgICAgcHJvY2Vzcy5lbnZbZW52VmFyXSA9IGtleTtcclxuICAgICAgY29uc29sZS5sb2coYOKchSBVcGRhdGVkICR7ZW52VmFyfSBlbnZpcm9ubWVudCB2YXJpYWJsZWApO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgZGVsZXRlIHByb2Nlc3MuZW52W2VudlZhcl07XHJcbiAgICAgIGNvbnNvbGUubG9nKGDinYwgUmVtb3ZlZCAke2VudlZhcn0gZW52aXJvbm1lbnQgdmFyaWFibGVgKTtcclxuICAgIH1cclxuICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgY29uc29sZS5lcnJvcihgRXJyb3IgdXBkYXRpbmcgQVBJIGtleSBlbnZpcm9ubWVudCBmb3IgJHtwcm92aWRlcn06YCwgZXJyb3IpO1xyXG4gIH1cclxufVxyXG5cclxuLyoqXHJcbiAqIFJlZ2lzdGVyIGFsbCBBUEkga2V5IHJlbGF0ZWQgSVBDIGhhbmRsZXJzXHJcbiAqL1xyXG5mdW5jdGlvbiByZWdpc3RlckFwaUtleUhhbmRsZXJzKCkge1xyXG4gIC8vIFNhdmUgQVBJIGtleVxyXG4gIGlwY01haW4uaGFuZGxlKCdjb2RleDphcGlrZXk6c2F2ZScsIGFzeW5jIChldmVudCwgeyBrZXksIHByb3ZpZGVyID0gJ29wZW5haScgfSkgPT4ge1xyXG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgYXBpS2V5U2VydmljZS5zYXZlQXBpS2V5KGtleSwgcHJvdmlkZXIpO1xyXG5cclxuICAgIC8vIFVwZGF0ZSBlbnZpcm9ubWVudCB2YXJpYWJsZSB3aXRoIHRoZSBuZXcga2V5XHJcbiAgICBpZiAocmVzdWx0LnN1Y2Nlc3MpIHtcclxuICAgICAgdXBkYXRlQXBpS2V5RW52aXJvbm1lbnQocHJvdmlkZXIsIGtleSk7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIHJlc3VsdDtcclxuICB9KTtcclxuXHJcbiAgLy8gQ2hlY2sgaWYgQVBJIGtleSBleGlzdHNcclxuICBpcGNNYWluLmhhbmRsZSgnY29kZXg6YXBpa2V5OmV4aXN0cycsIGFzeW5jIChldmVudCwgeyBwcm92aWRlciA9ICdvcGVuYWknIH0pID0+IHtcclxuICAgIHJldHVybiB7IGV4aXN0czogYXBpS2V5U2VydmljZS5oYXNBcGlLZXkocHJvdmlkZXIpIH07XHJcbiAgfSk7XHJcblxyXG4gIC8vIERlbGV0ZSBBUEkga2V5XHJcbiAgaXBjTWFpbi5oYW5kbGUoJ2NvZGV4OmFwaWtleTpkZWxldGUnLCBhc3luYyAoZXZlbnQsIHsgcHJvdmlkZXIgPSAnb3BlbmFpJyB9KSA9PiB7XHJcbiAgICBjb25zdCByZXN1bHQgPSBhcGlLZXlTZXJ2aWNlLmRlbGV0ZUFwaUtleShwcm92aWRlcik7XHJcblxyXG4gICAgLy8gUmVtb3ZlIGVudmlyb25tZW50IHZhcmlhYmxlIHdoZW4ga2V5IGlzIGRlbGV0ZWRcclxuICAgIGlmIChyZXN1bHQuc3VjY2Vzcykge1xyXG4gICAgICB1cGRhdGVBcGlLZXlFbnZpcm9ubWVudChwcm92aWRlciwgbnVsbCk7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIHJlc3VsdDtcclxuICB9KTtcclxuXHJcbiAgLy8gVmFsaWRhdGUgQVBJIGtleVxyXG4gIGlwY01haW4uaGFuZGxlKCdjb2RleDphcGlrZXk6dmFsaWRhdGUnLCBhc3luYyAoZXZlbnQsIHsga2V5LCBwcm92aWRlciA9ICdvcGVuYWknIH0pID0+IHtcclxuICAgIHJldHVybiBhd2FpdCBhcGlLZXlTZXJ2aWNlLnZhbGlkYXRlQXBpS2V5KGtleSwgcHJvdmlkZXIpO1xyXG4gIH0pO1xyXG5cclxuICAvLyBHZXQgQVBJIGtleSBmb3IgaW50ZXJuYWwgdXNlIChvbmx5IGF2YWlsYWJsZSB0byBtYWluIHByb2Nlc3MpXHJcbiAgaXBjTWFpbi5oYW5kbGUoJ2NvZGV4OmFwaWtleTpnZXQtZm9yLXNlcnZpY2UnLCBhc3luYyAoZXZlbnQsIHsgcHJvdmlkZXIgPSAnb3BlbmFpJyB9KSA9PiB7XHJcbiAgICAvLyBTZWN1cml0eSBjaGVjazogb25seSBhbGxvdyBtYWluIHByb2Nlc3MgdG8gYWNjZXNzIHRoaXNcclxuICAgIGNvbnN0IHdlYkNvbnRlbnRzID0gZXZlbnQuc2VuZGVyO1xyXG4gICAgaWYgKHdlYkNvbnRlbnRzLmdldFR5cGUoKSAhPT0gJ2Jyb3dzZXJXaW5kb3cnKSB7XHJcbiAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlLCBlcnJvcjogJ1VuYXV0aG9yaXplZCBhY2Nlc3MnIH07XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3Qga2V5ID0gYXBpS2V5U2VydmljZS5nZXRBcGlLZXkocHJvdmlkZXIpO1xyXG4gICAgcmV0dXJuIHsgc3VjY2VzczogISFrZXksIGtleSB9O1xyXG4gIH0pO1xyXG5cclxuICBjb25zb2xlLmxvZygnQVBJIEtleSBJUEMgaGFuZGxlcnMgcmVnaXN0ZXJlZCcpO1xyXG59XHJcblxyXG4vKipcclxuICogQ2xlYW4gdXAgYW55IHJlc291cmNlcyB3aGVuIHRoZSBhcHAgaXMgc2h1dHRpbmcgZG93blxyXG4gKi9cclxuYXN5bmMgZnVuY3Rpb24gY2xlYW51cEFwaUtleUhhbmRsZXJzKCkge1xyXG4gIC8vIE5vIGNsZWFudXAgbmVlZGVkIGZvciBBUEkga2V5IGhhbmRsZXJzXHJcbn1cclxuXHJcbm1vZHVsZS5leHBvcnRzID0ge1xyXG4gIHJlZ2lzdGVyQXBpS2V5SGFuZGxlcnMsXHJcbiAgY2xlYW51cEFwaUtleUhhbmRsZXJzXHJcbn07XHJcbiJdLCJtYXBwaW5ncyI6Ijs7QUFBQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUEsTUFBTTtFQUFFQTtBQUFRLENBQUMsR0FBR0MsT0FBTyxDQUFDLFVBQVUsQ0FBQztBQUN2QyxNQUFNQyxhQUFhLEdBQUdELE9BQU8sQ0FBQyxpQ0FBaUMsQ0FBQztBQUNoRSxNQUFNO0VBQUVFO0FBQVksQ0FBQyxHQUFHRixPQUFPLENBQUMsYUFBYSxDQUFDOztBQUU5QztBQUNBO0FBQ0E7QUFDQTtBQUNBLFNBQVNHLHVCQUF1QkEsQ0FBQ0MsUUFBUSxFQUFFQyxHQUFHLEVBQUU7RUFDOUMsSUFBSTtJQUNGO0lBQ0EsTUFBTUMsTUFBTSxHQUFHO01BQ2IsU0FBUyxFQUFFLGlCQUFpQjtNQUM1QixVQUFVLEVBQUUsa0JBQWtCO01BQzlCLFFBQVEsRUFBRTtJQUNaLENBQUM7SUFFRCxNQUFNQyxNQUFNLEdBQUdELE1BQU0sQ0FBQ0YsUUFBUSxDQUFDO0lBQy9CLElBQUksQ0FBQ0csTUFBTSxFQUFFOztJQUViO0lBQ0EsSUFBSUYsR0FBRyxFQUFFO01BQ1BHLE9BQU8sQ0FBQ0MsR0FBRyxDQUFDRixNQUFNLENBQUMsR0FBR0YsR0FBRztNQUN6QkssT0FBTyxDQUFDQyxHQUFHLENBQUMsYUFBYUosTUFBTSx1QkFBdUIsQ0FBQztJQUN6RCxDQUFDLE1BQU07TUFDTCxPQUFPQyxPQUFPLENBQUNDLEdB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